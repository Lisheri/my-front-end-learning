---
title: Vueæ¨¡æ¿ç¼–è¯‘åŸç†-æ¨¡æ¿ç¼–è¯‘çš„å…¥å£
date: 2022-08-23
tags:
    - vue
categories:
    - Vueæºç 
---

# æ¨¡æ¿ç¼–è¯‘çš„å…¥å£

> ä¹‹å‰æ‰¾æ¨¡æ¿çš„è¿‡ç¨‹ä¸­, åœ¨Vueçš„å…¥å£æ–‡ä»¶ä¸­, çœ‹åˆ°è¿‡æŠŠtemplateè½¬æ¢ä¸ºrenderå‡½æ•°çš„ä½ç½®
>
> ç›´æ¥æ‰¾åˆ°entry-runtime-with-compiler.js
> 
> åœ¨å­˜åœ¨templateçš„æƒ…å†µä¸‹, é€šè¿‡[compileToFunctions](/blogs/vue-resource/templateCompile/2.html#compiletofunctions)è½¬æ¢template, è¿”å›äº†å¦‚ä¸‹ä¸¤ä¸ªå±æ€§
>   + `render` å‡½æ•°
>   + ä»¥åŠ`staticRendersFns`, è¿™æ˜¯ä¸€ä¸ªæ•°ç»„, åé¢å†ç»†ğŸ”
> 
> ç„¶åå°†ç”Ÿæˆçš„renderå’ŒstaticRenderFnsè®°å½•åˆ°optionså¯¹åº”çš„å±æ€§ä¸­

```ts
// * é€šè¿‡compileToFunctionsç¼–è¯‘å‡½æ•°æ‹¿åˆ°ä¸€ä¸ªrenderå‡½æ•°å’Œé™æ€staticRenderFnså‡½æ•°
const { render, staticRenderFns } = compileToFunctions(template, {
  outputSourceRange: process.env.NODE_ENV !== 'production',
  shouldDecodeNewlines,
  shouldDecodeNewlinesForHref,
  delimiters: options.delimiters,
  comments: options.comments
}, this)
```

## compileToFunctions

> compileToFunctionsåœ¨`web/compile/index`ä¸­å®šä¹‰
> 
> ä¸createElementç±»ä¼¼, ä»–ä¹Ÿæ˜¯ç”±ä¸€ä¸ªå‡½æ•°ç”Ÿæˆçš„, è¿™ä¸ªå‡½æ•°æ˜¯ `createCompiler` 
> 
> è°ƒç”¨ createCompileræ—¶, ä¼ å…¥äº†å‚æ•° [baseOptions](/blogs/vue-resource/templateCompile/2.html#baseoptions)é€‰é¡¹, è¿™ä¸ªæ˜¯å’Œwebå¹³å°ç›¸å…³çš„é€‰é¡¹
> 
> [createCompiler](/blogs/vue-resource/templateCompile/2.html#createcompiler)å‡½æ•°åœ¨src/compiler/indexä¸­å®šä¹‰

## baseOptions

> expectHTMLè¿™ä¸ªè¡¨ç¤ºé€‰é¡¹æœŸæœ›çš„æ˜¯HTMLä¸­çš„å†…å®¹, æ’å®šä¸ºtrue
> 
> ç„¶åæ˜¯æ¨¡å—å’ŒæŒ‡ä»¤
> 
> ç„¶åæ˜¯æ˜¯å¦ä¸ºPreæ ‡ç­¾(`isPreTag`), ä»¥åŠæ˜¯å¦æ˜¯ä¸€å…ƒæ ‡ç­¾(`isUnaryTag`)(ä¹Ÿå°±æ˜¯è‡ªé—­å’Œæ ‡ç­¾, `<img />`è¿™ç§)
> 
> ç„¶åæ˜¯æ˜¯å¦ä¸ºHTMLä¿ç•™æ ‡ç­¾(`isReservedTag`)ç­‰
> 
> æ¨¡å—å±æ€§([modules](/blogs/vue-resource/templateCompile/2.html#modules))å°±åœ¨å½“å‰ç›®å½•ä¸‹çš„modules/indexä¸­
> 
> æŒ‡ä»¤([directives](/blogs/vue-resource/templateCompile/2.html#directives))ä¹Ÿåœ¨å½“å‰ç›®å½•çš„directives/indexä¸­


```ts
import {
  isPreTag,
  mustUseProp,
  isReservedTag,
  getTagNamespace
} from '../util/index'

import modules from './modules/index'
import directives from './directives/index'
import { genStaticKeys } from 'shared/util'
import { isUnaryTag, canBeLeftOpenTag } from './util'

export const baseOptions: CompilerOptions = {
  expectHTML: true,
  modules,
  directives,
  isPreTag,
  isUnaryTag,
  mustUseProp,
  canBeLeftOpenTag,
  isReservedTag,
  getTagNamespace,
  staticKeys: genStaticKeys(modules)
}
```

## modules

> å¯ä»¥çœ‹åˆ°æ¨¡å—ä¸»è¦ç”¨äºå¤„ç†ç±»æ ·å¼, è¡Œå†…æ ·å¼ä»¥åŠ å’Œv-ifä¸€èµ·ä½¿ç”¨çš„v-modelæŒ‡ä»¤(è¿™é‡Œæ˜¯å’Œv-ifä¸€èµ·ä½¿ç”¨çš„v-model, [model](/blogs/vue-resource/templateCompile/2.html#model)çš„æ³¨é‡Šä¸­æœ‰)

```ts
import klass from './class'
import style from './style'
import model from './model'

export default [
  klass,
  style,
  model
]
```

## model

> è¿™æ®µæ³¨é‡Šå†™çš„å¾ˆæ¸…æ¥š, è¿™ä¸ªmodelä¸»è¦æ˜¯å¤„ç†ä¸v-ifä¸€èµ·å‡ºç°çš„v-model

```ts
/**
 * Expand input[v-model] with dynamic type bindings into v-if-else chains
 * Turn this:
 *   <input v-model="data[type]" :type="type">
 * into this:
 *   <input v-if="type === 'checkbox'" type="checkbox" v-model="data[type]">
 *   <input v-else-if="type === 'radio'" type="radio" v-model="data[type]">
 *   <input v-else :type="type" v-model="data[type]">
 */
```

### directives

> ä¸»è¦å¤„ç†3ä¸ªæŒ‡ä»¤, ä¸€ä¸ªæ˜¯v-model, ä¸€ä¸ªv-text, ä»¥åŠv-html
> 
> æ³¨æ„, è¿™é‡Œå¤„ç†çš„éƒ½æ˜¯æ¨¡æ¿ä¸­çš„æŒ‡ä»¤, éƒ½æ˜¯å¯¹ASTè¿›è¡Œå¤„ç†çš„

```ts
import model from './model'
import text from './text'
import html from './html'

export default {
  model,
  text,
  html
}
```

## createCompiler

> createCompilerè¿™ä¸ªå‡½æ•°, åˆæ˜¯é€šè¿‡ä¸€ä¸ªå‡½æ•°è¿”å›çš„
> 
> å®ƒè°ƒç”¨äº† createCompilerCreator, ä¼ å…¥äº†ä¸€ä¸ª baseCompile
> 
> baseCompile æ˜¯ä¸€ä¸ªæ ¸å¿ƒçš„å‡½æ•°, é‡Œé¢åšäº†ä¸‰ä»¶äº‹
>   + æŠŠæ¨¡æ¿è½¬æ¢æˆ ast æŠ½è±¡è¯­æ³•æ ‘
>   + ä¼˜åŒ–æŠ½è±¡è¯­æ³•æ ‘
>   + æŠŠæŠ½è±¡è¯­æ³•æ ‘ç”Ÿæˆå­—ç¬¦ä¸²å½¢å¼çš„jsä»£ç 
> 
> è¿™é‡Œçš„baseCompile, æ¥å—æ¨¡æ¿(template)å’Œé€‰é¡¹(options)ä¸¤ä¸ªå‚æ•°, ç¨åé‡ç‚¹è§£æè¿™ä¸ªå‡½æ•°
> 
> æ¥ç€è¿›å…¥ [createCompilerCreator](/blogs/vue-resource/templateCompile/2.html#createcompilercreator)

```ts
// `createCompilerCreator` allows creating compilers that use alternative
// parser/optimizer/codegen, e.g the SSR optimizing compiler.
// Here we just export a default compiler using the default parts.
export const createCompiler = createCompilerCreator(function baseCompile (
  template: string,
  options: CompilerOptions
): CompiledResult {
  const ast = parse(template.trim(), options)
  if (options.optimize !== false) {
    optimize(ast, options)
  }
  const code = generate(ast, options)
  return {
    ast,
    render: code.render,
    staticRenderFns: code.staticRenderFns
  }
})
```

## createCompilerCreator

> åœ¨ `createCompiler`å‡½æ•°ä¸­å®šä¹‰äº†ä¸€ä¸ª`compile`å‡½æ•°
> 
> compileå‡½æ•°ç”¨äºæ¥æ”¶`æ¨¡æ¿`å’Œç”¨æˆ·ä¼ å…¥çš„`é€‰é¡¹`
> 
> åœ¨compileè¿™ä¸ªå‡½æ•°å†…éƒ¨, ä¼šæŠŠ`createCompiler`è¿™ä¸ªå‡½æ•°ä¸­ä¼šæŠŠå’Œå¹³å°ç›¸å…³çš„é€‰é¡¹å‚æ•°(`baseOptions`)ä»¥åŠç”¨æˆ·ä¼ å…¥çš„é€‰é¡¹å‚æ•°(`options`)è¿›è¡Œåˆå¹¶
> 
> ç„¶åå†è°ƒç”¨`baseCompile`, å°†åˆå¹¶åçš„é€‰é¡¹, ä¼ é€’è¿›å»
> 
> è¿™æ˜¯é€šè¿‡å‡½æ•°è¿”å›å‡½æ•°çš„ç›®çš„, å°±æ˜¯ç”¨äºå°†å’Œå¹³å°ç›¸å…³çš„å‚æ•°ä»¥åŠç”¨æˆ·ä¼ å…¥çš„å‚æ•°å‡†å¤‡å¥½, æœ€åè°ƒç”¨`baseCompile`å¼€å§‹å»ç¼–è¯‘æ¨¡æ¿
> 
> ä¹Ÿæ˜¯åœ¨å…¶è¿”å›çš„ `createCompiler`å‡½æ•°ä¸­, è¿”å›çš„ä¸¤ä¸ªå‡½æ•°, `compile`å’Œ`compileToFunctions`
>   + å…¶ä¸­ `compileToFunctions`è¿™ä¸ªå‡½æ•°, åˆæ˜¯é€šè¿‡ä¸€ä¸ªå‡½æ•°`createCompileToFunctionFn`åˆ›å»ºçš„
>   + è¿™ä¸ªå‡½æ•°å°±æ˜¯æ¨¡æ¿ç¼–è¯‘çš„å…¥å£, å°‘åç»§ç»­åˆ†æè¿™ä¸ªå‡½æ•°åšäº†ä»€ä¹ˆ
> 
> æ•´ä¸ªè¿‡ç¨‹æœ‰ç‚¹ç»•, åé¢[æ€»ç»“](/blogs/vue-resource/templateCompile/2.html#æ€»ç»“)ä¸€ä¸‹

```ts
export function createCompilerCreator (baseCompile: Function): Function {
  return function createCompiler (baseOptions: CompilerOptions) {
    function compile (
      template: string,
      options?: CompilerOptions
    ): CompiledResult {
      const finalOptions = Object.create(baseOptions)
      const errors = []
      const tips = []

      let warn = (msg, range, tip) => {
        (tip ? tips : errors).push(msg)
      }

      if (options) {
        if (process.env.NODE_ENV !== 'production' && options.outputSourceRange) {
          // $flow-disable-line
          const leadingSpaceLength = template.match(/^\s*/)[0].length

          warn = (msg, range, tip) => {
            const data: WarningMessage = { msg }
            if (range) {
              if (range.start != null) {
                data.start = range.start + leadingSpaceLength
              }
              if (range.end != null) {
                data.end = range.end + leadingSpaceLength
              }
            }
            (tip ? tips : errors).push(data)
          }
        }
        // merge custom modules
        if (options.modules) {
          finalOptions.modules =
            (baseOptions.modules || []).concat(options.modules)
        }
        // merge custom directives
        if (options.directives) {
          finalOptions.directives = extend(
            Object.create(baseOptions.directives || null),
            options.directives
          )
        }
        // copy other options
        for (const key in options) {
          if (key !== 'modules' && key !== 'directives') {
            finalOptions[key] = options[key]
          }
        }
      }

      finalOptions.warn = warn

      const compiled = baseCompile(template.trim(), finalOptions)
      if (process.env.NODE_ENV !== 'production') {
        detectErrors(compiled.ast, warn)
      }
      compiled.errors = errors
      compiled.tips = tips
      return compiled
    }

    return {
      compile,
      compileToFunctions: createCompileToFunctionFn(compile)
    }
  }
}
```

## æ€»ç»“

1. åœ¨å®Œæ•´ç‰ˆçš„Vueå…¥å£ä¸­, è°ƒç”¨äº†`compileToFUnctions(template, {}, this)`
  1. è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å°†æ¨¡æ¿ç¼–è¯‘ä¸ºrenderå‡½æ•°
2. è¿™ä¸ªå‡½æ•°æ˜¯ç”±`createCompiler(baseOptions)`ç”Ÿæˆçš„
  + `createCompiler`æ¥æ”¶å’Œå¹³å°ç›¸å…³çš„é€‰é¡¹å‚æ•°
  + åœ¨`createCompiler`å‡½æ•°ä¸­
      - å®šä¹‰äº†compile(template, options)å‡½æ•°, ä»–æ¥æ”¶ä¸¤ä¸ªå‚æ•°, åˆ†åˆ«æ˜¯æ¨¡æ¿å’Œç”¨æˆ·ä¼ å…¥çš„é€‰é¡¹
      - compileå‡½æ•°ä¸­, é¦–å…ˆä¼šå°†å¹³å°ç›¸å…³çš„é€‰é¡¹å’Œç”¨æˆ·ä¼ å…¥çš„é€‰é¡¹è¿›è¡Œåˆå¹¶, ç„¶åè°ƒç”¨baseCompile, æŠŠåˆå¹¶åçš„é€‰é¡¹ä¼ å…¥
      - createCompileræœ€åè¿˜è¦ç”Ÿæˆ compileToFunctions å‡½æ•°
      - compileToFunctionså‡½æ•°å°±æ˜¯ç¼–è¯‘çš„å…¥å£å‡½æ•°, ä»–åˆæ˜¯é€šè¿‡ä¸€ä¸ªå‡½æ•°è¿”å›çš„
      - è¿™ä¸ªå‡½æ•°æ˜¯`createCompileToFunctionFn`, compileToFunctionsçš„å®šä¹‰, å°±åœ¨è¿™ä¸ªå‡½æ•°ä¸­
> åˆ°æ­¤, [å…¥å£å‡½æ•°](/blogs/vue-resource/templateCompile/3.html)å°±æ‰¾åˆ°äº†
1. è€Œ`createCompiler`åˆæ˜¯é€šè¿‡è°ƒç”¨`createCompilerCreator(function baseCompile(){})`ç”Ÿæˆ
  + createCompilerCreator é€šè¿‡æ¥æ”¶`baseCompile`å‡½æ•°ä½œä¸ºå‚æ•°
  + baseCompile è¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°, åˆ†åˆ«æ˜¯æ¨¡æ¿templateå’Œåˆå¹¶åçš„é€‰é¡¹(options)
  + baseCompileä¸»è¦åšä¸‰ä»¶äº‹:
      - å°†æ¨¡æ¿è§£æä¸ºASTæŠ½è±¡è¯­æ³•æ ‘
      - ä¼˜åŒ–æŠ½è±¡è¯­æ³•æ ‘
      - å°†ä¼˜åŒ–åçš„æŠ½è±¡è¯­æ³•æ•°è½¬æ¢ä¸ºjså½¢å¼çš„å­—ç¬¦ä¸²ä»£ç 
  + createCompilerCreatoræœ€åè¿”å›`createCompiler`

![createCompiler](../images/createCompiler.png)

