---
title: Vue模板编译过程-baseCompile-parse
date: 2022-08-23
tags:
    - vue
categories:
    - Vue源码
---

# baseCompile-parse

> parse函数的作用, 是将模板字符串转换成AST对象, 这个过程比较复杂, Vue内部借鉴了一个开源的库去解析HTML
> 
> 深入研究parse的过程, 所花费的时间过多, 但是收货不大, 这里仅关注主流程

## parse

### 过程

1. parse函数接收两个参数, 一个是模板的字符串, 一个是合并后的选项(这里的模板信息去除了前后的空格)
2. 返回的是解析好的ast对象
3. 首先是解析options中的成员
4. 然后定义了一些辅助的函数和变量
5. 调用parseHTML对模板进行解析(核心)
6. 最后返回了一个root变量, 这个root里面存储的就是解析好的ast对象
7. parse的核心就在于[parseHTML](/blogs/vue-resource/templateCompile/6.html#parsehtml)

### 执行入口

```ts
const ast = parse(template.trim(), options)
```

### 主要源码

```ts
export function parse (
  template: string,
  options: CompilerOptions
): ASTElement | void {
  // 1. 解析options中的成员
  warn = options.warn || baseWarn

  platformIsPreTag = options.isPreTag || no
  platformMustUseProp = options.mustUseProp || no
  platformGetTagNamespace = options.getTagNamespace || no
  const isReservedTag = options.isReservedTag || no
  maybeComponent = (el: ASTElement) => !!el.component || !isReservedTag(el.tag)

  transforms = pluckModuleFunction(options.modules, 'transformNode')
  preTransforms = pluckModuleFunction(options.modules, 'preTransformNode')
  postTransforms = pluckModuleFunction(options.modules, 'postTransformNode')

  delimiters = options.delimiters
  // 定义了一些变量和函数
  const stack = []
  const preserveWhitespace = options.preserveWhitespace !== false
  const whitespaceOption = options.whitespace
  let root
  let currentParent
  let inVPre = false
  let inPre = false
  let warned = false

  function warnOnce (msg, range) {
    ...
  }

  function closeElement (element) {
    ...
  }

  function trimEndingWhitespace (el) {
    ...
  }

  function checkRootConstraints (el) {
    ...
  }

  // 2 调用parseHTML对模板进行解析(核心)
  parseHTML(template, {
    warn,
    expectHTML: options.expectHTML,
    isUnaryTag: options.isUnaryTag,
    canBeLeftOpenTag: options.canBeLeftOpenTag,
    shouldDecodeNewlines: options.shouldDecodeNewlines,
    shouldDecodeNewlinesForHref: options.shouldDecodeNewlinesForHref,
    shouldKeepComment: options.comments,
    outputSourceRange: options.outputSourceRange,
    // 解析过程中的回调函数, 生成AST
    start (tag, attrs, unary, start, end) {
      ...
    },

    end (tag, start, end) {
      ...
    },

    chars (text: string, start: number, end: number) {
      ...
    },
    comment (text: string, start, end) {
      ...
    }
  })
  // 3 最后返回了一个root变量, 这个root里面存储的就是解析好的ast对象
  return root
}
```

## parseHTML

> 这个函数接收模板字符串, 然后是一个对象, 将选项中的一些成员

