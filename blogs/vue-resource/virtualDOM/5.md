---
title: VNodeçš„è½¬æ¢è¿‡ç¨‹-update
date: 2022-08-19
tags:
    - vue
categories:
    - Vueæºç 
---

# update

> åœ¨`vm._render()`æ–¹æ³•ä¸­æœ€ç»ˆè°ƒç”¨äº†`createElement`å»åˆ›å»º`VNode`å¯¹è±¡
>
> æ¥ä¸‹æ¥è¦å°†åˆ›å»ºå¥½çš„ `VNode` å¯¹è±¡ä¼ é€’ç»™`vm._update`æ–¹æ³•
>
> `update`æ–¹æ³•å°±æ˜¯åœ¨è°ƒç”¨`lifecycleMixin`æ—¶å®šä¹‰çš„, è€Œ`lifecycleMixin`å®šä¹‰äº`src/core/instance/lifecycle`ä¸­
>
> è€Œ`lifecycleMixin`æ˜¯åœ¨`core/instance/index`ä¸­å®šä¹‰å®Œ Vue çš„æ„é€ å™¨åè°ƒç”¨çš„

## Vue.prototype._update

> _update æ–¹æ³•çš„ä½œç”¨æ˜¯æŠŠ VNode æ¸²æŸ“æˆçœŸå®çš„ DOM
>
> é¦–æ¬¡æ¸²æŸ“ä¼šè°ƒç”¨, æ•°æ®æ›´æ–°ä¹Ÿä¼šè°ƒç”¨(`renderWatcher`è°ƒç”¨`get`æ—¶, è§¦å‘`updateComponent`)
>
> æœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯è°ƒç”¨äº† `vm.__patch__` æ–¹æ³•

1. é€šè¿‡ vm è§¦å‘`_update`æ–¹æ³•, æ‰€ä»¥è¿™ä¸ª`const vm = this`ä¸­çš„`this`å…¶å®å°±æ˜¯å½“å‰å®ä¾‹å¯¹è±¡
2. å®šä¹‰ `prevEl`, æŒ‡å‘å½“å‰å®ä¾‹çš„`$el`, å¦‚æœæ˜¯äºŒæ¬¡æ¸²æŸ“, è¿™ä¸ªå€¼å°±å­˜å‚¨çš„ä¸Šä¸€æ¬¡çš„`çœŸå®DOMå¯¹è±¡`, å¦‚æœæ˜¯é¦–æ¬¡æ¸²æŸ“, å¯¹äºç»„ä»¶æ¥è¯´è¿™ä¸ªå€¼æ˜¯`undefined`, å¯¹äºå…¥å£æ¥è¯´è¿™ä¸ªå€¼å°±æ˜¯è®¾ç½®çš„æŒ‚è½½ç‚¹
3. å®šä¹‰ `prevVnode`, å°±æ˜¯ä»vueå®ä¾‹ä¸­è·å–`_vnode`, `_vnode`ä¸­è®°è½½çš„æ˜¯ä¹‹å‰æ‰€å¤„ç†çš„vnodeå¯¹è±¡, é¦–æ¬¡æ¸²æŸ“æ—¶è°ƒç”¨`_update`è¯¥å€¼ä¸ºundefined, æ‰€ä»¥è¯¥å€¼ä¸å­˜åœ¨åˆ™ä»£è¡¨é¦–æ¬¡æ¸²æŸ“
4. è°ƒç”¨[setActiveInstance](/blogs/vue-resource/virtualDOM/5.html#setactiveinstance)(vm)è®¾ç½®æ¿€æ´»å®ä¾‹å¹¶ä¸”è¿”å›ä¸€ä¸ªå‡½æ•°, ç”¨äºåœ¨`__patch__`æ‰§è¡Œå®Œæ¯•åé‡ç½®æ¿€æ´»å®ä¾‹ï¼ˆé‡æ–°è®¾ç½®ä¸ºnullï¼‰
5. è®¾ç½®`vm._vnode`ä¸ºå½“å‰`vnode`(æ‰€ä»¥éé¦–æ¬¡æ¸²æŸ“, éƒ½å­˜åœ¨vm._vnode, å°±æ˜¯æ­¤å¤„è®¾ç½®çš„)
6. å¦‚æœä¸å­˜åœ¨`prevVnode`, è¯´æ˜å½“å‰æ˜¯é¦–æ¬¡æ¸²æŸ“
  + é¦–æ¬¡æ¸²æŸ“æ—¶, è°ƒç”¨`vm.__patch__(vm.$el, vnode, hydrating, false)`, vnodeå°±æ˜¯åˆšåˆšåˆ›å»ºçš„vnode
  + åœ¨`__patch__`æ–¹æ³•ä¸­, ä¼šå°†ä¼ å…¥çš„`vm.$el`è½¬æ¢ä¸ºvnode, ç„¶åå’Œæ–°çš„`vnode`è¿›è¡Œæ¯”è¾ƒ
  + ç„¶åå°†æ¯”è¾ƒçš„ç»“æœæ›´æ–°åˆ°çœŸå®DOM, æœ€åå°†å…¶è¿”å›å‡ºæ¥, è®¾ç½®åˆ°`vm.$el`ä¸Š
7. å¦‚æœæ˜¯æ•°æ®æ”¹å˜å, è°ƒç”¨`_update`æ–¹æ³•, æ­¤æ—¶`preVnode`å°±æœ‰å€¼äº†
  + ä¾ç„¶æ˜¯è°ƒç”¨`vm.__patch__`æ–¹æ³•, åªä¸è¿‡æ˜¯ä¼ å…¥ `preVnode`å’Œæ–°çš„`vnode`
  + åœ¨å…¶ä¸­æ¯”è¾ƒä¸¤ä¸ªvnodeçš„å·®å¼‚
  + ç„¶åå°†å·®å¼‚æ›´æ–°åˆ°çœŸå®DOM, ç„¶åå°†æ–°çš„çœŸå®DOMè¿”å›, åœ¨æ›´æ–°åˆ°`vm.$el`ä¸­
8. æ‰§è¡Œ `restoreActiveInstance` å°† `activeInstance` è®¾ç½®ä¸º `null`
9. å§‹ç»ˆä¿æŒ`vm.$el.__vue__`æŒ‡å‘å½“å‰æœ€æ–°çš„vmå®ä¾‹
  + å°†ä»¥å¾€çš„`vm.$el.__vue__`è®¾ç½®ä¸ºnull(å› ä¸ºæ˜¯ç›´æ¥æ‹·è´çš„, ä»–ä¿©æŒ‡å‘åŒä¸€ä¸ª`$el`), æ˜¯å› ä¸ºæ—§çš„`$el`å·²å¼ƒç”¨
  + å°†æ–°çš„`vm.$el.__vue__`è®¾ç½®ä¸ºå½“å‰å®ä¾‹å¯¹è±¡`vm`, æ›´æ–°ä¸€ä¸‹
10. å¤„ç†HOC(é«˜é˜¶ç»„ä»¶)
  + åˆ¤æ–­ `vm.$vnode`å­˜åœ¨ä¸”`vm.$parent`å­˜åœ¨, å¹¶ä¸”`vm.$vnode === vm.$parent._vnode`
  + è¿›å…¥åˆ¤æ–­åå°†`vm.$parent.$el`è®¾ç½®ä¸º`vm.$el`

### HOC

> HOCä¸»è¦é’ˆå¯¹å¦‚ä¸‹æƒ…å†µ
> 
> å…³äºHOCåç»­åœ¨ç»„ä»¶ä¸­ç»†ğŸ”, è¿™é‡Œæš‚æ—¶å…ˆäº†è§£ä¸€ä¸‹
> 
```html
<root>
  <child1></child1>
  <child2>
    <child21></child21>
  </child2>
</root>
```

+ $el: å½“å‰ç»„ä»¶å®ä¾‹å¯¹åº”çš„DOM
+ _vnode: å½“å‰ç»„ä»¶å®ä¾‹å¯¹åº”çš„vnode
+ $parent: å½“å‰ç»„ä»¶çš„çˆ¶ç»„ä»¶å®ä¾‹ `child21.parent = child2`ã€`child1.parent = root`
+ $vnode: å­ç»„ä»¶é¦–å…ˆæ¸²æŸ“å‡ºæ¥çš„å ä½èŠ‚ç‚¹(åœ¨çˆ¶ç»„ä»¶ä¸­çš„å¼•ç”¨èŠ‚ç‚¹, å°±æ˜¯ç»„ä»¶æ ‡ç­¾) æ‰€ä»¥`vnode.parent = $vnode`ï¼ˆæºç  Vue.prototype._render å‡½æ•°èµ‹å€¼ï¼‰ï¼Œ`$vnode` å’Œ `_vnode` çš„ `$el`ç›¸åŒï¼ŒæŒ‡å‘åŒä¸ªDOM

> é«˜é˜¶ç»„ä»¶HOC
> 
> HOC: `(component) => ({ template: <component></components> })`
> 
> æ‰€ä»¥ component è¿™ä¸ªç»„ä»¶ çš„çˆ¶èŠ‚ç‚¹æ˜¯HOCï¼Œ`vm(component).$vnode(åŒ…æ‹¬ç»„ä»¶æ ‡ç­¾) = vm(component).$parent(HOC)._vnode(ä¸åŒ…å«HOCæ ‡ç­¾)`ï¼Œæ‰€ä»¥éœ€è¦æ§åˆ¶`component`çš„`HOCç»„ä»¶`å¼•ç”¨åŒä¸€ä¸ª$el

### æ€»ç»“: 

> updateæ–¹æ³•æ¯”è¾ƒç®€å•, ä¸»è¦å°±æ˜¯åˆ¤æ–­æ˜¯å¦æœ‰`prevVnode`
> 
> å¦‚æœæ²¡æœ‰`prevVnode`å°±æ˜¯é¦–æ¬¡æ¸²æŸ“, è°ƒç”¨`__patch`æ–¹æ³•, ç”¨ `vm.$el`ä¸æ–°çš„`vnode`åšæ¯”è¾ƒ, æ›´æ–°å·®å¼‚åˆ°çœŸå®DOM, ç„¶åè¿”å›çœŸå®DOMå¹¶è®¾ç½®ç»™`vm.$el`
> 
> å¦‚æœæœ‰`prevVnode`, è¯´æ˜æ˜¯æ•°æ®æ›´æ–°åæ¸²æŸ“, è°ƒç”¨`__patch__`æ–¹æ³•, ç”¨`prevVnode`ä¸æ–°çš„`vnode`ä½œæ¯”è¾ƒ, æ›´æ–°å·®å¼‚åˆ°çœŸå®DOM, ç„¶åè¿”å›çœŸå®DOMå¹¶è®¾ç½®ç»™`vm.$el`

### æºç 

```ts
export function lifecycleMixin (Vue: Class<Component>) {
  Vue.prototype._update = function (vnode: VNode, hydrating?: boolean) {
    const vm: Component = this
    const prevEl = vm.$el
    const prevVnode = vm._vnode
    const restoreActiveInstance = setActiveInstance(vm)
    vm._vnode = vnode
    // Vue.prototype.__patch__ is injected in entry points
    // based on the rendering backend used.
    // * é¦–æ¬¡æ¸²æŸ“
    if (!prevVnode) {
      // initial render
      // vueåŸå‹ä¸­çš„ __patch__ æ–¹æ³•æ˜¯åœ¨å…¥å£ä¸­è¢«æ³¨å…¥çš„
      vm.$el = vm.__patch__(vm.$el, vnode, hydrating, false /* removeOnly */)
    } else {
      // updates
      vm.$el = vm.__patch__(prevVnode, vnode)
    }
    // å§‹ç»ˆä¿æŒactiveInstanceå’ŒprevActiveInstanceæ˜¯ä¸€ä¸ªçˆ¶å­å…³ç³» 
    restoreActiveInstance()
    // update __vue__ reference
    if (prevEl) {
      prevEl.__vue__ = null
    }
    if (vm.$el) {
      vm.$el.__vue__ = vm
    }
    // if parent is an HOC, update its $el as well
    if (vm.$vnode && vm.$parent && vm.$vnode === vm.$parent._vnode) {
      vm.$parent.$el = vm.$el
    }
    // updated hook is called by the scheduler to ensure that children are
    // updated in a parent's updated hook.
  }
  ...
}
```

## setActiveInstance

> ä¸»è¦æ˜¯è®¾ç½®æ¿€æ´»å®ä¾‹, ä¸»è¦æ˜¯åœ¨æŒ‚è½½ç»„ä»¶æ—¶, éœ€è¦å°†å½“å‰å®ä¾‹ä½œä¸ºæ‰€æœ‰ç»„ä»¶çš„çˆ¹

```ts
export let activeInstance: any = null
export function setActiveInstance(vm: Component) {
  // * åœ¨ç»„ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ï¼Œä¹‹æ‰€ä»¥å°†vmä½œä¸ºactiveInstanceï¼Œå°±æ˜¯å› ä¸ºç»„ä»¶æ˜¯ä½œä¸ºå½“å‰å®ä¾‹çš„å„¿å­ï¼Œå› æ­¤ï¼Œä¼šæŠŠå½“å‰å®ä¾‹å½“æˆçˆ¶çº§vmå®ä¾‹ï¼Œä¿å­˜ä¸‹æ¥
  const prevActiveInstance = activeInstance
  activeInstance = vm
  return () => {
    activeInstance = prevActiveInstance
  }
}
```
