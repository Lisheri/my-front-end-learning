---
title: VNodeçš„è½¬æ¢è¿‡ç¨‹-patchå‡½æ•°æ‰§è¡Œè¿‡ç¨‹
date: 2022-08-20
tags:
    - vue
categories:
    - Vueæºç 
---

# patch å‡½æ•°æ‰§è¡Œè¿‡ç¨‹

> patch å‡½æ•°åœ¨`createPatchFunction`ä¸­è¿”å›
>
> é¦–å…ˆæ¥åˆ†æ patch å‡½æ•°ä¸­ä¸»è¦çš„æµç¨‹

## patch ä¸»æµç¨‹

1. patch å‡½æ•°é¦–å…ˆæ¥æ”¶äº†ä¸€ä¸ª `oldVnode`å’Œä¸€ä¸ª`vnode`(æ–°çš„ vnode)
2. é¦–å…ˆåˆ¤æ–­äº†æ–°çš„`vnode`æ˜¯å¦å­˜åœ¨, å‚æ•° vnode ä¸ä¸º undefined ä¹Ÿä¸ä¸º null

-   å¦‚æœ`vnode`ä¸å­˜åœ¨, åˆ™ç»§ç»­åˆ¤æ–­ oldVnode æ˜¯å¦å­˜åœ¨
-   å½“ vnode ä¸å­˜åœ¨, ä¸” oldVnode å­˜åœ¨, è¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»è¢«ç§»é™¤, æ­¤æ—¶æ— éœ€å¯¹æ¯”, ç›´æ¥è§¦å‘ olvVnode çš„ Destroy é’©å­å‡½æ•°

3. å†å¾€ä¸‹å®šä¹‰äº†ä¸€ä¸ªå˜é‡ isInitialPatch å’Œä¸€ä¸ªå¸¸é‡ insertedVnodeQueue

-   insertedVnodeQueue æ˜¯æ–°æ’å…¥çš„ vnode èŠ‚ç‚¹çš„é˜Ÿåˆ—, è¿™ä¸ªæ•°ç»„ç”¨äºå­˜å‚¨æ–°æ’å…¥çš„ vnode èŠ‚ç‚¹, ç›®çš„æ˜¯ä»¥åå°† vnode èŠ‚ç‚¹å¯¹åº”çš„ dom å…ƒç´ æŒ‚è½½åˆ° dom æ ‘ä¸Šå, ä¼šè§¦å‘è¿™äº›èŠ‚ç‚¹çš„ insert é’©å­å‡½æ•°
-   ä¸‹é¢çš„ invokeInsertHook, å°±æ˜¯è§¦å‘ä¸Šè¿°é˜Ÿåˆ—ä¸­ vnode èŠ‚ç‚¹çš„ insert é’©å­
-   isInitialPatch åç»­ä¼šç”¨åˆ°, åˆ°æ—¶å€™åœ¨æ¥åˆ†æå…¶ä½œç”¨

4. æ¥ä¸‹æ¥è¿›å…¥åˆ¤æ–­, é¦–å…ˆåˆ¤æ–­ oldVnode æ˜¯å¦å­˜åœ¨, ä¹Ÿå°±æ˜¯`oldVnode`æ˜¯`undefined`æˆ–`null`

-   å½“è°ƒç”¨ç»„ä»¶çš„\$mount æ–¹æ³•ä½†æ˜¯åˆæ²¡æœ‰ä¼ å…¥å‚æ•°æ—¶, æ­¤æ—¶`oldVnode`ä¸ºç©º
-   å¦‚æœ\$mount ä¼ å…¥å‚æ•°å°±æ˜¯è¦æŠŠç»„ä»¶æŒ‚è½½åˆ°é¡µé¢ä¸Šçš„æŸä¸ªä½ç½®
-   å¦‚æœ\$mount æ²¡æœ‰ä¼ é€’å‚æ•°, è¯´æ˜æ­¤æ—¶åªæ˜¯å°†ç»„ä»¶åˆ›å»ºå‡ºæ¥, å¹¶ä¸æŒ‚è½½åˆ°è§†å›¾ä¸Š
-   æ­¤æ—¶ä¼šå°†`isInitialPatch`å˜é‡è®¾ç½®ä¸º true, ä»–æ ‡è®°å½“å‰ VNode åˆ›å»ºå¥½äº†, å¯¹åº”çš„çœŸå® DOM ä¹Ÿåˆ›å»ºå¥½äº†, ä½†ä»…ä»…å­˜å‚¨åœ¨å†…å­˜ä¸­, è€Œä¸å°†å…¶æŒ‚è½½åˆ°é¡µé¢ä¸Š
-   æ¥ä¸‹æ¥é€šè¿‡[createElm](/blogs/vue-resource/virtualDOM/7.html#createelm)(vnode, insertedVnodeQueue)å°†è¿™ä¸ª VNode è½¬æ¢ä¸ºçœŸå® DOM, ä½†æ˜¯åªæ˜¯åˆ›å»ºçœŸå® DOM, å¹¶ä¸æŒ‚è½½åˆ°é¡µé¢ä¸Š
-   ä»ä¸‹é¢çš„`createElm`å°±å¯ä»¥çœ‹å‡ºæ¥, æœ€ç»ˆæ‰§è¡Œinsertçš„æ—¶å€™æ˜¯ç›´æ¥é€€å‡ºçš„, æ²¡æœ‰ä»»ä½•æ“ä½œ, è¯å®äº†ä¸Šé¢æ‰€è¯´çš„, åœ¨æ²¡æœ‰ä¼ å…¥oldVnodeçš„æƒ…å†µä¸‹, æ˜¯ç›´æ¥åˆ›å»ºå‡ºäº†çœŸå®DOMèŠ‚ç‚¹, ä½†åªæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­, è€Œæ²¡æœ‰æŒ‚è½½åˆ°é¡µé¢ä¸Š
5. æ¥ä¸‹æ¥å°±æ˜¯oldVnodeå­˜åœ¨çš„æƒ…å†µ
  + ä¾ç„¶è¦è¿›è¡Œä¸€ç³»åˆ—åˆ¤æ–­ 
  + é¦–å…ˆè·å–oldVnode.nodeTypeè¿™ä¸ªå±æ€§, åˆ¤æ–­è¿™ä¸ªå±æ€§æ˜¯å¦å­˜åœ¨
    - è¿™ä¸ª`nodeType`æ˜¯domå¯¹è±¡çš„å±æ€§, å¦‚æœå­˜åœ¨, è¯´æ˜å½“å‰oldVnodeæ˜¯ä¸€ä¸ªçœŸå®domå…ƒç´ , è€ŒoldVnodeæ˜¯ä¸€ä¸ªçœŸå®dom, è¯´æ˜æ˜¯é¦–æ¬¡æ¸²æŸ“
    - é¦–æ¬¡æ¸²æŸ“å’Œæ•°æ®æ”¹å˜åçš„å¤„ç†ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„
  + ç»§ç»­åšæ¡ä»¶æ§åˆ¶: å¦‚æœå½“å‰oldVnodeä¸æ˜¯ä¸€ä¸ªçœŸå®çš„domå…ƒç´ , å¹¶ä¸”oldVnodeå’Œvnodeæ˜¯ç›¸åŒçš„domå…ƒç´ , ä½¿ç”¨[sameVnode](/blogs/vue-resource/virtualDOM/7.html#samevnode)(oldVnode, vnode)æ–¹æ³•åˆ¤æ–­
    -  å¦‚æœoldVnodeä¸æ˜¯ä¸€ä¸ªçœŸå®èŠ‚ç‚¹, ä¸”æ–°æ—§èŠ‚ç‚¹æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹, åˆ™è§¦å‘`patchVnode(oldVnode, vnode, insertedVnodeQueue, null, null, removeOnly);`
    -  åœ¨`patchVnode`ä¸­æ¯”è¾ƒæ–°æ—§èŠ‚ç‚¹çš„å·®å¼‚, å¹¶ä¸”å°†å·®å¼‚æ›´æ–°åˆ°çœŸå®DOMä¸Š
    -  `patchVnode`ä¸­ä¼šæ‰§è¡Œdiffç®—æ³•, è¿™æ˜¯è¿™ä¸ªæ–¹æ³•çš„æ ¸å¿ƒ, åç»­ä¼šç»§ç»­çœ‹
  + å¦‚æœoldVnodeä¸æ˜¯çœŸå®domå¹¶ä¸”oldVnodeå’Œvnodeä¸æ˜¯ç›¸åŒèŠ‚ç‚¹, æ­¤æ—¶æ‰§è¡Œelse
    - é¦–é€‰åˆ¤æ–­`oldVnode`æ˜¯ä¸€ä¸ªçœŸå®èŠ‚ç‚¹, æ»¡è¶³åˆ¤æ–­, è¯´æ˜æ˜¯é¦–æ¬¡æ¸²æŸ“
      + å‰é¢ä¸¤ä¸ªåˆ¤æ–­éƒ½æ˜¯å’ŒSSRç›¸å…³çš„å†…å®¹, è¿™é‡Œæš‚ä¸è¯´æ˜
      + æ‰€ä»¥åˆå§‹åŒ–æ¸²æŸ“æ—¶, æœ€æ ¸å¿ƒçš„å°±ä¸€å¥è¯, é‚£å°±æ˜¯å°†`oldValue`è½¬æ¢æˆä¸€ä¸ª`vnode`èŠ‚ç‚¹, åªæœ‰ä¸€å¥è¯: `oldVnode = emptyNodeAt(oldVnode)`ã€‚ä¸»è¦å°±æ˜¯è°ƒç”¨[emptyNodeAt](/blogs/vue-resource/virtualDOM/7.html#emptynodeat)(oldVnode)å°†oldVnodeè½¬æ¢æˆä¸€ä¸ªVnodeèŠ‚ç‚¹
      + é¦–æ¬¡æ¸²æŸ“æ—¶, å°†oldVnodeçš„çœŸå®domå¯¹è±¡è½¬æ¢æˆäº†ä¸€ä¸ªVNodeå¯¹è±¡å­˜å‚¨åˆ°oldVnodeä¸­, å¹¶å°†åŸæœ¬çš„çœŸå®domå­˜å‚¨åˆ°äº†VNodeçš„elmä¸­
    - æ¥ä¸‹æ¥ä¼šå°†`oldVnode.elm`è·å–å›æ¥, å¹¶å†²æ–°ç»™ä¸€ä¸ªå…ƒç´ å«åš`oldElm`, è·å–ä»–çš„æ ¸å¿ƒç›®çš„æ˜¯è¦å»æ‰¾è¿™ä¸ªdomå…ƒç´ çš„çˆ¶å…ƒç´ 
    - æ¥ä¸‹æ¥é€šè¿‡`const parentElm = nodeOps.parentNode(oldElm)`å»æ‰¾åˆ°ä¸Šé¢`oldElm`çš„çˆ¶å…ƒç´ 
      + æ‰¾çˆ¶å…ƒç´ çš„ç›®çš„æ˜¯åé¢è¦å°†vnodeè½¬æ¢æˆçœŸå®DOM, å¹¶æŒ‚è½½åˆ°è¿™ä¸ª`parentElm`ä¸‹é¢
    - æ¥ä¸‹æ¥å°±è¦åšæ ¸å¿ƒäº‹æƒ…äº†, è°ƒç”¨`createElm`
      + åˆšåˆšè¯´è¿‡`createElm`çš„æ ¸å¿ƒä½œç”¨å°±æ˜¯å°†VNodeè½¬æ¢æˆçœŸå®èŠ‚ç‚¹, å¹¶æŒ‚è½½åˆ°ä¼ å…¥çš„`parentElm`ä¸Š
      + å¦‚æœä¼ äº†æœ€åä¸€ä¸ªå‚æ•°, ä¹Ÿå°±æ˜¯`nodeOps.nextSibling(oldElm)`, é‚£ä¹ˆä¼šå°†VNodeæ’å…¥åˆ°è¿™äº›å…ƒç´ ä¹‹å‰, å¹¶ä¸”ä¼šå°†vnodeè®°å½•åˆ°insertedVnodeQueueè¿™ä¸ªé˜Ÿåˆ—ä¸­
      + ç¬¬ä¸‰ä¸ªå‚æ•°æœ‰ä¸€ä¸ªåˆ¤æ–­, ä»–çš„ä½œç”¨å…¶å®é€šè¿‡æ³¨é‡Šå†™å‡ºæ¥äº†, æ³¨é‡Šä¸­å‘Šè¯‰æˆ‘ä»¬, å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œä¸€ä¸ª `transition`, å¹¶ä¸”æ‰§è¡Œçš„æ˜¯`leaving`ä»ç•Œé¢ä¸Šæ¶ˆå¤±çš„æ—¶å€™, æ­¤æ—¶ä¼šå°†`parentElm`ä¼ null, å¦‚æœ`parentElm`ä¼ null, ä¸ä¼šå°†æ–°åˆ›å»ºçš„domå…ƒç´ æŒ‚è½½åˆ°ç•Œé¢ä¸Š(å‰é¢è¯´è¿‡), è€Œæ˜¯æš‚å­˜åœ¨å†…å­˜ä¸­
    ```ts
    createElm(
      vnode,
      insertedVnodeQueue,
      // extremely rare edge case: do not insert if old element is in a
      // leaving transition. Only happens when combining transition +
      // keep-alive + HOCs. (#4590)
      oldElm._leaveCb ? null : parentElm,
      nodeOps.nextSibling(oldElm) // * nextSibling è¿”å›oldElmçš„ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
    )
    ```
    - ä¸‹é¢æ˜¯å¤„ç†çˆ¶èŠ‚ç‚¹çš„å ä½ç¬¦é—®é¢˜, ä¸æ ¸å¿ƒé€»è¾‘æ— å…³, æš‚æ—¶å…ˆè·³è¿‡
    - å†å¾€ä¸‹å°±æ˜¯åˆ¤æ–­`parentElm`æ˜¯å¦å­˜åœ¨
      + è¿™ä¸ªparentElmæ˜¯ä»oldVnodeä¸­è·å–çš„
      + æ¥ä¸‹æ¥è¦åšçš„æ˜¯, å°†oldVnodeä»ç•Œé¢ä¸Šç§»é™¤, å¹¶è§¦å‘ç›¸å…³çš„é’©å­å‡½æ•°
      + ä¸»è¦é€šè¿‡[removeVnodes](/blogs/vue-resource/virtualDOM/7.html#removevnodes)([oldVnode], 0, 0)æ¥å®ç°
    - å¦‚æœæ²¡æœ‰`parentElm`è¯´æ˜oldVnodeå¹¶ä¸åœ¨domæ ‘ä¸Šå­˜åœ¨, æ­¤æ—¶åˆ¤æ–­å…¶æ˜¯å¦æœ‰tagå±æ€§
      + å¦‚æœæœ‰ tagå±æ€§, åˆ™è§¦å‘destroyé’©å­å‡½æ•°
    - åˆ°æ­¤, ç§»é™¤è€èŠ‚ç‚¹å°±çœ‹å®Œäº† 
  + å†å¾€ä¸‹æ˜¯è§¦å‘`invokeInsertHook`
    - åœ¨è¿™ä¸ªå‡½æ•°ä¸­è§¦å‘äº†insertedVnodeQueueé˜Ÿåˆ—ä¸­æ‰€æœ‰vnodeçš„é’©å­å‡½æ•°insert
    - æœ€åè¿˜æœ‰ä¸€ä¸ªå˜é‡`isInitialPatch`, ä»–çš„ä½œç”¨æ˜¯è®°å½•å½“å‰VNodeåˆ›å»ºçš„domå…ƒç´ å¹¶æ²¡æœ‰æŒ‚è½½åˆ°é¡µé¢ä¸Š, è€Œæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­
    - å¦‚æœå¯¹åº”çš„domå…ƒç´ , æ²¡æœ‰æŒ‚è½½åˆ°é¡µé¢ä¸Š, æ­¤æ—¶æ˜¯ä¸ä¼šè§¦å‘å¯¹åº”vnodeçš„inserté’©å­çš„, å› ä¸ºæ²¡æœ‰æŒ‚è½½
    - [invokeInsertHook](/blogs/vue-resource/virtualDOM/7.html#invokeinserthook)
  + æœ€åè¿”å›æ–°çš„vnodeçš„çœŸå®domè¿”å›å¹¶è®°å½•åˆ°vm.$elä¸­

> åˆ°æ­¤, æ•´ä¸ªpatchçš„æ ¸å¿ƒè¿‡ç¨‹å°±ç»“æŸäº†
> 
> åœ¨patchå‡½æ•°å†…éƒ¨æœ‰ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°, ä¸€ä¸ªæ˜¯`createElm`, è¿˜æœ‰ä¸€ä¸ªæ˜¯`patchVnode`
> 
> åé¢ç»†ğŸ”
> 
> patchæºç å¤§è‡´å¦‚ä¸‹, å±è”½äº†å ä½èŠ‚ç‚¹ç›¸å…³é€»è¾‘, åŒæ ·åç»­ç»†ğŸ”


```ts
export function createPatchFunction(backend) {
  let i, j
  const cbs = {}
  const { modules, nodeOps } = backend
  ...
  // coreä¸­çš„createPatchFunction(backend), const { modules, nodeOps } = backend
  // coreä¸­æ–¹æ³•å’Œå¹³å°æ— å…³, ä¼ å…¥ä¸¤ä¸ªå‚æ•°å, å¯ä»¥åœ¨ä¸Šé¢çš„å‡½æ•°ä¸­ä½¿ç”¨è¿™ä¸¤ä¸ªå‚æ•°
  return function patch (oldVnode, vnode, hydrating, removeOnly) {
    // æ–°çš„  VNodeä¸å­˜åœ¨
    if (isUndef(vnode)) {
      // è€çš„ VNodeå­˜åœ¨, æ‰§è¡Œ Destroy é’©å­å‡½æ•°
      if (isDef(oldVnode)) invokeDestroyHook(oldVnode)
      return
    }

    let isInitialPatch = false
    // å­˜å‚¨æ–°æ’å…¥èŠ‚ç‚¹çš„ä¸€ä¸ªé˜Ÿåˆ—
    const insertedVnodeQueue = []

    // åˆ¤æ–­oldVnodeæ˜¯å¦å­˜åœ¨
    if (isUndef(oldVnode)) {
      isInitialPatch = true
      // åˆ›å»ºæ–°çš„ vnode
      createElm(vnode, insertedVnodeQueue)
    } else {
      // oldVnodeå­˜åœ¨çš„æƒ…å†µ
      // æ–°çš„å’Œè€çš„VNodeéƒ½å­˜åœ¨, åˆ™åšæ›´æ–°æ“ä½œ
      // isRealElement ä¸ºtrueè¡¨ç¤ºæ˜¯é¦–æ¬¡æ¸²æŸ“çš„æƒ…å†µ
      const isRealElement = isDef(oldVnode.nodeType);
      if (!isRealElement && sameVnode(oldVnode, vnode)) {
        // æ›´æ–°æ“ä½œ, diffç®—æ³•
        patchVnode(oldVnode, vnode, insertedVnodeQueue, null, null, removeOnly);
      } else {
        // æ»¡è¶³ isRealElement, è¯´æ˜æ˜¯é¦–æ¬¡æ¸²æŸ“
        if (isRealElement) {
          // SSRç›¸å…³
          if (oldVnode.nodeType === 1 && oldVnode.hasAttribute(SSR_ATTR)) {
            oldVnode.removeAttribute(SSR_ATTR)
            hydrating = true
          }
          // è¿˜æ˜¯SSRç›¸å…³
          if (isTrue(hydrating)) {
            if (hydrate(oldVnode, vnode, insertedVnodeQueue)) {
              invokeInsertHook(vnode, insertedVnodeQueue, true)
              return oldVnode
            } else if (process.env.NODE_ENV !== 'production') {
              warn(
                'The client-side rendered virtual DOM tree is not matching ' +
                'server-rendered content. This is likely caused by incorrect ' +
                'HTML markup, for example nesting block-level elements inside ' +
                '<p>, or missing <tbody>. Bailing hydration and performing ' +
                'full client-side render.'
              )
            }
          }
          // either not server-rendered, or hydration failed.
          // create an empty node and replace it
          // * æ‰€ä»¥åˆæ¬¡æ¸²æŸ“ï¼Œç›´æ¥èµ°åˆ°è¿™é‡Œ
          // å°†oldVnodeè½¬æ¢æˆå¯¹åº”çš„VNode
          // åœ¨å°†åŸæœ¬çš„oldVnodeè¿™ä¸ªçœŸå®domå¯¹è±¡, æŒ‚è½½åˆ°æ–°çš„VNode.elmä¸Š
          oldVnode = emptyNodeAt(oldVnode)
        }
        // ? å¦‚æœæ–°æ—§èŠ‚ç‚¹ä¸åŒ, é‚£å°±åˆ†æˆä¸‰ä¸ªæ­¥éª¤: â‘ åˆ›å»ºæ–°çš„èŠ‚ç‚¹ â‘¡æ›´æ–°çˆ¶çš„å ä½ç¬¦èŠ‚ç‚¹ â‘¢åˆ é™¤æ—§çš„èŠ‚ç‚¹
        
        // æ¥ä¸‹æ¥ä¼šå°†`oldVnode.elm`è·å–å›æ¥, å¹¶å†²æ–°ç»™ä¸€ä¸ªå…ƒç´ å«åš`oldElm`, è·å–ä»–çš„æ ¸å¿ƒç›®çš„æ˜¯è¦å»æ‰¾è¿™ä¸ªdomå…ƒç´ çš„çˆ¶å…ƒç´ 
        const oldElm = oldVnode.elm
        // æ‰¾åˆ° oldElmçš„çˆ¶å…ƒç´ 
        // æ‰¾çˆ¶å…ƒç´ çš„ç›®çš„æ˜¯åé¢è¦å°†vnodeè½¬æ¢æˆçœŸå®DOM, å¹¶æŒ‚è½½åˆ°è¿™ä¸ª`parentElm`ä¸‹é¢
        const parentElm = nodeOps.parentNode(oldElm)

        // æ¥ä¸‹æ¥å°±æ˜¯æ ¸å¿ƒç›®çš„ä¹‹ä¸€, åˆ›å»ºæ–°èŠ‚ç‚¹
        // create new node
        // ? â‘ åˆ›å»ºæ–°çš„èŠ‚ç‚¹
        // åˆ›å»ºDOMèŠ‚ç‚¹
        createElm(
          vnode,
          insertedVnodeQueue,
          // extremely rare edge case: do not insert if old element is in a
          // leaving transition. Only happens when combining transition +
          // keep-alive + HOCs. (#4590)
          oldElm._leaveCb ? null : parentElm,
          nodeOps.nextSibling(oldElm) // * nextSibling è¿”å›å…¶çˆ¶èŠ‚ç‚¹çš„ childNodes åˆ—è¡¨ä¸­ç´§è·Ÿåœ¨å…¶åé¢çš„èŠ‚ç‚¹, ä¹Ÿå°±æ˜¯ä»–çš„ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
        )

        // update parent placeholder node element, recursively
        // * å ä½èŠ‚ç‚¹ç›¸å…³
        // * è¿™é‡Œçš„ vnode æ˜¯ä¸€ä¸ª æ¸²æŸ“vnode, ä¹Ÿå°±æ˜¯ç»„ä»¶çš„æ ¹ vnode, vnode.parent æ˜¯ä¸€ä¸ªå ä½ç¬¦èŠ‚ç‚¹
        if (isDef(vnode.parent)) {
          ...
        }

        // destroy old node é”€æ¯æ—§çš„èŠ‚ç‚¹
        // åˆ¤æ–­parentElmèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
        if (isDef(parentElm)) {
          removeVnodes([oldVnode], 0, 0)
        } else if (isDef(oldVnode.tag)) {
          invokeDestroyHook(oldVnode)
        }
      }
    }

    // * è¿™é‡Œå°±æ˜¯è°ƒç”¨äº†ä¸€äº›é’©å­å‡½æ•°ï¼Œä¹‹ååœ¨çœ‹
    invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch)
    return vnode.elm
  }
}
```

## createElm

> æ­¤å¤„çš„`createElm`å¾ˆç®€ç•¥, ä¸»è¦è¯´`insert`, å…·ä½“çš„å†…å®¹è¿˜æ˜¯è¦è§[VNodeçš„è½¬æ¢è¿‡ç¨‹-createElm](/blogs/vue-resource/virtualDOM/8.html)
> 
> åœ¨createElmè¿™ä¸ªå‡½æ•°ä¸­, æ¥æ”¶äº†å¾ˆå¤šå‚æ•°, è¿™é‡Œçš„æ ¸å¿ƒå°±æ˜¯è°ƒç”¨`insert`æ–¹æ³•, å°†å½“å‰çš„vnodeæŒ‚è½½åˆ°çˆ¶èŠ‚ç‚¹ä¸‹
> 
> è€Œåœ¨patchå‡½æ•°ä¸­, oldVnodeä¸å­˜åœ¨æ—¶, åªä¼ å…¥äº†ä¸¤ä¸ªå‚æ•°, é‚£å°±æ˜¯`vnode`å’Œ`insertedVnodeQueue`
> 
> ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯`parentElm`, ä¹Ÿå°±æ˜¯å°†å½“å‰Vnodeè½¬æ¢æˆçš„çœŸå®DOMæŒ‚è½½åˆ°çš„çˆ¶èŠ‚ç‚¹çš„ä½ç½®(å› ä¸ºåœ¨oldVnodeä¸å­˜åœ¨æ—¶, è¯´æ˜å½“å‰VNodeåªåˆ›å»ºä¸æŒ‚è½½, æ‰€ä»¥æ²¡æœ‰ä¼ è¿™ä¸ªå‚æ•°)
>   + åœ¨`insert(parentElm, vnode.elm, refElm);`ä¸­ä½¿ç”¨`parentElm`, å°†åˆ›å»ºçš„ `vnode` æŒ‚è½½åˆ° `parentElm` ä¸­æ¥
>   + ä½†æ˜¯ä¸Šé¢è¯´çš„è¿™ç§æƒ…å†µ, æ˜¯åœ¨parentElmæ²¡æœ‰ä¼ å€¼æ—¶è°ƒç”¨insert, é‡ç‚¹è¿˜æ˜¯è¦çœ‹ [insert](/blogs/vue-resource/virtualDOM/7.html#insert)æ–¹æ³•çš„å®ç°
> 

```ts
// * createElmåªæœ‰ä¸€ä¸ªä½œç”¨ï¼Œå°±æ˜¯å°†VNodeæŒ‚è½½åˆ°çœŸå®çš„DOMä¸Š
// * ç»„ä»¶æ›´æ–°æ—¶, åˆ›å»ºæ–°çš„elmä¼ å…¥çš„å‚æ•°æ˜¯ å½“å‰vnode, ç©ºæ•°ç»„[], çˆ¶èŠ‚ç‚¹, å½“å‰èŠ‚ç‚¹æ‰€åœ¨çˆ¶äº²èŠ‚ç‚¹çš„å„¿å­èŠ‚ç‚¹æ•°ç»„ä¸­çš„ä¸‹ä¸€ä¸ª
function createElm(
    vnode,
    insertedVnodeQueue, // * é™¤æ­¤æ¸²æŸ“æ—¶æ‰§è¡ŒcreateElmä¸º[]
    parentElm,
    refElm,
    nested,
    ownerArray,
    index
) {
    ...
    if (isDef(tag)) {
      ...
        /* istanbul ignore if */
        if (__WEEX__) {
            ...
        } else {
            ...
            // * å‚æ•°ä¾æ¬¡ä»£è¡¨ çˆ¶èŠ‚ç‚¹ï¼Œ å½“å‰vnodeå¯¹åº”çš„çœŸå®DOM, å‚è€ƒèŠ‚ç‚¹
            insert(parentElm, vnode.elm, refElm);
        }
        ...
    } else if (isTrue(vnode.isComment)) {
        ...
        insert(parentElm, vnode.elm, refElm);
    } else {
        ...
        insert(parentElm, vnode.elm, refElm);
    }
}
```

## insert

1. é¦–å…ˆåˆ¤æ–­ `parent`æ˜¯å¦æœ‰å®šä¹‰, å¦‚æœæœ‰å®šä¹‰, è¦åšçš„äº‹æƒ…å°±æ˜¯å°†DOMå…ƒç´ æŒ‚è½½åˆ°`parent`ä¸­æ¥
2. å¦‚æœæ²¡æœ‰`parent`, åˆ™ä»€ä¹ˆéƒ½ä¸æ“ä½œ

```ts
function insert (parent, elm, ref) {
  // * æ‰§è¡Œinserté¦–å…ˆè¦çˆ¶èŠ‚ç‚¹å­˜åœ¨
  if (isDef(parent)) {
    if (isDef(ref)) {
      // * å¦‚æœæœ‰å‚è€ƒèŠ‚ç‚¹ï¼Œå¹¶ä¸”å‚è€ƒèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±å°†å½“å‰èŠ‚ç‚¹æ’å…¥åˆ°å‚è€ƒèŠ‚ç‚¹å‰
      if (nodeOps.parentNode(ref) === parent) {
        nodeOps.insertBefore(parent, elm, ref)
      }
    } else {
      // * å¦‚æœæ²¡æœ‰å‚è€ƒèŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥å°†å­èŠ‚ç‚¹æ’å…¥çˆ¶èŠ‚ç‚¹, æ¯”å¦‚è¯´éå†å„¿å­æ—¶çš„å‚è€ƒèŠ‚ç‚¹ï¼Œéƒ½æ˜¯null
      nodeOps.appendChild(parent, elm)
    }
  }
}
```

## sameVnode

> åœ¨snabbdomä¸­ä¹Ÿæœ‰sameVnodeå‡½æ•°, åœ¨å…¶ä¸­åˆ¤æ–­äº†ä¸¤ä¸ªèŠ‚ç‚¹çš„`key`æ˜¯å¦ç›¸åŒ, è¿˜åˆ¤æ–­äº†ä¸¤ä¸ªèŠ‚ç‚¹çš„`sel`ä¹Ÿå°±æ˜¯é€‰æ‹©å™¨æ˜¯å¦ç›¸åŒ, å¦‚æœä¸Šé¢çš„éƒ½ç›¸åŒ, åˆ™è®¤ä¸ºæ˜¯ç›¸åŒèŠ‚ç‚¹
> 
> å¦‚æœæ˜¯ç›¸åŒèŠ‚ç‚¹, æ­¤æ—¶è¦è°ƒç”¨`patchVnode`å»å¯¹æ¯”ä¸¤ä¸ªèŠ‚ç‚¹çš„å·®å¼‚
> 
> ä¸‹é¢æ˜¯Vueä¸­çš„`sameVnode`æ–¹æ³•
> 
> å…¶å®ä¸»è¦çš„æ ¸å¿ƒå°±åœ¨äºåˆ¤æ–­`key`æ˜¯å¦ç›¸åŒ, ç„¶ååˆ¤æ–­`tag`æ˜¯å¦ç›¸åŒ, `tag`ç›¸åŒåè¦ç»§ç»­åˆ¤æ–­ä»–ä»¬æ˜¯å¦åŒæ—¶éƒ½æ˜¯æ³¨é‡ŠèŠ‚ç‚¹(å› ä¸ºæ³¨é‡ŠèŠ‚ç‚¹çš„tagå¯èƒ½å’Œéæ³¨é‡ŠèŠ‚ç‚¹çš„tagä¹Ÿæ˜¯ä¸€æ ·çš„, ä½†å¹¶ä¸æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹)
> 
> ç„¶ååˆ¤æ–­æ˜¯å¦éƒ½æ‹¥æœ‰`data`, ä¸”ä»–ä»¬çš„inputç±»å‹æ˜¯å¦ç›¸åŒ(inputæœ‰å¾ˆå¤šç±»å‹)
> 
> æˆ–è€…ä»–ä»¬éƒ½æ˜¯ä¸€ä¸ªå¼‚æ­¥æ³¨é‡ŠèŠ‚ç‚¹
> 
> æ»¡è¶³ä¸Šè¿°æ¡ä»¶, åˆ™è¯´æ˜æ˜¯ä¸€ä¸ªç›¸åŒèŠ‚ç‚¹

```ts
function sameVnode (a, b) {
  return (
    // * éƒ½æ²¡æœ‰å†™key, å¤§å®¶éƒ½æ˜¯ undefined ä¹Ÿæ˜¯ç›¸ç­‰çš„, è¿™æ˜¯ä¸€ä¸ªå‰ææ¡ä»¶
    a.key === b.key && (
      (
        // * è¿™é‡Œç”¨äºåˆ¤æ–­æ™®é€šèŠ‚ç‚¹, å› æ­¤é¦–å…ˆåˆ¤æ–­ä»–ä»¬çš„ tag æ˜¯å¦ç›¸ç­‰
        a.tag === b.tag &&
        a.isComment === b.isComment && // * æ˜¯å¦åŒæ—¶æ˜¯æ³¨é‡ŠèŠ‚ç‚¹
        isDef(a.data) === isDef(b.data) && // * æ˜¯å¦åŒæ—¶å®šä¹‰äº†data
        sameInputType(a, b) // * æ˜¯å¦æ˜¯ä¸€ä¸ªç›¸åŒçš„inputç±»å‹
      ) || (
        // * isAsyncPlaceholder è¡¨ç¤ºæ˜¯å¼‚æ­¥å ä½ç¬¦èŠ‚ç‚¹
        isTrue(a.isAsyncPlaceholder) &&
        a.asyncFactory === b.asyncFactory &&
        isUndef(b.asyncFactory.error) // * è¡¨ç¤ºæ˜¯ä¸€ä¸ªæ­£ç¡®çš„å¼‚æ­¥æ³¨é‡ŠèŠ‚ç‚¹
      )
    )
  )
}
```

## emptyNodeAt

> è¿™ä¸ªå‡½æ•°ä¸­, åªæœ‰ä¸€å¥è¯, è¿”å›äº†ä¸€ä¸ªVNodeå¯¹è±¡
> 
> ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åœ¨è·å–vnodeå¯¹åº”æ ‡ç­¾çš„åç§°
> 
> åé¢å‡ ä¸ªå‚æ•°éƒ½æ²¡æœ‰ä¼ å€¼, æœ€åä¸€ä¸ªå‚æ•°è¡¨ç¤ºelmå¯¹è±¡, ä¹Ÿå°±æ˜¯å½“å‰çš„domå…ƒç´ , ä¼šå°†å½“å‰çš„domå…ƒç´ è®°å½•åˆ°å½“å‰`vnode.elm`ä¸Š(æ„é€ å™¨ä¸­æ‰§è¡Œ: `this.elm = elm`)

```ts
function emptyNodeAt (elm) {
  // * è¯¥æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„VNodeï¼Œtagå°±æ˜¯ä»¥å‰çš„nodeä¹Ÿå°±æ˜¯çœŸå®DOMçš„tagï¼Œç„¶ådataå’Œchildrenéƒ½æ˜¯ç©ºå€¼ï¼Œæ–‡æœ¬ä¸ºundefinedï¼Œå¯¹åº”çš„çœŸå®DOMå°±æ˜¯è¯¥çœŸå®DOM
  // * è¯´ç™½äº†å°±æ˜¯å°†ä¸€ä¸ªçœŸå®DOMè½¬æ¢ä¸ºVirtual DOM
  return new VNode(nodeOps.tagName(elm).toLowerCase(), {}, [], undefined, elm)
}
```

## removeVnodes

> åœ¨removeVnodesä¸­, éå†vnodes, ä¹Ÿå°±æ˜¯oldVnodes
> 
> æ‰¾åˆ°æ¯ä¸€ä¸ªvnode, åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
> 
> å¦‚æœèŠ‚ç‚¹å­˜åœ¨å¹¶ä¸”æœ‰tagå±æ€§, è¯´æ˜ä»–æ˜¯ä¸€ä¸ªtagæ ‡ç­¾
> 
> å¹¶ä¸”å°†è¿™ä¸ªtagä»domä¸Šç§»é™¤å¹¶è§¦å‘å¯¹åº”çš„removeé’©å­å‡½æ•°`removeAndInvokeRemoveHook(ch)`
> 
> æ¥ç€è§¦å‘vnodeçš„destroyé’©å­å‡½æ•°`invokeDestroyHook(ch)`
> 
> å¦‚æœæ²¡æœ‰tagæ ‡ç­¾, è¯´æ˜æ˜¯ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹, æ­¤æ—¶ç›´æ¥æŠŠæ–‡æœ¬èŠ‚ç‚¹ä»domæ ‘ä¸Šç§»é™¤`removeNode(ch.elm)`

```ts
function removeVnodes (vnodes, startIdx, endIdx) {
  for (; startIdx <= endIdx; ++startIdx) {
    const ch = vnodes[startIdx]
    if (isDef(ch)) {
      if (isDef(ch.tag)) {
        removeAndInvokeRemoveHook(ch)
        invokeDestroyHook(ch)
      } else { // Text node
        removeNode(ch.elm)
      }
    }
  }
}

function removeNode (el) {
  // æ‰¾åˆ°domæ ‘ä¸Šçš„çˆ¶èŠ‚ç‚¹
  const parent = nodeOps.parentNode(el)
  // element may have already been removed due to v-html / v-text
  // åˆ¤æ–­æ˜¯å¦å­˜åœ¨çˆ¶èŠ‚ç‚¹
  if (isDef(parent)) {
    // å¦‚æœå­˜åœ¨çˆ¶èŠ‚ç‚¹, åˆ™è°ƒç”¨domæ–¹æ³•removeChildç§»é™¤çˆ¶èŠ‚ç‚¹ä¸‹çš„å½“å‰èŠ‚ç‚¹å³å¯
    nodeOps.removeChild(parent, el)
  }
}
```

## invokeInsertHook

> å¦‚æœ`initial`æ˜¯true, å¹¶ä¸”vnodeæœ‰parentå±æ€§, æ­¤æ—¶å¹¶ä¸ä¼šè§¦å‘å¯¹åº”vnodeçš„é’©å­å‡½æ•°inserté’©å­
> 
> è€Œæ˜¯æ ‡è®°å½“å‰çš„æ’å…¥æ˜¯ä¸€ä¸ªpending(å»¶è¿Ÿæ’å…¥), å°†å½“å‰é˜Ÿåˆ—è®°å½•åˆ°`vnode.parent.data.pendingInsert`é˜Ÿåˆ—ä¸­
> 
> å°†æ¥å½“è¿™ä¸ªdomå…ƒç´ çœŸçš„æ’å…¥åˆ°é¡µé¢ä¸­ä¹‹å, æ‰ä¼šè§¦å‘è¿™ä¸ªpendingInserté˜Ÿåˆ—ä¸­æ¯ä¸ªvnodeçš„inserté’©å­å‡½æ•°
> 
> å¦‚æœ`initial`ä¸æ˜¯true, è¯´æ˜éœ€è¦æ‰§è¡Œæ’å…¥, ç›´æ¥éå†é˜Ÿåˆ—, æ‰§è¡Œ`queue[i].data.hook.insert(queue[i])`æ–¹æ³•è§¦å‘æ¯ä¸€ä¸ªvnodeçš„inserté’©å­å‡½æ•°

```ts
function invokeInsertHook (vnode, queue, initial) {
  // delay insert hooks for component root nodes, invoke them after the
  // element is really inserted
  if (isTrue(initial) && isDef(vnode.parent)) {
    vnode.parent.data.pendingInsert = queue
  } else {
    for (let i = 0; i < queue.length; ++i) {
      queue[i].data.hook.insert(queue[i])
    }
  }
}
```

## invokeDestroyHook

> ä¸»è¦çœ‹vnode.dataæ˜¯å¦å®šä¹‰, ä¸”vnode.dataä¸­æ˜¯å¦åŒ…å«hookå±æ€§ä»¥åŠhookå±æ€§ä¸­æ˜¯å¦å­˜åœ¨destroyå±æ€§, å¦‚æœå­˜åœ¨, åˆ™ç›´æ¥æ‰§è¡Œdestroyé’©å­
> 
> éå†cbs.destroy, æ‰§è¡Œvnodeå„ä¸ªé˜¶æ®µçš„destroyé’©å­
> 
> å¦‚æœvnode.childrenå­˜åœ¨, åˆ™é€’å½’æ‰§è¡Œå„¿å­èŠ‚ç‚¹çš„é”€æ¯å·¥ä½œ
> 
> ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¥, ç»„ä»¶é”€æ¯æ˜¯`å…ˆçˆ¹åå„¿`çš„

```ts
function invokeDestroyHook (vnode) {
  // * é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œé€’å½’çš„å»é”€æ¯å­ç»„ä»¶
  // * ä¸åœçš„æ‰§è¡Œé”€æ¯å·¥ä½œ
  let i, j
  const data = vnode.data
  if (isDef(data)) {
    if (isDef(i = data.hook) && isDef(i = i.destroy)) i(vnode)
    // * è¿™ä¸ªcbsåŒ…å«äº†ç»„ä»¶çš„æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸå‡½æ•°(åˆå¹¶è¿‡åçš„)
    // * ä»è¿™é‡Œå¼€å§‹æ‰§è¡Œé”€æ¯å·¥ä½œï¼Œä¸€å±‚ä¸€å±‚åˆ°æœ€åº•ä¸‹çš„é”€æ¯å·¥ä½œå®Œæˆäº†ï¼Œæ‰ä¼šé€€å‡ºé€’å½’
    // * å› æ­¤ï¼Œæœ€åº•å±‚çš„destroyæœ€å…ˆå®Œæˆï¼Œé€€å‡ºé€’å½’
    // * æ‰€ä»¥ä½¿ç”¨destroyedè¿™ä¸ªé’©å­å‡½æ•°çš„æ—¶å€™ï¼Œå„¿å­æ¯”çˆ¹å…ˆæ‰§è¡Œã€‚è¶Šé¡¶å±‚è¶Šåæ‰§è¡Œé”€æ¯é’©å­(å¹¶ä¸æ˜¯åæ‰§è¡Œé”€æ¯ï¼Œä»…ä»…åªæ˜¯åæ‰§è¡Œé”€æ¯é’©å­ï¼Œç„¶åæœ€åæ¸…ç©ºï¼Œé”€æ¯å¼€å§‹è¿˜æ˜¯å¾ˆæ—©çš„)
    for (i = 0; i < cbs.destroy.length; ++i) cbs.destroy[i](vnode)
  }
  if (isDef(i = vnode.children)) {
    for (j = 0; j < vnode.children.length; ++j) {
      invokeDestroyHook(vnode.children[j])
    }
  }
}
```

