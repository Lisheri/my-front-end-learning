---
title: vue源码解析-Vue.js的静态成员和实例成员初始化过程(二)
date: 2022-04-21
tags:
    - vue
categories:
    - Vue源码
---

# 从入口开始

入口文件: `src/platforms/web/entry-runtime-with-compiler`

## 同时存在template和render?

通过入口文件源码分析, 来查看下面的代码最终是如何执行的

```js
const vm = new Vue({
  el: "#app",
  template: "<div>hello template</div>",
  render(h) {
    return h('div', 'hello render')
  }
})
```

通过`$mount`的源码阅读, 可以知道, 在存在render的情况下, 会直接使用render函数, 而直接忽略模板信息, 因此渲染到页面中的是 `hello render`

## $mount

```js
// 最终会走$mount将生成的dom挂载到页面上
Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  // * el就是创建vue实例时, 传入的选项, 首先判断是否传递, 传递了则通过query处理el
  // query分好几步 
  // 1. el不是一个字符串直接返回el
  // 2. el是一个string, 则通过document.querySelector找到el对应的dom元素
  // 3. 如果找不到el对应的dom元素, 开发环境报错（找不到el）, 同时创建一个div作为容器返回
  // 4. 如果找到了, 直接返回找到的dom元素赋值给el(此时el已经不在是字符串了, 而是一个dom元素)
  el = el && query(el)

  /* istanbul ignore if */
  // el 不能是 body 或者是 html
  // * 如果el是一个body或者是html文档标签，那么就会抛错，然后直接返回当前vue实例
  // * 如果是body或者html标签，在编译之后就会直接将body或者html标签直接覆盖了，会导致整个html文档缺少必要的模块
  if (el === document.body || el === document.documentElement) {
    process.env.NODE_ENV !== 'production' && warn(
      `Do not mount Vue to <html> or <body> - mount to normal elements instead.`
    )
    // 直接返回当前vue实例
    return this
  }

  // 暂存$options选项
  const options = this.$options
  // * 判断是否定义了render方法
  if (!options.render) {
    // 只做一件事情: 将template转换为render函数
    ...
  }
  // * 这一步$mount主要就是拿到el，然后判断是否存在render函数，如果没有render函数，就把template转换为一个render函数
  // * 也就是说Vue只认识一个render函数，如果说有render函数，那就直接忽略上面所有的步骤，直接走到这一步
  // * 这里的this指向Vue实例
  // mount方法用于渲染dom
  return mount.call(this, el, hydrating)
}
```

通过断点调试可以发现, 执行`$mount`方法的是`vm实例`, 也就是vue实例, 因此`$mount`方法内部的`this`指向vue实例

而在`new Vue`时, 同时设置了`template`和`render`, 只会执行render

### 结论

+ el不能是body或者html, 因为打包后会替换入口节点, 如果是body或者html, 那么body或html被替换, 将会导致页面信息出错, 无法生成一个html页面
+ 如果没有render函数, 会将template转换为render函数
+ 如果存在render方法, 直接调用缓存的mount方法挂载DOM
+ 将断点打到`el = el && query(el)`这一步, 通过观察右侧`call stack`可以发现, Vue._init方法调用的`$mount`, 因此this指向Vue实例
