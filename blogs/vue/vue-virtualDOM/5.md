---
title: Snabbdom源码解析 ———— patch执行过程
date: 2022-02-01
tags:
    - vue
categories:
    - vue基础
---

# patch

patch 函数主要就是将 VNode 渲染成真实 dom

## patch 整体执行过程分析

patch 函数在 init 函数中定义, 这个函数俗称打补丁, 主要对比新旧节点的差异, 然后将差异更新到真实节点中, 而寻找差异这个过程, 也就是尝说的`diff算法`

-   patch(oldVnode, newVnode)
-   把新节点中变化的内容渲染到真实 DOM, 最后返回新节点作为下一次处理的旧节点
-   对比新旧 VNode 是否相同节点(节点的 key 和 sel 相同)
-   如果不是相同节点, 删除之前的内容, 重新渲染
-   如果是相同节点, 在判断新的 VNode 是否有 text, 如果有并且和 oldVnode 的 text 不同, 直接更新文本内容
-   如果新的 VNode 有 children, 判断子节点是否有变化

## init 函数

在之前的案例中, 使用 patch 函数的之前, 都是先调用 init 函数, 执行后返回了一个 patch 函数。

因此, 在看 patch 函数之前, 需要先查看 init 函数中做了哪些工作。

1. 首先导入了一些后面要使用的模块
2. 然后定义了一些类型和辅助函数(判断类型等)
3. 定义了生命周期钩子的数组, 将会在 init 中初始化, 然后在特定的时刻触发
4. init

```ts
function init(modules: Array<Partial<Module>>, domApi?: DOMAPI){...}
```

init 函数有两个参数, 一个是 modules, 一个是 domApi，但是在之前用 snabbdom 做案例的时候, 只给 init 传过一个参数, 那就是 modules

`modules`是模块数组, 之前用过 snabbdom 提供的模块, 用于处理元素的行内样式和注册事件, 之前并没有传递第二个参数`domApi`

`domApi`, 主要是用于将 VNode 对象转换为其他平台下对应的元素, 在没有传递的情况下, 默认设置成 dom 操作的 api(这也是虚拟 dom 最大的好处 ———— 跨平台)

### init 详解

1. 定义 cbs

```ts
// 初始化cbs(callbacks回调函数)， 这里面存储的就是模块中的钩子函数, 在合适的时机去执行
// 对象的键名和上面的hooks成员一致
const cbs: ModuleHooks = {
    create: [],
    update: [],
    remove: [],
    destroy: [],
    pre: [],
    post: [],
};
```

2. 处理平台 api

```ts
// 若没有指定domApi, 则使用htmlDomApi
// htmlDomApi中初始化了一些方法, 这些方法都是用于操作dom元素的
const api: DOMAPI = domApi !== undefined ? domApi : htmlDomApi;
```

3. 初始化 cbs

```ts
// 双层循环初始化cbs
for (const hook of hooks) {
    for (const module of modules) {
        const currentHook = module[hook];
        // 只要module中包含当前钩子, 则将其添加到cbs对应的钩子数组中
        if (currentHook !== undefined) {
            (cbs[hook] as any[]).push(currentHook);
        }
    }
}
```

4. 接下来定义了一系列的辅助函数, 暂时先不看
5. 最后就是返回了一个patch函数

整个init函数, 其实就是一个高阶函数, 也就是一个函数返回另一个函数

这样做的好处就是, 让patch函数的入参变少了, 本来需要四个参数, modules, oldApi, olvVnode和newVnode, 但是现在只需要两个, 那就是oldVnode和newVnode, 前两个参数都前置处理了

其实这样的高阶函数, 也叫函数柯里化

由于patch函数需要经常调用, 因此在这里, 先处理前两个参数, 并且缓存起来(因为形成了闭包), 在后面多次使用的时候, 都不用反复处理, 这样的优势更明显, 在之后的vue源码中, 这样的多层柯里化还还很多

6. path函数过程
