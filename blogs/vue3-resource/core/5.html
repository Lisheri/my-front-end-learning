<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3组件渲染 - 完整的DOM Diff 流程(二) | 小莫的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/my-front-end-learning/favicon.ico">
    <meta name="description" content="冲">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/my-front-end-learning/assets/css/0.styles.e6d2aca3.css" as="style"><link rel="preload" href="/my-front-end-learning/assets/js/app.0297fef0.js" as="script"><link rel="preload" href="/my-front-end-learning/assets/js/3.e58151dc.js" as="script"><link rel="preload" href="/my-front-end-learning/assets/js/1.a31d2227.js" as="script"><link rel="preload" href="/my-front-end-learning/assets/js/5.d0775db2.js" as="script"><link rel="prefetch" href="/my-front-end-learning/assets/js/10.9cdb5e91.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/100.fd2ff724.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/101.226f0bb9.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/102.0c24533f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/103.78dc0369.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/104.8cdc978f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/105.65cebce9.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/106.c38cf333.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/107.da45b468.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/108.99be55a1.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/109.693c6206.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/11.d2d37e4e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/110.448d1c44.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/111.72d3b53e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/112.91b7145a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/113.ae924c08.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/114.6a699705.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/115.5a872e83.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/116.e3f38719.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/117.a6c04922.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/118.aee81ac8.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/119.743d83d9.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/12.d9944d9a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/120.d72aa091.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/121.80eb00ee.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/122.6aa4e4b1.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/123.d260e098.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/124.bf2908e0.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/125.23f3505c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/126.90e6a534.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/127.6ed82cd0.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/128.484219c1.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/129.3eb4fad0.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/13.21afb9ff.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/130.65e07f61.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/131.a258ee53.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/132.f60adf92.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/133.2b083334.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/134.5433704c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/135.5c0a5292.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/136.c2c850c9.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/137.0673ee8b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/138.2d39f46c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/139.829b4522.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/14.bb978e32.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/140.28eb5f44.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/141.f0f2f469.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/142.8ee20009.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/143.832659c6.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/144.cb86e234.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/145.dbfe0f45.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/146.ba35ae78.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/147.2f07b26f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/148.ea4f7e57.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/149.96fe250a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/15.4816e5e5.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/150.c1b9e789.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/151.f16e369f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/152.330ac78e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/153.86f70afd.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/154.cff5902e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/155.1dce8711.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/156.dda27632.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/157.7dadb8ba.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/158.991085ba.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/159.8bcc794e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/16.522efc5d.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/160.ef63d505.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/161.d0344f5c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/162.dbb201f7.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/163.ec7987d8.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/164.401710aa.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/165.6cc42a60.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/166.94f1a8bf.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/167.8f7398c8.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/168.a838c3df.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/169.44c05de5.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/17.70a2e190.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/170.e966641e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/171.97ced274.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/172.09f3c7ba.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/173.abb48fff.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/174.dcce1bb3.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/175.1b24b660.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/176.03deb356.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/177.435b4e35.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/178.e040cdd1.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/179.081ccc9f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/18.1b7e7620.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/180.476cf7ee.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/181.def92823.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/182.2c7abbfc.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/183.712601a0.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/184.74ec3283.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/185.067a624f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/186.1db2c157.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/187.6549a1a6.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/188.597903a5.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/189.be06aa76.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/19.990e212a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/190.e03b3206.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/191.db6cd411.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/192.85d663e2.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/193.6cd12741.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/194.6bcb8194.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/20.43e082e1.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/21.feaeca5c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/22.72d39582.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/23.b79eec28.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/24.4599e836.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/25.32221675.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/26.aedbb67b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/27.5773c105.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/28.8ef2d727.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/29.0236020e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/30.304f0db1.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/31.bf80883b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/32.64095a94.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/33.d722075b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/34.231ffd93.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/35.b97ef26b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/36.6b9e1bd6.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/37.632e4b14.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/38.76b60dee.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/39.b6ed4ae9.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/4.376a1b26.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/40.d215e2a8.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/41.d0c7e359.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/42.c8674edd.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/43.71e824a3.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/44.7a7e7241.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/45.51ea8788.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/46.28cd375b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/47.1787e485.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/48.108380ae.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/49.d89e3214.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/50.ac8c2b22.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/51.a7c5cd69.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/52.6cc0f528.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/53.7698c247.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/54.3947c335.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/55.f0b5bf52.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/56.c5634641.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/57.b15b8b5e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/58.a623583a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/59.bc50b59f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/6.2d2e4de4.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/60.8317040e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/61.628635f6.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/62.15bf4b1f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/63.59395341.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/64.5def88f2.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/65.96b161c0.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/66.58596ec7.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/67.a72c4047.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/68.c6429ca1.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/69.ddea38b2.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/7.657fd34d.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/70.3fb47b34.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/71.20cf0001.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/72.8b41c64e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/73.d7e2d9bd.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/74.361aba3a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/75.0c2a7e34.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/76.1ab4dfe4.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/77.e6870d5d.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/78.3da91390.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/79.93efb367.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/8.84b80b75.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/80.1b7d5f3e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/81.dac9c71f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/82.caab2450.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/83.204b323b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/84.31f157a9.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/85.7fa87827.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/86.f52c2bfb.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/87.f712bac6.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/88.9b07c0e1.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/89.6c80f225.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/9.1fc63354.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/90.578a23e9.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/91.7987199f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/92.4c539947.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/93.0b2f85c8.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/94.e2d4c9e4.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/95.005accff.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/96.4d44b4d5.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/97.2bfd1774.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/98.77588f02.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/99.996ffbef.js">
    <link rel="stylesheet" href="/my-front-end-learning/assets/css/0.styles.e6d2aca3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>小莫的博客</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>冲</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Lisher</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2023
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-front-end-learning/" class="home-link router-link-active"><img src="/my-front-end-learning/logo.png" alt="小莫的博客" class="logo"> <span class="site-name">小莫的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-front-end-learning/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/ssr基础/" class="nav-link"><i class="undefined"></i>
  ssr基础
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/Gridsome/" class="nav-link"><i class="undefined"></i>
  Gridsome
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/ECMAScript6/" class="nav-link"><i class="undefined"></i>
  ECMAScript6
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/函数式编程/" class="nav-link"><i class="undefined"></i>
  函数式编程
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS异步编程/" class="nav-link"><i class="undefined"></i>
  JS异步编程
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/前端工程化/" class="nav-link"><i class="undefined"></i>
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/前端规范化标准/" class="nav-link"><i class="undefined"></i>
  前端规范化标准
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/webpack源码解析/" class="nav-link"><i class="undefined"></i>
  webpack源码解析
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/vuex/" class="nav-link"><i class="undefined"></i>
  vuex
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/微前端/" class="nav-link"><i class="undefined"></i>
  微前端
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/qiankun源码/" class="nav-link"><i class="undefined"></i>
  qiankun源码
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/小程序/" class="nav-link"><i class="undefined"></i>
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS性能/" class="nav-link"><i class="undefined"></i>
  JS性能
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/React基础/" class="nav-link"><i class="undefined"></i>
  React基础
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS类型系统/" class="nav-link"><i class="undefined"></i>
  JS类型系统
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/TypeScript/" class="nav-link"><i class="undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/Vue源码/" class="nav-link"><i class="undefined"></i>
  Vue源码
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/vue基础/" class="nav-link"><i class="undefined"></i>
  vue基础
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/vue3源码/" class="nav-link"><i class="undefined"></i>
  vue3源码
</a></li></ul></div></div><div class="nav-item"><a href="/my-front-end-learning/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/my-front-end-learning/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Lisheri" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  myGitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/my-front-end-learning/Lisher.jpeg" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    Lisher
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>183</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>25</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/my-front-end-learning/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/ssr基础/" class="nav-link"><i class="undefined"></i>
  ssr基础
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/Gridsome/" class="nav-link"><i class="undefined"></i>
  Gridsome
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/ECMAScript6/" class="nav-link"><i class="undefined"></i>
  ECMAScript6
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/函数式编程/" class="nav-link"><i class="undefined"></i>
  函数式编程
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS异步编程/" class="nav-link"><i class="undefined"></i>
  JS异步编程
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/前端工程化/" class="nav-link"><i class="undefined"></i>
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/前端规范化标准/" class="nav-link"><i class="undefined"></i>
  前端规范化标准
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/webpack源码解析/" class="nav-link"><i class="undefined"></i>
  webpack源码解析
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/vuex/" class="nav-link"><i class="undefined"></i>
  vuex
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/微前端/" class="nav-link"><i class="undefined"></i>
  微前端
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/qiankun源码/" class="nav-link"><i class="undefined"></i>
  qiankun源码
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/小程序/" class="nav-link"><i class="undefined"></i>
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS性能/" class="nav-link"><i class="undefined"></i>
  JS性能
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/React基础/" class="nav-link"><i class="undefined"></i>
  React基础
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS类型系统/" class="nav-link"><i class="undefined"></i>
  JS类型系统
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/TypeScript/" class="nav-link"><i class="undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/Vue源码/" class="nav-link"><i class="undefined"></i>
  Vue源码
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/vue基础/" class="nav-link"><i class="undefined"></i>
  vue基础
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/vue3源码/" class="nav-link"><i class="undefined"></i>
  vue3源码
</a></li></ul></div></div><div class="nav-item"><a href="/my-front-end-learning/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/my-front-end-learning/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Lisheri" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  myGitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue3简介</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-front-end-learning/blogs/vue3-resource/introduction/1.html" class="sidebar-link">Vue3源码组织方式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>核心组件实现</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-front-end-learning/blogs/vue3-resource/core/1.html" class="sidebar-link">Vue3组件渲染 - 组件化</a></li><li><a href="/my-front-end-learning/blogs/vue3-resource/core/2.html" class="sidebar-link">Vue3组件渲染 - 应用程序初始化</a></li><li><a href="/my-front-end-learning/blogs/vue3-resource/core/3.html" class="sidebar-link">Vue3组件渲染 - 核心渲染流程</a></li><li><a href="/my-front-end-learning/blogs/vue3-resource/core/4.html" class="sidebar-link">Vue3组件渲染 - 完整的DOM Diff 流程(一)</a></li><li><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html" aria-current="page" class="active sidebar-link">Vue3组件渲染 - 完整的DOM Diff 流程(二)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue3Setup</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-front-end-learning/blogs/vue3-resource/compositionAPI/1.html" class="sidebar-link">Vue3Setup - 组件渲染前的初始化过程入口</a></li><li><a href="/my-front-end-learning/blogs/vue3-resource/compositionAPI/2.html" class="sidebar-link">组件渲染前的初始化过程 - 创建渲染上下文代理</a></li><li><a href="/my-front-end-learning/blogs/vue3-resource/compositionAPI/3.html" class="sidebar-link">组件渲染前的初始化过程 - 判断处理setup函数</a></li><li><a href="/my-front-end-learning/blogs/vue3-resource/compositionAPI/4.html" class="sidebar-link">响应式 - 响应式内部原理实现(一)</a></li><li><a href="/my-front-end-learning/blogs/vue3-resource/compositionAPI/5.html" class="sidebar-link">响应式 - 响应式内部原理实现(二)</a></li><li><a href="/my-front-end-learning/blogs/vue3-resource/compositionAPI/6.html" class="sidebar-link">响应式 - 响应式内部原理实现(三)</a></li><li><a href="/my-front-end-learning/blogs/vue3-resource/compositionAPI/7.html" class="sidebar-link">响应式 - 计算属性</a></li><li><a href="/my-front-end-learning/blogs/vue3-resource/compositionAPI/8.html" class="sidebar-link">响应式 - 侦听器（一）</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Vue3组件渲染 - 完整的DOM Diff 流程(二)</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Lisher</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2023
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">Vue3组件渲染 - 完整的DOM Diff 流程(二)</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>Lisher</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>9/21/2022</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/my-front-end-learning/blogs/vue3-resource/core/5.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>vue</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="完整的dom-diff流程"><a href="#完整的dom-diff流程" class="header-anchor">#</a> 完整的DOM Diff流程</h1> <p>这一节主要分析上一节说的核心diff流程</p> <p>新子结点数组相对于旧子节点数组的变化, 无非是通过更新、删除、添加和移动节点来完成</p> <p>而核心diff算法, 就是在已知旧子节点的DOM结构, vnode和新子节点的vnode情况下, 以较低的成本完成子节点的更新为目的, 求解生成新子节点DOM的系列操作</p> <h2 id="例子"><a href="#例子" class="header-anchor">#</a> 例子</h2> <h3 id="例1"><a href="#例1" class="header-anchor">#</a> 例1</h3> <p>比如这里有一个列表</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>c<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>c<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>d<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>d<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>需要更新到如下列表</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>e<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>e<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>c<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>c<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>d<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>d<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在操作前后, 他们对应生成的vnode如下所示:</p> <p><img src="/my-front-end-learning/assets/img/5.a86f6b0d.png" alt="childrenvnodes"></p> <p>其实从上图可以直观感受到, 差异就是在b节点后面多了一个e节点</p> <h3 id="例2"><a href="#例2" class="header-anchor">#</a> 例2</h3> <p>此时改造一下例子</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>c<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>c<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>d<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>d<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>e<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>e<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后删除其中的c节点</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>d<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>d<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>e<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>e<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以看到更新前后的children如下图所示:</p> <p><img src="/my-front-end-learning/assets/img/6.169a2079.png" alt="childrenvnodes"></p> <p>可以看到差异主要是在b节点后面少了一个c节点</p> <blockquote><p>综合上述两个例子, 可以很容易发现新旧children拥有相同的头尾节点。对于相同的节点, 我们只需要做对比更新即可</p> <p>在整个 diff 的过程，我们需要维护几个变量：头部的索引 i、旧子节点的尾部索引 e1和新子节点的尾部索引 e2。</p> <p>针对所有新的儿子节点数组中的vnode, 在对比是否相等前, 都要通过 <a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#normalizevnode">normalizeVNode</a> 方法序列化vnode, 处理差异</p> <p>所以diff算法的第一步是<code>从头部开始同步</code></p> <p>如果头部相同节点判断完成, 则开始<a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#同步尾部节点">从尾部同步节点</a></p></blockquote> <h2 id="同步头部节点"><a href="#同步头部节点" class="header-anchor">#</a> 同步头部节点</h2> <ul><li>从头部开始循环</li> <li>判断是新旧子节点数组中开始节点是否为相同节点</li> <li>如果是, 则执行patch递归更新</li> <li>新旧子节点数组继续从头部往后</li> <li>如果不同或者索引 i 大于索引 e1 或者 e2，则同步过程结束。</li> <li>如果不是, 则退出循环, 开始下一批次<a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#同步尾部节点">尾部节点同步</a></li></ul> <p>同步头部节点代码如下:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> patchKeyedChildren <span class="token operator">=</span> <span class="token punctuation">(</span>
  c1<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  c2<span class="token operator">:</span> VNodeArrayChildren<span class="token punctuation">,</span>
  container<span class="token operator">:</span> RendererElement<span class="token punctuation">,</span>
  parentAnchor<span class="token operator">:</span> RendererNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentComponent<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentSuspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  isSVG<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  slotScopeIds<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  optimized<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">// 一般为false</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> l2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length
  <span class="token comment">// 旧子节点尾部索引</span>
  <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">// prev ending index</span>
  <span class="token comment">// 新子节点尾部索引</span>
  <span class="token keyword">let</span> e2 <span class="token operator">=</span> l2 <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">// next ending index</span>

  <span class="token comment">// 1. sync from start</span>
  <span class="token comment">// (a b) c</span>
  <span class="token comment">// (a b) d e</span>
  <span class="token comment">// 1. 从头部开始同步</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 旧子节点vnode</span>
    <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token comment">// 新子节点vnode</span>
    <span class="token keyword">const</span> n2 <span class="token operator">=</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
      <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 更新前后是否同一节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对于相同节点执行patch递归更新</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>
        n1<span class="token punctuation">,</span>
        n2<span class="token punctuation">,</span>
        container<span class="token punctuation">,</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        parentComponent<span class="token punctuation">,</span>
        parentSuspense<span class="token punctuation">,</span>
        isSVG<span class="token punctuation">,</span>
        slotScopeIds<span class="token punctuation">,</span>
        optimized
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    i<span class="token operator">++</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h2 id="同步尾部节点"><a href="#同步尾部节点" class="header-anchor">#</a> 同步尾部节点</h2> <p>同步尾部节点就是从尾部开始，依次对比新节点和旧节点，如果相同的则执行 patch 更新节点；如果不同或者索引 i 大于索引 e1 或者 e2，则同步过程结束。</p> <p>主要流程如下:</p> <ol><li>和同步新节点类似, 只不过是从尾部开始对比</li> <li>其中e1为旧的儿子节点结束位置, e2为新的儿子节点结束位置</li> <li>n1旧的儿子结束vnode, n2 为新的儿子节点结束vnode</li> <li>对比新旧节点是否相同</li></ol> <ul><li>如果新旧vnode为相同vnode, 则调用patch递归更新, 和头部比较一样</li> <li>否则退出循环, 同步尾部节点过程结束, 继续进行后续的比较</li></ul> <ol start="5"><li>如果是相同节点, 那么在最后要让尾部往前, 也就是<code>e1--</code>和<code>e2--</code>,</li></ol> <p>可以结合下图观察尾部节点同步的情况:</p> <p><img src="/my-front-end-learning/assets/img/7.e5584c82.png" alt="尾部节点同步"></p> <p>在a和b进行同步节点完成后, c和e不符合头部同步, 则继续往后进入尾部节点同步, 此时i是2, e1是3, e2是4</p> <p>第一次对比<code>c1[e1]</code>和<code>c2[e2]</code>, 也就是d和d, 是相同节点, 执行patch递归更新</p> <p>进入第二次比较, 也就是c和c, 还是相同节点, 执行patch递归更新</p> <p>此时i不满足&lt;= e1, 结束</p> <p>完成尾部节点同步后：i 是 2，e1 是 1，e2 是 2。</p> <p>接下来只有 3 种情况要处理：</p> <ol><li>新子节点有剩余要<a href="">添加的新节点</a>；</li> <li>旧子节点有剩余要删除的多余节点；</li> <li>未知子序列。</li></ol> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token operator">...</span>
<span class="token comment">// 2. sync from end</span>
<span class="token comment">// a (b c)</span>
<span class="token comment">// d e (b c)</span>
<span class="token comment">// 2. 从新旧子节点数组尾部开始对比</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span>
  <span class="token keyword">const</span> n2 <span class="token operator">=</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
    <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 是否相同节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 相同节点执行patch递归更新</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>
      n1<span class="token punctuation">,</span>
      n2<span class="token punctuation">,</span>
      container<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      parentComponent<span class="token punctuation">,</span>
      parentSuspense<span class="token punctuation">,</span>
      isSVG<span class="token punctuation">,</span>
      slotScopeIds<span class="token punctuation">,</span>
      optimized
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">break</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 从后往前</span>
  e1<span class="token operator">--</span>
  e2<span class="token operator">--</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h2 id="添加新节点"><a href="#添加新节点" class="header-anchor">#</a> 添加新节点</h2> <p>首先判断新的子节点是否有剩余</p> <p>满足剩余条件, 则计算挂载锚点(当前对比节点的下一个, 作为锚点)</p> <p>调用patch方法挂载剩余节点</p> <p>如果索引 i 大于尾部索引 e1 且 i 小于 e2，那么从索引 i 开始到索引 e2 之间，我们直接挂载新子树这部分的节点。</p> <p>对上面的例子而言，同步完尾部节点后 i 是 2，e1 是 1，e2 是 2，此时满足条件需要添加新的节</p> <p>通过下图看一下添加后的结果：</p> <p><img src="/my-front-end-learning/assets/img/8.abd4ccd0.png" alt="结果"></p> <p>添加完 e 节点后，旧子节点的 DOM 和新子节点对应的 vnode 映射一致，也就完成了更新。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 3. 挂载节点剩余部分</span>
<span class="token comment">// (a b)</span>
<span class="token comment">// (a b) c</span>
<span class="token comment">// i = 2, e1 = 1, e2 = 2</span>
<span class="token comment">// (a b)</span>
<span class="token comment">// c (a b)</span>
<span class="token comment">// i = 0, e1 = -1, e2 = 0</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 旧的遍历完了, 还有多的新节点</span>
    <span class="token keyword">const</span> nextPos <span class="token operator">=</span> e2 <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token comment">// 计算节点锚点</span>
    <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextPos <span class="token operator">&lt;</span> l2 <span class="token operator">?</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span><span class="token punctuation">.</span>el <span class="token operator">:</span> parentAnchor
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 挂载新节点</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
          <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        container<span class="token punctuation">,</span>
        anchor<span class="token punctuation">,</span>
        parentComponent<span class="token punctuation">,</span>
        parentSuspense<span class="token punctuation">,</span>
        isSVG<span class="token punctuation">,</span>
        slotScopeIds<span class="token punctuation">,</span>
        optimized
      <span class="token punctuation">)</span>
      i<span class="token operator">++</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h2 id="删除多余节点"><a href="#删除多余节点" class="header-anchor">#</a> 删除多余节点</h2> <p>如果不满足添加新节点的情况，我就要接着判断旧子节点是否有剩余，如果满足则删除旧子节点，实现代码如下：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 4. common sequence + unmount</span>
<span class="token comment">// 4. 删除多余节点</span>
<span class="token comment">// (a b) c</span>
<span class="token comment">// (a b)</span>
<span class="token comment">// i = 2, e1 = 2, e2 = 1</span>
<span class="token comment">// a (b c)</span>
<span class="token comment">// (b c)</span>
<span class="token comment">// i = 0, e1 = 0, e2 = -1</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 新的子节点先遍历完, 直接删除</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 删除节点</span>
    <span class="token function">unmount</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    i<span class="token operator">++</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="处理未知子序列"><a href="#处理未知子序列" class="header-anchor">#</a> 处理未知子序列</h2> <p>单纯的添加和删除节点都是比较理想的情况, 操作起来也很容易, 但是有些时候并非这么幸运, 我们会遇到比较复杂的未知子序列, 这时diff算法会如何做呢?</p> <p>这里还是通过例子来演示存在未知子序列的情况, 假设一个按照字母表排列的列表:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>c<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>c<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>d<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>d<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>e<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>e<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>f<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>f<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>g<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>g<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>h<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>h<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>需要更新为一个新表:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>e<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>e<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>d<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>c<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>c<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>d<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>i<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>i<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>g<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>g<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>h<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>h<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这里依然从头部开始同步:</p> <p><img src="/my-front-end-learning/assets/img/9.7248c44d.png" alt="头部开始"></p> <p>同步头部节点后的结果是: i是2, e1是7, e2是7</p> <p>头部不满足后, 从尾部继续同步节点:</p> <p><img src="/my-front-end-learning/assets/img/10.1cf62b4a.png" alt="尾部继续"></p> <p>同步尾部节点后, 结果变成了i为2, e1是5, e2是5。</p> <p>此时他既不能添加新节点, 也不能删除旧节点。</p> <p>结合这个图可以知道, 要把旧的子节点c,d,e,f转变成新子节点的e, c, d, i</p> <p>但不管情况多复杂, 最终都是通过更新、删除、添加和移动这些动作来操作节点, 而我们要做的就是找到相对优的解</p> <ul><li>当两个节点类型相同时, 执行更新操作</li> <li>当新子节点中没有旧子节点中的某些节点时, 执行删除操作</li> <li>当新子节点中多了旧子节点中没有的节点时, 执行添加操作</li></ul> <p>前面这几个操作其实已经说的很清楚了, 相对这几个操作来说, 最复杂的就是移动了, 既要判断哪些节点需要移动, 也要清楚的知道他们如何移动</p> <h2 id="移动子节点"><a href="#移动子节点" class="header-anchor">#</a> 移动子节点</h2> <p>当子节点排序发生变化时, 就需要移动子节点了</p> <p>比如下面这个例子:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> prev <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> next <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以看到, 从prev变成next, 数组里的一些元素顺序发生了变化, 可以把子节点类比为元素。问题就简化为了从 prev -&gt; next</p> <p>一种思路是在next中找到一个递增子序列, 比如 <code>[1, 3, 6]</code>、<code>[1, 2, 4, 5]</code>。之后对next数组进行倒序遍历, 移动所有不在递增序列中的元素即可</p> <p>如果选择了 <code>[1, 3, 6]</code>作为递增序列, 那么在倒序遍历的过程中, 遇到 <code>6, 3, 1</code>不动, 遇到 <code>5, 4, 2</code>移动即可</p> <p>如图所示:</p> <p><img src="/my-front-end-learning/assets/img/11.fdac20c9.png" alt="631不动"></p> <p>如果选择以 <code>[1, 2, 4, 5]</code>作为递增序列, 那么在倒序遍历的过程中, 遇到5, 4, 2, 1不动, 遇到6, 3移动即可, 如图所示:</p> <p><img src="/my-front-end-learning/assets/img/12.11b9309d.png" alt="1245不动"></p> <p>可以看到第一种移动了三次, 而第二种只移动了两次, 递增子序列越长, 所需要移动元素的次数越少, 所以如何移动的问题其实就回到了求解最长递增子序列的问题。</p> <p>现在要做的是在新旧子节点序列中找出相同节点并更新, 找出多余节点并删除以及找出新的节点添加, 找出是否需要移动的节点, 如果存在如何移动?</p> <p>在查找过程中, 需要对比新旧子序列, 那么我们就要遍历某个序列, 如果在遍历旧子序列的过程中需要判断某个节点是否在新子序列中存在, 这就需要双重循环, 而双重循环的复杂度是O(n^2), 为了优化这个复杂度, 可以用一种空间换时间的思路, 建立索引图, 把时间复杂度降到O(n)</p> <h3 id="建立索引图"><a href="#建立索引图" class="header-anchor">#</a> 建立索引图</h3> <p>建立索引图很关键, 所以在处理未知子序列的第一步, 就是建立索引图</p> <p>通常在开发过程中, 进行遍历生成节点时, 都会添加一个key作为唯一项, 这个key在diff过程中起到很关键的作用。</p> <p>对于新旧子序列中的节点, 我们认为key相同的就是同一个节点, 直接执行patch递归更新即可</p> <p>patchKeyedChildren中建立索引图代码如下:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 5. 未知子序列处理</span>
<span class="token comment">// [i ... e1 + 1]: a b [c d e] f g</span>
<span class="token comment">// [i ... e2 + 1]: a b [e d c h] f g</span>
<span class="token comment">// i = 2, e1 = 4, e2 = 5</span>
<span class="token comment">// 旧子序列开始索引</span>
<span class="token keyword">const</span> s1 <span class="token operator">=</span> i <span class="token comment">// prev starting index</span>
<span class="token comment">// 新子序列开始索引</span>
<span class="token keyword">const</span> s2 <span class="token operator">=</span> i <span class="token comment">// next starting index</span>

<span class="token comment">// 5.1 build key:index map for newChildren</span>
<span class="token comment">// 根据key建立新子序列的索引图</span>
<span class="token keyword">const</span> keyToNewIndexMap<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s2<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> nextChild <span class="token operator">=</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> optimized
    <span class="token operator">?</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 开发环境校验重复key并抛错</span>
    <span class="token punctuation">}</span>
    keyToNewIndexMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>新旧子序列都是从i开始的, 所以先用s1, s2分别作为新旧子节点的开始索引, 接着声明一个 keyToNewIndexMap</p> <p>遍历新子序列, 把节点的key和index添加到map中, 键为key, 值为index值</p> <p>keyToNewIndexMap存储的就是新子序列中每个节点在新子序列中的索引, 上面的示例处理后的结果如下图所示:</p> <p><img src="/my-front-end-learning/assets/img/13.906e5c36.png" alt="索引图"></p> <p>此时索引图为: <code>{e: 2, c: 3, d: 4, i: 5}</code></p> <h3 id="更新和移除旧节点"><a href="#更新和移除旧节点" class="header-anchor">#</a> 更新和移除旧节点</h3> <p>建立完索引图后, 就需要遍历旧子序列, 有相同的节点就通过patch更新, 并且移除那些不在新子序列中的节点, 同时找出是否有需要移动的节点, 下面是其实现：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 5.2 loop through old children left to be patched and try to patch</span>
<span class="token comment">// matching nodes &amp; remove nodes that are no longer present</span>
<span class="token comment">// 正序遍历旧子序列, 找到匹配的节点更新, 删除不在新子序列中的节点, 判断是否有移动节点</span>
<span class="token keyword">let</span> j
<span class="token comment">// 新子序列已更新节点的数量</span>
<span class="token keyword">let</span> patched <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// 新子序列待更新节点的数量, 等于新子序列的长度</span>
<span class="token keyword">const</span> toBePatched <span class="token operator">=</span> e2 <span class="token operator">-</span> s2 <span class="token operator">+</span> <span class="token number">1</span>
<span class="token comment">// 是否存在要移动的节点</span>
<span class="token keyword">let</span> moved <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token comment">// used to track whether any node has moved</span>
<span class="token comment">// 用于跟踪判断是否有节点移动</span>
<span class="token keyword">let</span> maxNewIndexSoFar <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// works as Map&lt;newIndex, oldIndex&gt;</span>
<span class="token comment">// Note that oldIndex is offset by +1</span>
<span class="token comment">// and oldIndex = 0 is a special value indicating the new node has</span>
<span class="token comment">// no corresponding old node.</span>
<span class="token comment">// used for determining longest stable subsequence</span>
<span class="token comment">// 用于存储新子序列中的元素在旧子序列节点的索引, 用于确定最长递增子序列</span>
<span class="token keyword">const</span> newIndexToOldIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>toBePatched<span class="token punctuation">)</span>
<span class="token comment">// 初始化数组, 每个元素的值都是0</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> toBePatched<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> newIndexToOldIndexMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// 正序遍历旧子序列</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s1<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e1<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 旧子节点vnode值</span>
  <span class="token keyword">const</span> prevChild <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>patched <span class="token operator">&gt;=</span> toBePatched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 所有子序列更新完成, 剩余的节点删除</span>
    <span class="token comment">// all new children have been patched so this can only be a removal</span>
    <span class="token function">unmount</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">continue</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> newIndex
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 查找旧子序列中的节点在新子序列中的索引</span>
    newIndex <span class="token operator">=</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果旧子节点vnode没有设置key, 则循环推断一个合适的索引</span>
    <span class="token comment">// key-less node, try to locate a key-less node of the same type</span>
    <span class="token class-name"><span class="token keyword">for</span></span> <span class="token punctuation">(</span>j <span class="token operator">=</span> s2<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        newIndexToOldIndexMap<span class="token punctuation">[</span>j <span class="token operator">-</span> s2<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当前序列还没有存储过索引, 并且他们是一个sameVnode, 那么就说明这是一个合适的key, 将当前索引作为旧子序列中节点在新子序列中的索引</span>
        newIndex <span class="token operator">=</span> j
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果找不到, 说明旧子序列已不存在于新子序列中, 该节点需删除</span>
    <span class="token function">unmount</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新新子序列中的元素在旧子序列中的索引，这里加 1 偏移，是为了避免 i 为 0 的特殊情况，影响对后续最长递增子序列的求解</span>
    newIndexToOldIndexMap<span class="token punctuation">[</span>newIndex <span class="token operator">-</span> s2<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token comment">// maxNewIndexSoFar 始终存储的是上次求值的 newIndex，如果不是一直递增，则说明有移动</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">&gt;=</span> maxNewIndexSoFar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      maxNewIndexSoFar <span class="token operator">=</span> newIndex
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      moved <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 更新新旧子序列中匹配的节点</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>
      prevChild<span class="token punctuation">,</span>
      c2<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">,</span>
      container<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      parentComponent<span class="token punctuation">,</span>
      parentSuspense<span class="token punctuation">,</span>
      isSVG<span class="token punctuation">,</span>
      slotScopeIds<span class="token punctuation">,</span>
      optimized
    <span class="token punctuation">)</span>
    patched<span class="token operator">++</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><p>这里建立了一个newIndexToOldIndexMap的数组, 来存储新子序列节点的索引和旧子序列节点的索引之间的映射关系, 用于确定最长递增子序列</p> <p>这个数组的长度为新子序列的长度, 每个元素的初始值设为0, 他是一个特殊的值, 如果遍历完了仍有元素的值为0, 则说明遍历旧子序列的过程中, 没有处理过这个节点, 那么这个节点就是新添加的</p> <p>下面说一下具体操作过程:</p> <p>正序遍历旧子序列, 根据前面建立的keyToNewIndexMap查找旧子序列中的节点在新子序列中的索引</p> <p>如果找不到就说明新子序列中没有该节点, 就删除它, 如果找得到, 则将它在旧子序列中的索引更新到newIndexToOldIndexMap中</p> <p>注意这里索引加了长度为 1 的偏移，是为了应对 i 为 0 的特殊情况，如果不这样处理就会影响后续求解最长递增子序列。</p> <p>遍历过程中，我们用变量 maxNewIndexSoFar 跟踪判断节点是否移动
maxNewIndexSoFar 始终存储的是上次求值的 newIndex
一旦本次求值的 newIndex 小于 maxNewIndexSoFar，这说明顺序遍历旧子序列的节点在新子序列中的索引并不是一直递增的，也就说明存在移动的情况。</p> <p>除此之外，这个过程中我们也会更新新旧子序列中匹配的节点，另外如果所有新的子序列节点都已经更新，而对旧子序列遍历还未结束，说明剩余的节点就是多余的，删除即可。</p> <p>至此，我们完成了新旧子序列节点的更新、多余旧节点的删除，并且建立了一个 newIndexToOldIndexMap 存储新子序列节点的索引和旧子序列节点的索引之间的映射关系，并确定是否有移动。</p> <p>实例处理后的结果如下图所示:</p> <p><img src="/my-front-end-learning/assets/img/14.e5aee24f.png" alt="移动"></p> <p>可以看到, c, d, e节点被更新, f节点被删除, newIndexToOldIndexMap的值为<code>[5, 3, 4, 0]</code>, 此时moved也为true, 也就是存在节点移动的情况</p> <h3 id="移动和挂载新节点"><a href="#移动和挂载新节点" class="header-anchor">#</a> 移动和挂载新节点</h3> <p>上一步说到, 更新完需要移动的节点后, 就需要将对应的节点移动到新的位置</p> <p>接下来，就到了处理未知子序列的最后一个流程，移动和挂载新节点</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 5.3 move and mount</span>
<span class="token comment">// 挂载和移动新节点</span>
<span class="token comment">// generate longest stable subsequence only when nodes have moved</span>
<span class="token comment">// 仅当节点移动时生成最长递增子序列</span>
<span class="token keyword">const</span> increasingNewIndexSequence <span class="token operator">=</span> moved
  <span class="token operator">?</span> <span class="token function">getSequence</span><span class="token punctuation">(</span>newIndexToOldIndexMap<span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token constant">EMPTY_ARR</span>
<span class="token comment">// 最长递增子序列的末尾index</span>
j <span class="token operator">=</span> increasingNewIndexSequence<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
<span class="token comment">// looping backwards so that we can use last patched node as anchor</span>
<span class="token comment">// 倒序遍历以便我们可以使用最后更新的节点作为锚点</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> toBePatched <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> nextIndex <span class="token operator">=</span> s2 <span class="token operator">+</span> i
  <span class="token keyword">const</span> nextChild <span class="token operator">=</span> c2<span class="token punctuation">[</span>nextIndex<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode
  <span class="token comment">// 锚点指向上一个更新的节点, 如果nextIndex超过子节点的长度, 则执行parentAnchor</span>
  <span class="token keyword">const</span> anchor <span class="token operator">=</span>
    nextIndex <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> l2 <span class="token operator">?</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>nextIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span><span class="token punctuation">.</span>el <span class="token operator">:</span> parentAnchor
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndexToOldIndexMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// mount new</span>
    <span class="token comment">// 挂载新的子节点</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      nextChild<span class="token punctuation">,</span>
      container<span class="token punctuation">,</span>
      anchor<span class="token punctuation">,</span>
      parentComponent<span class="token punctuation">,</span>
      parentSuspense<span class="token punctuation">,</span>
      isSVG<span class="token punctuation">,</span>
      slotScopeIds<span class="token punctuation">,</span>
      optimized
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>moved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// move if:</span>
    <span class="token comment">// There is no stable subsequence (e.g. a reverse)</span>
    <span class="token comment">// OR current node is not among the stable sequence</span>
    <span class="token comment">// 没有最长递增子序列（reverse 的场景）或者当前的节点索引不在最长递增子序列中，需要移动</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">!==</span> increasingNewIndexSequence<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此时知道当前节点的后一位应该谁(锚点), 也知道当前节点应该在的位置(nextIndex)</span>
      <span class="token comment">// 所以直接将旧子序列中的节点移动到上面求出来的两个位置即可, 也就是nextIndex处, 锚点之前(无锚点就是最后一位)</span>
      <span class="token comment">// moveType 为 REORDER 直接就是执行插入</span>
      <span class="token function">move</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> MoveType<span class="token punctuation">.</span><span class="token constant">REORDER</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      j<span class="token operator">--</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>前面已经判断了是否移动, 如果moved为true, 就通过 <a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#计算最长递增子序列">getSequence(newIndexToOldIndexMap)</a>计算最长递增子序列</p> <p>然后采用倒叙的方式遍历新子序列, 因为倒叙遍历可以方便使用最后更新的节点作为锚点。</p> <p>倒叙的过程中, 锚点指向上一个更新的节点, 然后判断 <code>newIndexToOldIndexMap[i]</code>是否为0, 如果是0, 则表示这是新节点, 需要挂载。</p> <p>接着判断是否存在移动节点的情况, 如果存在的话, 则看节点的索引是不是在最长递增子序列中, 如果在, 则倒叙最长递增子序列, 否则把他移动到锚点的前面</p> <p>为了便于更直观的理解, 我们用前面的例子展示一下这个过程, 此时:</p> <ul><li>toBePatched 为4</li> <li>j为1</li> <li>最长递增子序列increasingNewIndexSequence值为[1, 2]</li></ul> <p>在倒序新子序列的过程中, 首先遇到节点i, 发现他在 newIndexToOldIndexMap中的值为0, 说明他是新的节点, 我们需要挂载他</p> <p>然后继续遍历遇到节点d, 因为moved为true, 且d的索引存在于最长递增子序列中, 则执行j-- 倒序最长递增子序列, j此时为0;</p> <p>急着继续遍历遇到节点c, 它和d一样, 索引页存在于最长递增子序列中, 则执行j--, j此时为-1</p> <p>接着继续遍历遇到节点e, 此时j是-1并且e的索引也不在最长递增子序列中, 所以做一次移动操作, 把e节点移到上一个更新的节点, 也就是c节点的前面</p> <p>这里的移动其实就是插入</p> <p>新子序列倒序完成, 即完成了新节点的插入和旧节点的移动操作,也就完成了整个核心diff算法对节点的更新</p> <p>如下图所示</p> <p><img src="/my-front-end-learning/assets/img/15.488f8f12.png" alt="diff15"></p> <p>可以看到新子序列中的新节点 i 被挂载，旧子序列中的节点 e 移动到了 c 节点前面，至此，我们就在已知旧子节点 DOM 结构和 vnode、新子节点 vnode 的情况下，求解出生成新子节点的 DOM 的更新、移动、删除、新增等系列操作，并且以一种较小成本的方式完成 DOM 更新。</p> <p>我们知道了子节点更新调用的是 patch 方法， Vue3 正是通过这种递归的方式完成了整个组件树的更新。</p> <p>核心 diff 算法中最复杂就是<a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#计算最长递增子序列">求解最长递增子序列</a></p> <h2 id="计算最长递增子序列"><a href="#计算最长递增子序列" class="header-anchor">#</a> 计算最长递增子序列</h2> <p>求解最长递增子序列是一道经典的算法题，多数解法是使用动态规划的思想，算法的时间复杂度是 O(n2)，而 Vue.js 内部使用的是维基百科提供的一套“贪心 + 二分查找”的算法，贪心算法的时间复杂度是 O(n)，二分查找的时间复杂度是 O(logn)，所以它的总时间复杂度是 O(nlogn)。</p> <p>单纯地看代码并不好理解，我们用示例来看一下这个子序列的求解过程。</p> <p>假设我们有这个样一个数组 arr：[2, 1, 5, 3, 6, 4, 8, 9, 7]，求解它最长递增子序列的步骤如下：</p> <p><img src="/my-front-end-learning/assets/img/16.91fcb1ce.gif" alt="递增子序列"></p> <p>最终求得最长递增子序列的值就是 [1, 3, 4, 8, 9]。</p> <p>通过演示我们可以得到这个算法的主要思路：对数组遍历，依次求解长度为 i 时的最长递增子序列，当 i 元素大于 i - 1 的元素时，添加 i 元素并更新最长子序列；否则往前查找直到找到一个比 i 小的元素，然后插在该元素后面并更新对应的最长递增子序列。</p> <p>这种做法的主要目的是让递增序列的差尽可能的小，从而可以获得更长的递增子序列，这便是一种贪心算法的思想。</p> <p>了解了算法的大致思想后，接下来我们看一下源码实现：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">getSequence</span><span class="token punctuation">(</span>arr<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> p <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v<span class="token punctuation">,</span> c
  <span class="token keyword">const</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> arrI <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arrI <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      j <span class="token operator">=</span> result<span class="token punctuation">[</span>result<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> arrI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 存储在 result 更新前的最后一个索引值</span>
        p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
      <span class="token punctuation">}</span>
      u <span class="token operator">=</span> <span class="token number">0</span>
      v <span class="token operator">=</span> result<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token comment">// 二分搜索, 查找比 arrI 小的节点, 更新result的值</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>u <span class="token operator">&lt;</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u <span class="token operator">+</span> v<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>result<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> arrI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          u <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          v <span class="token operator">=</span> c
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>arrI <span class="token operator">&lt;</span> arr<span class="token punctuation">[</span>result<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        result<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> i
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  u <span class="token operator">=</span> result<span class="token punctuation">.</span>length
  v <span class="token operator">=</span> result<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token comment">// 回溯数组p, 找到最终的索引</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>u<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> v
    v <span class="token operator">=</span> p<span class="token punctuation">[</span>v<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>其中 result 存储的是长度为 i 的递增子序列最小末尾值的索引。比如我们上述例子的第九步，在对数组 p 回溯之前， result 值就是 [1, 3, 4, 7, 9] ，这不是最长递增子序列，它只是存储的对应长度递增子序列的最小末尾。因此在整个遍历过程中会额外用一个数组 p，来存储在每次更新 result 前最后一个索引的值，并且它的 key 是这次要更新的 result 值：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>j <span class="token operator">=</span> result<span class="token punctuation">[</span>result<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j
result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以看到，result 添加的新值 i 是作为 p 存储 result 最后一个值 j 的 key。上述例子遍历后 p 的结果如图所示：</p> <p><img src="/my-front-end-learning/assets/img/17.a819213e.png" alt="result"></p> <p>从 result 最后一个元素 9 对应的索引 7 开始回溯，可以看到 p[7] = 6，p[6] = 5，p[5] = 3，p[3] = 1，所以通过对 p 的回溯，得到最终的 result 值是 [1, 3 ,5 ,6 ,7]，也就找到最长递增子序列的最终索引了。这里要注意，我们求解的是最长子序列索引值，它的每个元素其实对应的是数组的下标。对于我们的例子而言，[2, 1, 5, 3, 6, 4, 8, 9, 7] 的最长子序列是 [1, 3, 4, 8, 9]，而我们求解的 [1, 3 ,5 ,6 ,7] 就是最长子序列中元素在原数组中的下标所构成的新数组。</p> <h2 id="normalizevnode"><a href="#normalizevnode" class="header-anchor">#</a> normalizeVNode</h2> <p>序列化vnode, 目的主要是消除新的vnode的差异</p> <p>逻辑很简单, 主要是对入参vnode的一系列判断</p> <ul><li>如果vnode是空或者是boolean, 那么说明新的节点是注释节点, 直接创建注释节点</li> <li>如果是数组, 则创建一个fragment子vnode</li> <li>如果是对象, 也就是普通vnode, 那么判断是否存在el, 存在则说明已经是vnode了, 返回即可, 不存在则通过入参对象创建vnode</li> <li>如果上述都不是, 则说明是字符串或数字, 那么直接创建文本vnode即可</li></ul> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>child<span class="token operator">:</span> VNodeChild<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果节点不存在或者节点类型为boolean, 则创建注释节点</span>
    <span class="token comment">// empty placeholder</span>
    <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>Comment<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果节点是一个数组, 则创建 Fragment</span>
    <span class="token comment">// fragment</span>
    <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>Fragment<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是一个常规vnode, 也就是一个对象, 判断el是否存在, 存在则直接返回, 不存在则创建vnode</span>
    <span class="token comment">// 已经是 vnode，这应该是最常见的，因为编译的模板总是产生全 vnode 子数组</span>
    <span class="token comment">// already vnode, this should be the most common since compiled templates</span>
    <span class="token comment">// always produce all-vnode children arrays</span>
    <span class="token keyword">return</span> child<span class="token punctuation">.</span>el <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> child <span class="token operator">:</span> <span class="token function">cloneVNode</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// strings and numbers</span>
    <span class="token comment">// 数字或者字符串直接创建文本节点</span>
    <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>Text<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>对于普通元素节点的更新，主要是更新一些属性，以及它的子节点。子节点的更新又分为多种情况，其中最复杂的情况为数组到数组的更新，内部又根据不同情况分成几个流程去 diff，遇到需要移动的情况还要去求解子节点的最长递增子序列。</p> <p>整个更新过程还是利用了树的深度遍历，递归执行 patch 方法，最终完成了整个组件树的更新。</p> <p>组件的更新流程如下图所示：</p> <p><img src="/my-front-end-learning/assets/img/18.d5fb6052.png" alt="总结"></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2/25/2023, 3:57:49 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/my-front-end-learning/blogs/vue3-resource/core/4.html" class="prev">
            Vue3组件渲染 - 完整的DOM Diff 流程(一)
          </a></span> <span class="next"><a href="/my-front-end-learning/blogs/vue3-resource/compositionAPI/1.html">
            Vue3Setup - 组件渲染前的初始化过程入口
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#例子" class="sidebar-link reco-side-例子" data-v-70334359>例子</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#例1" class="sidebar-link reco-side-例1" data-v-70334359>例1</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#例2" class="sidebar-link reco-side-例2" data-v-70334359>例2</a></li><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#同步头部节点" class="sidebar-link reco-side-同步头部节点" data-v-70334359>同步头部节点</a></li><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#同步尾部节点" class="sidebar-link reco-side-同步尾部节点" data-v-70334359>同步尾部节点</a></li><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#添加新节点" class="sidebar-link reco-side-添加新节点" data-v-70334359>添加新节点</a></li><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#删除多余节点" class="sidebar-link reco-side-删除多余节点" data-v-70334359>删除多余节点</a></li><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#处理未知子序列" class="sidebar-link reco-side-处理未知子序列" data-v-70334359>处理未知子序列</a></li><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#移动子节点" class="sidebar-link reco-side-移动子节点" data-v-70334359>移动子节点</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#建立索引图" class="sidebar-link reco-side-建立索引图" data-v-70334359>建立索引图</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#更新和移除旧节点" class="sidebar-link reco-side-更新和移除旧节点" data-v-70334359>更新和移除旧节点</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#移动和挂载新节点" class="sidebar-link reco-side-移动和挂载新节点" data-v-70334359>移动和挂载新节点</a></li><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#计算最长递增子序列" class="sidebar-link reco-side-计算最长递增子序列" data-v-70334359>计算最长递增子序列</a></li><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#normalizevnode" class="sidebar-link reco-side-normalizevnode" data-v-70334359>normalizeVNode</a></li><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/vue3-resource/core/5.html#总结" class="sidebar-link reco-side-总结" data-v-70334359>总结</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/my-front-end-learning/assets/js/app.0297fef0.js" defer></script><script src="/my-front-end-learning/assets/js/3.e58151dc.js" defer></script><script src="/my-front-end-learning/assets/js/1.a31d2227.js" defer></script><script src="/my-front-end-learning/assets/js/5.d0775db2.js" defer></script>
  </body>
</html>
