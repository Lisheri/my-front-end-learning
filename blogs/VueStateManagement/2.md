---
title: Vue状态管理-组件内的状态管理流程
date: 2022-08-27
tags:
    - vue
categories:
    - vuex
---

# 组件内的状态管理流程

Vue中最核心的两个功能, 分别是数据驱动和组件化。

使用基于组件化的开发可以提供开发效率, 带来更好的可维护性

## 一段最简单的组件

```ts
new Vue({
  // state
  data() {
    return {
      count: 0
    }
  },
  // view
  template: `<div>{{ count }}</div>`,
  // actions
  methods: {
    increment() {
      this.count++
    }
  }
})
```

每个组件内部都有自己的数据，模板和方法

所谓数据, 其实就是`状态`, 每个组件都可以管理自己的内部状态

模板也可以称之为`视图`, 同时将状态绑定到视图上, 呈现给用户

当用户和视图交互时, 可能会更改状态, 比如点击按钮让count发生变化

当状态发生变化时, 会自动更新视图

更改状态的方法, 可以称之为`actions`, 也就是行为

> 这里所描述的是单个组件内的状态管理, 在实际过程中, 可能多个组件都要共享状态
> 
> 所谓的状态管理, 其实就是通过状态集中管理和分发, 解决多个组件共享状态的问题

## 状态管理的组成

+ state, 驱动应用的数据源
+ view, 以声明方式将state映射到视图上
+ actions, 相应在view上的用户输入导致的状态变化(改变状态的方式)

数据通常是单项流动的, 通常是state状态数据, 绑定到视图上, 展示给用户, 当用户和视图交互, 通过actions, 更改数据后, 在将数据更新到视图上

也就是 `state -> view -> actions -> state` 形成一个闭环

单项数据流非常清晰, 但是多个组件共享数据时, 会破坏这种简单的结构

## 组件间通信方式回顾

大多数情况下, 组件都不是孤立存在的, 基本上都需要协作, 共同构成一个复杂的业务功能

### 父传子
+ 子组件通过props接收数据
+ 父组件中给子组件通过相应属性传值
+ provide/inject
+ 儿子访问this.$parent
### 子传父
+ emits触发事件, 以参数形式传递给爹
+ props传递一个函数, 同样以参数的形式回传
+ 爹访问this.$children寻找子组件, 直接访问子组件的数据
+ 爹访问this.$refs.xxx直接访问子组件的数据
### 不相关
+ eventBus(发布订阅器)
+ Vuex(状态管理总线)

### 其他常见方式
+ $root获取根节点状态和方法
+ $parent获取爹的状态和方法
+ $children获取儿子的状态和方法
+ $refs: 
  - HTML标签上是DOM对象
  - 组件标签上获取的是组件实例 

## 简易的状态管理方案

多个组件互相传值, 如果使用上述方式, 难以跟踪状态变化

会有如下问题:

+ 多个视图依赖同一状态
+ 来自不同视图的行为需要变更同一状态

### 多个组件共享状态的方案

可以将多个组件的状态, 或整个程序的状态, 放到集中的位置存储, 并且可以检测到数据的更改, 这里做一个简易的实现

#### store.js
```ts
export default {
  debug: true,
  state: {
    user: {
      name: 'xiaomo',
      age: 18,
      sex: '男'
    }
  },
  setUserNameAction(name: string) {
    if (this.debug) {
      console.info('setUserNameAction triggered: ', name);
    }
    this.state.user.name = name;
  }
}
```

状态用于存储数据

actions用于更新状态

debug属性主要用于调试, 如果为true, 通过actions修改数据会打印日志

所有的状态都可以在这里管理, 并且可以记录状态的变化

> 这个store可以导入到任何一个组件中使用, 但是需要将state合并到组件的data中, 使其作为一个响应式对象
> 
> 但是这里要做一个约定, 不允许直接更新store中的元素
> 
> 他是一个简易的状态集中管理工具, 和vuex很像, 但是vuex包含了更多的功能



