<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>addEntry 流程分析 | 小莫的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/my-front-end-learning/favicon.ico">
    <meta name="description" content="冲">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/my-front-end-learning/assets/css/0.styles.a5fc1f3a.css" as="style"><link rel="preload" href="/my-front-end-learning/assets/js/app.9bd16e75.js" as="script"><link rel="preload" href="/my-front-end-learning/assets/js/3.1cdc23f6.js" as="script"><link rel="preload" href="/my-front-end-learning/assets/js/1.ee48205b.js" as="script"><link rel="preload" href="/my-front-end-learning/assets/js/76.d71416ff.js" as="script"><link rel="prefetch" href="/my-front-end-learning/assets/js/10.569457ea.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/100.ec606b50.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/101.decd8e3b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/102.b2eccf3c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/103.9996dece.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/104.baf717b0.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/105.f4997020.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/106.7557b7fe.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/107.5e256c65.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/108.8e0e6be7.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/109.7389767c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/11.64ed23aa.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/110.22e0cb23.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/111.641a34ec.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/112.366a2594.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/113.fc579a72.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/114.9e248fe2.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/115.639ad140.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/116.cde5f2d6.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/117.ec842b2d.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/118.8a2e6e33.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/119.1d1a93d8.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/12.f6fe81b9.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/120.556ab9ee.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/121.2692137b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/122.c6faaddb.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/123.63089dd2.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/124.6247c9b4.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/125.de03d541.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/126.8bd4681a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/127.48e74bc7.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/128.5a271251.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/129.318792f0.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/13.eb02ce45.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/130.901498f0.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/131.0b27d688.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/132.c0409080.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/133.35b14e5c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/134.ff038701.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/135.c58c861f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/136.91004152.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/137.b64d3d8d.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/138.7a1e38c8.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/139.9dd5202e.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/14.fe5550e8.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/140.f675bfee.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/141.5ba8e666.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/142.63b52f72.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/143.e6653d53.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/144.c23c9782.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/145.b09725ea.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/15.86f415e3.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/16.b5ee1f9a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/17.98b58235.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/18.d0b232ab.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/19.3be75595.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/20.e0b2c8fc.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/21.9f459827.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/22.a8e40c0c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/23.dd66c140.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/24.f074eab1.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/25.815c109d.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/26.14cfa8d4.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/27.76ef375c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/28.b1ec18de.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/29.2c3861c7.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/30.aacf0792.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/31.7eb7a8cb.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/32.e6d4d991.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/33.719da81d.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/34.8f48de2d.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/35.30b6eda0.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/36.99aca73d.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/37.171015ea.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/38.fc7b4743.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/39.45c1a6ea.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/4.c76e9fd8.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/40.0d099460.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/41.31c9b7c1.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/42.ce73b91f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/43.c93519c5.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/44.4f5b9336.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/45.4919693b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/46.77255ab7.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/47.be6d3863.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/48.6280ae14.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/49.0f414325.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/5.b51f4daa.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/50.15216606.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/51.5f2bc460.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/52.68d6bb36.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/53.58d1ef3c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/54.f6b06e79.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/55.6bd51a4a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/56.8a20d711.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/57.b5eff73c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/58.5274a03c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/59.3c32f14a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/6.95c918c6.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/60.943e631a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/61.d30216d2.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/62.397d92cf.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/63.959e4bd4.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/64.d11f44e6.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/65.7b713885.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/66.b3f8f034.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/67.657248a0.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/68.73424efe.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/69.edd43171.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/7.ca0f25d7.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/70.302e3381.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/71.c72aa6bf.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/72.92cc2b03.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/73.cd2ae2bd.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/74.381abb3a.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/75.9c094e74.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/77.4d642787.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/78.0223226c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/79.c8f84b25.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/8.706f2b80.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/80.3fa78e78.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/81.f844511d.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/82.139e71d4.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/83.aa81a1a4.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/84.c39b85b6.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/85.b36b1ce9.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/86.c5488cdb.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/87.f10494bf.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/88.c86ac42f.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/89.e2be317b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/9.24be78c4.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/90.77ed567c.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/91.1e63cdea.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/92.462ef1a9.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/93.4e41321b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/94.8b549e2d.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/95.653eb48b.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/96.715b9904.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/97.40bc3095.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/98.ae8e42fa.js"><link rel="prefetch" href="/my-front-end-learning/assets/js/99.aacf8cb4.js">
    <link rel="stylesheet" href="/my-front-end-learning/assets/css/0.styles.a5fc1f3a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>小莫的博客</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>冲</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Lisher</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-front-end-learning/" class="home-link router-link-active"><img src="/my-front-end-learning/logo.png" alt="小莫的博客" class="logo"> <span class="site-name">小莫的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-front-end-learning/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/ECMAScript6/" class="nav-link"><i class="undefined"></i>
  ECMAScript6
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/函数式编程/" class="nav-link"><i class="undefined"></i>
  函数式编程
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS异步编程/" class="nav-link"><i class="undefined"></i>
  JS异步编程
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/前端工程化/" class="nav-link"><i class="undefined"></i>
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/前端规范化标准/" class="nav-link"><i class="undefined"></i>
  前端规范化标准
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/webpack源码解析/" class="nav-link"><i class="undefined"></i>
  webpack源码解析
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/微前端/" class="nav-link"><i class="undefined"></i>
  微前端
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/qiankun源码/" class="nav-link"><i class="undefined"></i>
  qiankun源码
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/小程序/" class="nav-link"><i class="undefined"></i>
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS性能/" class="nav-link"><i class="undefined"></i>
  JS性能
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS类型系统/" class="nav-link"><i class="undefined"></i>
  JS类型系统
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/TypeScript/" class="nav-link"><i class="undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/Vue源码/" class="nav-link"><i class="undefined"></i>
  Vue源码
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/vue基础/" class="nav-link"><i class="undefined"></i>
  vue基础
</a></li></ul></div></div><div class="nav-item"><a href="/my-front-end-learning/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/my-front-end-learning/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Lisheri" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  myGitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/my-front-end-learning/Lisher.jpeg" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    Lisher
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>134</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>22</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/my-front-end-learning/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/ECMAScript6/" class="nav-link"><i class="undefined"></i>
  ECMAScript6
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/函数式编程/" class="nav-link"><i class="undefined"></i>
  函数式编程
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS异步编程/" class="nav-link"><i class="undefined"></i>
  JS异步编程
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/前端工程化/" class="nav-link"><i class="undefined"></i>
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/前端规范化标准/" class="nav-link"><i class="undefined"></i>
  前端规范化标准
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/webpack源码解析/" class="nav-link"><i class="undefined"></i>
  webpack源码解析
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/微前端/" class="nav-link"><i class="undefined"></i>
  微前端
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/qiankun源码/" class="nav-link"><i class="undefined"></i>
  qiankun源码
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/小程序/" class="nav-link"><i class="undefined"></i>
  小程序
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS性能/" class="nav-link"><i class="undefined"></i>
  JS性能
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/JS类型系统/" class="nav-link"><i class="undefined"></i>
  JS类型系统
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/TypeScript/" class="nav-link"><i class="undefined"></i>
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/Vue源码/" class="nav-link"><i class="undefined"></i>
  Vue源码
</a></li><li class="dropdown-item"><!----> <a href="/my-front-end-learning/categories/vue基础/" class="nav-link"><i class="undefined"></i>
  vue基础
</a></li></ul></div></div><div class="nav-item"><a href="/my-front-end-learning/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/my-front-end-learning/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Lisheri" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  myGitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模块化开发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack打包</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Rollup上手</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Parcel上手</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>规范化标准</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>webpack源码阅读</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/1.html" class="sidebar-link">打包后文件分析</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/2.html" class="sidebar-link">CommonJS模块与ES Module模块打包</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/3.html" class="sidebar-link">手写功能函数实现</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/4.html" class="sidebar-link">手写功能函数实现(webpack4.x)</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/5.html" class="sidebar-link">懒加载实现流程</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/6.html" class="sidebar-link">懒加载源码分析</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/7.html" class="sidebar-link">懒加载核心源码(4.x版本)</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/8.html" class="sidebar-link">webpack与tapable</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/9.html" class="sidebar-link">SyncHook 源码分析</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/10.html" class="sidebar-link">手写 SyncHook</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/11.html" class="sidebar-link">AsyncParallelHook 源码分析</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/12.html" class="sidebar-link">定位 webpack 打包入口</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/13.html" class="sidebar-link">编译主流程分析</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/14.html" class="sidebar-link">手写webpack.js</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/15.html" class="sidebar-link">EntryOptionPlugin(解析入口文件的插件) 分析</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/16.html" class="sidebar-link">EntryOptionPlugin(解析入口文件的插件) 手写实现</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/17.html" class="sidebar-link">run 方法分析与实现</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/18.html" class="sidebar-link">compile分析与实现</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/19.html" class="sidebar-link">make触发前 流程回顾</a></li><li><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html" aria-current="page" class="active sidebar-link">addEntry 流程分析</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>addEntry 流程分析</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Lisher</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2022
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">addEntry 流程分析</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>Lisher</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>8/23/2021</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>webpack</span><span class="tag-item" data-v-1ff7123e>webpackSource</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="addentry-流程分析"><a href="#addentry-流程分析" class="header-anchor">#</a> addEntry 流程分析</h1> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// compiler.run</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	logger<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;make hook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

	logger<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;finish make hook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>finishMake<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;finish make hook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

		process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			logger<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;finish compilation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			compilation<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;finish compilation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

				logger<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;seal compilation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				compilation<span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					logger<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;seal compilation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

					logger<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;afterCompile hook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						logger<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;afterCompile hook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// EntryPlugin.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> entry<span class="token punctuation">,</span> options<span class="token punctuation">,</span> context <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dep <span class="token operator">=</span> EntryPlugin<span class="token punctuation">.</span><span class="token function">createDependency</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;EntryPlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	compilation<span class="token punctuation">.</span><span class="token function">addEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dep<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><ol><li>接着前面的总结, make 走姿在触发的时候, 接收到了 compilation 实例对象</li> <li>整个程序就是在一个逻辑中让模块从入口进去, 经过webpack处理完成后从出口流出的一个过程, 所以数据和逻辑一定要明白, 代码实现反复看就可以了</li> <li>从 compilation 中解构出了三个值：</li></ol> <ul><li>entry: 当前需要被打包的模块的相对路径</li> <li>options: 之前通过一个函数组装的options, 入口模块除了name, 都是undefined</li> <li>context: 当前项目的根路径</li></ul> <ol start="4"><li>dep 是对当前入口模块中的依赖关系进行处理</li> <li>接着才是make钩子回调, 调用 <code>addEntry</code> 方法</li></ol> <h2 id="addentry-方法"><a href="#addentry-方法" class="header-anchor">#</a> addEntry 方法</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">addEntry</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> optionsOrName<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里主要是确定 optionsOrName是不是一个对象, 一般我们这里传入的是一个对象, 组装的时候除了name, 都是undefined</span>
  <span class="token comment">// 如果不是一个对象, 则转成一个对象, 然后将该值赋值给 name 属性</span>
  <span class="token comment">// 主要是为了统一数据结构</span>
  <span class="token comment">// 这里的 entry 是 上述的dep(它其实就是入口依赖), 作用是处理当前入口模块中的依赖关系, 内部包含有入口模块的相对路径</span>
	<span class="token comment">// TODO webpack 6 remove, 这个是说webpack6将移除这个options</span>
	<span class="token keyword">const</span> options <span class="token operator">=</span>
		<span class="token keyword">typeof</span> optionsOrName <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span>
			<span class="token operator">?</span> optionsOrName
			<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> optionsOrName <span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addEntryItem</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> <span class="token string">&quot;dependencies&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">_addEntryItem</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> target<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将name结构出来</span>
	<span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token comment">// 对于入口模块, 初次走到这里的时候, name是有东西的, 但是 this.entries.get(name)取不到任何东西, 因此这个entryData是一个undefined</span>
	<span class="token keyword">let</span> entryData <span class="token operator">=</span>
		name <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalEntry<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>entryData <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因此会直接进入这里</span>
		entryData <span class="token operator">=</span> <span class="token punctuation">{</span>
			dependencies<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 内部会加入入口依赖</span>
			includeDependencies<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 最终是一个空数组</span>
			options<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 最终结果和外面的options一样, 除了name, 都是空数组</span>
				name<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
				<span class="token operator">...</span>options
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		entryData<span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 为 entries 这个map数据结构, 添加一个键名为入口模块id, 键值为 entryData的值</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> entryData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		entryData<span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>entryData<span class="token punctuation">.</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>
				Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>entryData<span class="token punctuation">.</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
				Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
				<span class="token function">arrayEquals</span><span class="token punctuation">(</span>entryData<span class="token punctuation">.</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>entryData<span class="token punctuation">.</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				entryData<span class="token punctuation">.</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>
					<span class="token keyword">new</span> <span class="token class-name">WebpackError</span><span class="token punctuation">(</span>
						<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Conflicting entry option </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>entryData<span class="token punctuation">.</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> vs </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
					<span class="token punctuation">)</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

  <span class="token comment">// 触发 addEntry钩子, 传入 entry 和 options</span>
  <span class="token comment">// 注意, 这里的 addEntry 钩子是 compilation 的钩子</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">addEntry</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 紧接着执行 addModuleTree 方法, 作用就是生成一个模块树</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addModuleTree</span><span class="token punctuation">(</span>
		<span class="token punctuation">{</span>
			context<span class="token punctuation">,</span>
			dependency<span class="token operator">:</span> entry<span class="token punctuation">,</span>
			contextInfo<span class="token operator">:</span> entryData<span class="token punctuation">.</span>options<span class="token punctuation">.</span>layer
				<span class="token operator">?</span> <span class="token punctuation">{</span> issuerLayer<span class="token operator">:</span> entryData<span class="token punctuation">.</span>options<span class="token punctuation">.</span>layer <span class="token punctuation">}</span>
				<span class="token operator">:</span> <span class="token keyword">undefined</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">failedEntry</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> options<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">succeedEntry</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> options<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">addModuleTree</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> context<span class="token punctuation">,</span> dependency<span class="token punctuation">,</span> contextInfo <span class="token punctuation">}</span><span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 接着就走到这里, context 是绝对路径, dependency 就是上面的dep(入口模块依赖), contextInfo是undefined</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>
			<span class="token keyword">typeof</span> dependency <span class="token operator">!==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span>
			dependency <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span>
			<span class="token operator">!</span>dependency<span class="token punctuation">.</span>constructor
		<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里不会进去, 直接过</span>
			<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>
				<span class="token keyword">new</span> <span class="token class-name">WebpackError</span><span class="token punctuation">(</span><span class="token string">&quot;Parameter 'dependency' must be a Dependency&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 这个 dependency, 就是外面的dep, 他是属于EntryDependency这个类的一个实例</span>
    <span class="token comment">// 因此这里就得到了这个类(实例的constructor指向创建实例的类), 也就是所谓的 EntryPlugin 类</span>
		<span class="token keyword">const</span> Dep <span class="token operator">=</span> <span class="token comment">/** @type {DepConstructor} */</span> <span class="token punctuation">(</span>dependency<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这个就是所谓的模块工厂</span>
    <span class="token comment">// 前面说过, 如果要加载一个模块, 首先要先去创建一个模块, 然后再生成的模块内部, 再去定义需要加载的模块就可以了</span>
    <span class="token comment">// 这里就会得到一个工厂模块</span>
    <span class="token comment">// 这个 dependencyFactories , 在 EntryPlugin 那个位置, 定义了一个compilation钩子, 这个钩子触发的时候, 回调函数里面</span>
    <span class="token comment">// 就会给 compilation.dependencyFactories, 设置一个键名为 `EntryDependency类`, 键值就是前面说的 `normalModuleFactory`</span>
    <span class="token comment">// 所以说这个 moduleFactory 就是前面的 normalModuleFactory </span>
    <span class="token comment">// 于是乎后续就是要利用这个 normalModuleFactory 来创建一个普通的模块对象</span>
		<span class="token keyword">const</span> moduleFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dependencyFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>moduleFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>
				<span class="token keyword">new</span> <span class="token class-name">WebpackError</span><span class="token punctuation">(</span>
					<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No dependency factory available for this dependency type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dependency<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
				<span class="token punctuation">)</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleModuleCreation</span><span class="token punctuation">(</span>
			<span class="token punctuation">{</span>
				factory<span class="token operator">:</span> moduleFactory<span class="token punctuation">,</span>
				dependencies<span class="token operator">:</span> <span class="token punctuation">[</span>dependency<span class="token punctuation">]</span><span class="token punctuation">,</span>
				originModule<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
				contextInfo<span class="token punctuation">,</span>
				context
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>buildQueue<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>rebuildQueue<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>processDependenciesQueue<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>factorizeQueue<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token function">handleModuleCreation</span><span class="token punctuation">(</span>
		<span class="token parameter"><span class="token punctuation">{</span>
			factory<span class="token punctuation">,</span>
			dependencies<span class="token punctuation">,</span>
			originModule<span class="token punctuation">,</span>
			contextInfo<span class="token punctuation">,</span>
			context<span class="token punctuation">,</span>
			recursive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
			connectOrigin <span class="token operator">=</span> recursive
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		callback</span>
	<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 生成了一个模块图, 具体做什么用还不知道</span>
    <span class="token comment">// 里面有一些私有变量, 暂时全是undefined, 还有一些空的map数据结构, 当然, 全是私有变量</span>
		<span class="token keyword">const</span> moduleGraph <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>moduleGraph<span class="token punctuation">;</span>
    
    <span class="token comment">// this.profile是false, 因此这个值是undefined</span>
		<span class="token keyword">const</span> currentProfile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>profile <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ModuleProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

    <span class="token comment">// 紧接着会直接进入这里面</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">factorizeModule</span><span class="token punctuation">(</span>
			<span class="token punctuation">{</span>
				currentProfile<span class="token punctuation">,</span>
				factory<span class="token punctuation">,</span>
				dependencies<span class="token punctuation">,</span>
				originModule<span class="token punctuation">,</span>
				contextInfo<span class="token punctuation">,</span>
				context
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> newModule</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        <span class="token comment">// 此时的 newModule 就是 createModule(始终应该记住这个是loader产生的结果, 还没有开始编译成转换后的入口模块呢)</span>
        <span class="token comment">// 真正的创建module, 是通过这个addModule方法的执行, 才是真正的开始创建入口模块</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">(</span>newModule<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">.</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							err<span class="token punctuation">.</span>module <span class="token operator">=</span> module<span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dependencies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">const</span> dependency <span class="token operator">=</span> dependencies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
						moduleGraph<span class="token punctuation">.</span><span class="token function">setResolvedModule</span><span class="token punctuation">(</span>
							connectOrigin <span class="token operator">?</span> originModule <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
							dependency<span class="token punctuation">,</span>
							module
						<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					moduleGraph<span class="token punctuation">.</span><span class="token function">setIssuerIfUnset</span><span class="token punctuation">(</span>
						module<span class="token punctuation">,</span>
						originModule <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> originModule <span class="token operator">:</span> <span class="token keyword">null</span>
					<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>module <span class="token operator">!==</span> newModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>currentProfile <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">const</span> otherProfile <span class="token operator">=</span> moduleGraph<span class="token punctuation">.</span><span class="token function">getProfile</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>otherProfile <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								currentProfile<span class="token punctuation">.</span><span class="token function">mergeInto</span><span class="token punctuation">(</span>otherProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
								moduleGraph<span class="token punctuation">.</span><span class="token function">setProfile</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> currentProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>

					<span class="token comment">// Check for cycles when build is trigger inside another build</span>
					<span class="token keyword">let</span> creatingModuleDuringBuildSet <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>recursive <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildQueue<span class="token punctuation">.</span><span class="token function">isProcessing</span><span class="token punctuation">(</span>originModule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">// Track build dependency</span>
						creatingModuleDuringBuildSet <span class="token operator">=</span>
							<span class="token keyword">this</span><span class="token punctuation">.</span>creatingModuleDuringBuild<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>originModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>creatingModuleDuringBuildSet <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							creatingModuleDuringBuildSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">this</span><span class="token punctuation">.</span>creatingModuleDuringBuild<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
								originModule<span class="token punctuation">,</span>
								creatingModuleDuringBuildSet
							<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						creatingModuleDuringBuildSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>originModule<span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token comment">// When building is blocked by another module</span>
						<span class="token comment">// search for a cycle, cancel the cycle by throwing</span>
						<span class="token comment">// an error (otherwise this would deadlock)</span>
						<span class="token keyword">const</span> blockReasons <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>creatingModuleDuringBuild<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>blockReasons <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>blockReasons<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> set<span class="token punctuation">)</span> <span class="token punctuation">{</span>
								<span class="token keyword">const</span> blockReasons <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>creatingModuleDuringBuild<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token keyword">if</span> <span class="token punctuation">(</span>blockReasons <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
									<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> m <span class="token keyword">of</span> blockReasons<span class="token punctuation">)</span> <span class="token punctuation">{</span>
										<span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">===</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
											<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BuildCycleError</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
										<span class="token punctuation">}</span>
										set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
									<span class="token punctuation">}</span>
								<span class="token punctuation">}</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>creatingModuleDuringBuildSet <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							creatingModuleDuringBuildSet<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">.</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
								err<span class="token punctuation">.</span>module <span class="token operator">=</span> module<span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
							<span class="token keyword">this</span><span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

							<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>

						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>recursive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processModuleDependenciesNonRecursive</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">return</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>

						<span class="token comment">// This avoids deadlocks for circular dependencies</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processDependenciesQueue<span class="token punctuation">.</span><span class="token function">isProcessing</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>

						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processModuleDependencies</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
								<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
							<span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token function">factorizeModule</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// factorizeQueue 是AsyncQueue 的实例</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>factorizeQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token comment">// AsyncQueue.js 的 add方法</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_stopped<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpackError</span><span class="token punctuation">(</span><span class="token string">&quot;Queue was stopped&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行 beforeAdd 钩子, 由于没有挂在函数, 将直接进入回调中</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeAdd<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
      <span class="token comment">// item 就是上面传入 factorizeModule 的 options, 主要值是</span>
      <span class="token comment">/* 
        {
				  currentProfile: undefined,
				  factory: normalModuleFactory 普通模块工厂,
				  dependencies: 从 make钩子触发的位置传入的dependency实例, 是一个数组, 只有一个成员, 就是该实例,
				  originModule: null,
				  contextInfo: undefined,
				  context: 打包入口绝对路径
			  },
       */</span>
      <span class="token comment">// 这个_getKey是一个私有方法(_开头的都代表私有方法), 是初始化AsyncQueue实例的时候传入构造函数的, 如果没有传入, 那么就是undefined</span>
      <span class="token comment">// 这个add方法是由 factorizeQueue 触发, 初始化的时候并没有传入, 因此是 item =&gt; item, key值就是item本身</span>
			<span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getKey</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// this._entries在这里是一个空的map, 因此这个entry是undefined</span>
      <span class="token comment">// ? 前面有一个不是undefined, 那个是compilation.entries, 有一个键名为main的数据</span>
			<span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">DONE_STATE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>inHandleResult<span class="token operator">++</span> <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>error<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						<span class="token function">callback</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>error<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					inHandleResult<span class="token operator">--</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>callbacks <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					entry<span class="token punctuation">.</span>callbacks <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					entry<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
      <span class="token comment">// 将item和callback都集成到了newEntry上, {item: item, callback: callback, callbacks: undefined, result: undefined, error: undefined, state: 0}</span>
			<span class="token keyword">const</span> newEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncQueueEntry</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_stopped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// false 不会进来</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">added</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>_root<span class="token punctuation">.</span>_activeTasks<span class="token operator">++</span><span class="token punctuation">;</span>
				process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_handleResult</span><span class="token punctuation">(</span>newEntry<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WebpackError</span><span class="token punctuation">(</span><span class="token string">&quot;Queue was stopped&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 走这里</span>
        <span class="token comment">// 为_entries添加一个成员, key是老的entry, 也就是item, 也是newEntry.item, 值是newEntry实例</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>_entries<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里是一个入队操作, 维系了一个队列 _queued(内部有一个_list用于表示该队列)</span>
        <span class="token comment">// 其实可以看到, 这个 `newEntry` 基本上就是后面生成入口模块所依赖的一个非常重要的数据了</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>_queued<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>newEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这个_root 其实是 另一个 AsyncQueue实例, 只不过getKey和processor不同, 是Compilation.addModuleQueue._root, 其实是 processDependenciesQueue</span>
				<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_root<span class="token punctuation">;</span>
        <span class="token comment">// 状态设置为true, 后续应该用于控制什么</span>
				root<span class="token punctuation">.</span>_needProcessing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>_willEnsureProcessing <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 进来</span>
          <span class="token comment">// 将状态修改为true</span>
					root<span class="token punctuation">.</span>_willEnsureProcessing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token comment">// 这里不会立即进去</span>
          <span class="token comment">// 这个函数只有addModuleQueue的实例身上才有, 在 factorizeQueue 上是undefined</span>
          <span class="token comment">// 这是利用了node的事件循环, 并不会立即触发执行, 要等待run钩子的回调执行完全退出后, 才会触发该函数</span>
					<span class="token function">setImmediate</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>_ensureProcessing<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
        <span class="token comment">// 执行触发added钩子, 这里不会触发, 因为没有挂载过, 也没有回调函数</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">added</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token function">_ensureProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 一个代表激活数量, 一个代表并行数量, 初始值为 0 和 100</span>
    <span class="token comment">// 这里主要是一个进程的控制</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_activeTasks <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_parallelism<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这个this代表的是 processDependenciesQueue, 因此他的 _queued是空的</span>
      <span class="token comment">// 这里是一个undefined, 将会直接退出循环</span>
			<span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_queued<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>_activeTasks<span class="token operator">++</span><span class="token punctuation">;</span>
			entry<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PROCESSING_STATE</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_startProcessing</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_willEnsureProcessing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_queued<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// processDependenciesQueue._children, 经过 addModuleQueue, factorizeQueue, buildQueue中对root.children的扩展, 一共有三个, 就是这三个</span>
    <span class="token comment">// 具体逻辑见下方</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_children <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 第一个child 是 addModule, 实例对象上的 _queued中并没有数据, 因此会直接进入下一次循环</span>
        <span class="token comment">// 第二个child 是上面主要走的 factorizeModule, 将会拿到一个entry, 这里面包含了入口模块的所有信息, 包括前面层层扩展的 callback(基于onCompiled)</span>
				<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_activeTasks <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_parallelism<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">const</span> entry <span class="token operator">=</span> child<span class="token punctuation">.</span>_queued<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token comment">// 这个表示已经有一个激活的任务了, 最高支持100个</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>_activeTasks<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token comment">// 将入口模块的状态修改为 1, 表示正在执行中</span>
					entry<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PROCESSING_STATE</span><span class="token punctuation">;</span>
          <span class="token comment">// 开始执行</span>
					child<span class="token punctuation">.</span><span class="token function">_startProcessing</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>_queued<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_willEnsureProcessing<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_needProcessing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token comment">// 执行生成入口文件相关的逻辑</span>
  <span class="token function">_startProcessing</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 触发 beforeStart的钩子</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeStart<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>item<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
      <span class="token comment">// 没有监听触发, 将进入回调函数</span>
			<span class="token keyword">let</span> inCallback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// factorizeQueue._processor 就是 compilation._factorizeModule 方法, 方法内部this指向compilation实例</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_processor</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>item<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// _factorizeModule执行后的callback, 就回到这里</span>
					inCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token comment">// 这里entry是处理前的入口模块, r是 createModule</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_handleResult</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> e<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>inCallback<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_handleResult</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> err<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
      <span class="token comment">// started默认是没有被监听的, 因此这里并不会触发回调</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">started</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token function">_factorizeModule</span><span class="token punctuation">(</span>
		<span class="token parameter"><span class="token punctuation">{</span>
			currentProfile<span class="token punctuation">,</span>
			factory<span class="token punctuation">,</span>
			dependencies<span class="token punctuation">,</span>
			originModule<span class="token punctuation">,</span>
			contextInfo<span class="token punctuation">,</span>
			context
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		callback</span>
	<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 直接过</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>currentProfile <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			currentProfile<span class="token punctuation">.</span><span class="token function">markFactoryStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 核心到了</span>
		factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
			<span class="token punctuation">{</span>
				contextInfo<span class="token operator">:</span> <span class="token punctuation">{</span>
					issuer<span class="token operator">:</span> originModule <span class="token operator">?</span> originModule<span class="token punctuation">.</span><span class="token function">nameForCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
					issuerLayer<span class="token operator">:</span> originModule <span class="token operator">?</span> originModule<span class="token punctuation">.</span>layer <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
					compiler<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
					<span class="token operator">...</span>contextInfo
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				resolveOptions<span class="token operator">:</span> originModule <span class="token operator">?</span> originModule<span class="token punctuation">.</span>resolveOptions <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
				context<span class="token operator">:</span> context
					<span class="token operator">?</span> context
					<span class="token operator">:</span> originModule
					<span class="token operator">?</span> originModule<span class="token punctuation">.</span>context
					<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>context<span class="token punctuation">,</span>
				dependencies<span class="token operator">:</span> dependencies
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从create方法最后一步的callback触发, 将会进入此处</span>
        <span class="token comment">// result 就是组合了三种依赖的 createModule</span>
        <span class="token comment">// 此时入创建模块所需要的东西就准备好了</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 将依赖取出来, 这三个都是长度为0的 lazySet(这个lazySet之前出现的时候说过, 是webpack自己定义的数据结构)</span>
					<span class="token keyword">const</span> <span class="token punctuation">{</span> fileDependencies<span class="token punctuation">,</span> contextDependencies<span class="token punctuation">,</span> missingDependencies <span class="token punctuation">}</span> <span class="token operator">=</span>
						result<span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>fileDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 实际上就是将 fileDependencies._toDeppMerge这个数组中push进去了他自己</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>fileDependencies<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>fileDependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>contextDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里没有东西需要加入到上下文依赖中, 会直接返回</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>contextDependencies<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>contextDependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>missingDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里仍然是往 compilation.missingDependencies._toDeepMerge推入一个 missingDependencies</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>missingDependencies<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>missingDependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
        <span class="token comment">// 将createModule 用 newModule存储起来</span>
				<span class="token keyword">const</span> newModule <span class="token operator">=</span> result<span class="token punctuation">.</span>module<span class="token punctuation">;</span>

        <span class="token comment">// 执行callback, 这个callback是执行_factorizeModule时传入的</span>
        <span class="token comment">// 而 _factorizeModule 又是在初始化 factorizeQueue实例时, 挂载到了实例的_processor上</span>
        <span class="token comment">// 同时 _startProcessing 中触发 beforeStart钩子的回调, 进而继续向下, 触发这个 _processor</span>
        <span class="token comment">// 而这个callback, 就是上述的 _processor出发时传入的回调函数, 也就是 _factorizeModule 的callback</span>
        <span class="token comment">// 因此下一步将进入 _startProcessing 中触发 _processor 的回调函数中, 继续执行</span>
				<span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br></div></div><h3 id="factorizequeue-queued"><a href="#factorizequeue-queued" class="header-anchor">#</a> factorizeQueue._queued</h3> <p>是factorizeQueue实例(AsyncQueue实例)内部维系的一个队列, 主要有两个成员, 一个是<code>_list</code>, 用于表示维系的队列, 一个是<code>_listReversed</code>, 用于表示反转队列</p> <p>上面的<code>enqueue</code>方法, 主要就是往<code>_list</code>中添加成员</p> <p>最终的方法如下:</p> <ol><li>入队</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// * 入队</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="2"><li>出队</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// * 出队</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_listReversed<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这个判断说明, 没有任何东西在队列里面, 直接出去返回一个undefined</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果只有一个, 就把这个取出来就好</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果有多个并且在限制范围内(16个以内), 队列是先进先出, 因此从前面开始取</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 有点迷, 下面的操作, 就结果而言, 是取出去了一个, 但是list变成了空数组, listReverse变成了list的反转</span>
		<span class="token keyword">const</span> temp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_listReversed<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_listReversed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_listReversed<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_list <span class="token operator">=</span> temp<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_listReversed<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="asyncqueue的-root和-children逻辑"><a href="#asyncqueue的-root和-children逻辑" class="header-anchor">#</a> AsyncQueue的_root和_children逻辑</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>_root <span class="token operator">=</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>_root <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_root<span class="token punctuation">.</span>_children <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_root<span class="token punctuation">.</span>_children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_root<span class="token punctuation">.</span>_children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>从这里可以看出, 实际上每一个_root实际上就是第一个AsyncQueue实例, 也就是 <code>processDependencies</code></p> <p>而每一个child, 都是带有parent生成实例的那一个实例本身, 也就是后面进去的 <code>addModule</code>, <code>factorize</code> 和 <code>build</code></p> <p>这也是为什么, 可以将 <code>_ensureProcessing</code>放到最后来执行, 前面所有的都是扩展callback等, 而通过  <code>processDependencies</code>来调度所有的实例, 最终完成入口模块的生成工作</p> <h3 id="模块数据-最终合成包含了callback的数据-的state"><a href="#模块数据-最终合成包含了callback的数据-的state" class="header-anchor">#</a> 模块数据(最终合成包含了callback的数据)的state</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">QUEUED_STATE</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PROCESSING_STATE</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">DONE_STATE</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>0表示处在队列中</li> <li>1表示正在执行</li> <li>2表示执行完成</li></ul> <h3 id="modulefactory-create方法"><a href="#modulefactory-create方法" class="header-anchor">#</a> moduleFactory.create方法</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这个数组内部就一个成员, 就是之前的入口模块依赖</span>
	<span class="token keyword">const</span> dependencies <span class="token operator">=</span> <span class="token comment">/** @type {ModuleDependency[]} */</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>unsafeCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里要进来, 条件为true</span>
    <span class="token comment">// 目前来说并没有缓存的入口, 因此是undefined</span>
		<span class="token keyword">const</span> cacheEntry <span class="token operator">=</span> unsafeCacheDependencies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cacheEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token punctuation">{</span> module <span class="token punctuation">}</span> <span class="token operator">=</span> cacheEntry<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_restoredUnsafeCacheEntries<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> data <span class="token operator">=</span> unsafeCacheData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
				module<span class="token punctuation">.</span><span class="token function">restoreFromUnsafeCache</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>_restoredUnsafeCacheEntries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> cacheEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 取出上下文信息, 也就是打包对象的绝对路径</span>
	<span class="token keyword">const</span> context <span class="token operator">=</span> data<span class="token punctuation">.</span>context <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>
  <span class="token comment">// 这里没有resolveOptions, 因此是一个空对象(应该是做兼容处理, 防止后续逻辑使用时报错)</span>
	<span class="token keyword">const</span> resolveOptions <span class="token operator">=</span> data<span class="token punctuation">.</span>resolveOptions <span class="token operator">||</span> <span class="token constant">EMPTY_RESOLVE_OPTIONS</span><span class="token punctuation">;</span>
  <span class="token comment">// 将入口模块依赖取出来</span>
	<span class="token keyword">const</span> dependency <span class="token operator">=</span> dependencies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 去除入口模块依赖中的request, 这是入口文件的相对路径</span>
	<span class="token keyword">const</span> request <span class="token operator">=</span> dependency<span class="token punctuation">.</span>request<span class="token punctuation">;</span>
  <span class="token comment">// ? 断言 处理入口模块时是undefined</span>
	<span class="token keyword">const</span> assertions <span class="token operator">=</span> dependency<span class="token punctuation">.</span>assertions<span class="token punctuation">;</span>
  <span class="token comment">// 入参的时候做了补充, 但实际上每一个成员都不存在(不是空字符串就是null、undefined), 是如下格式 {issuer: '', issuerLayer: null, compiler: undefined}</span>
	<span class="token keyword">const</span> contextInfo <span class="token operator">=</span> data<span class="token punctuation">.</span>contextInfo<span class="token punctuation">;</span>
  <span class="token comment">// 创建三个 lazySet数据结构, 应该是用于存储一些依赖, 从名字看是文件依赖, 缺失依赖和上下文依赖</span>
	<span class="token keyword">const</span> fileDependencies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> missingDependencies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> contextDependencies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 依赖类型, 这里是查看入口文件是一个什么类型的模块化标准, 这里是es module, 因此是 esm</span>
	<span class="token keyword">const</span> dependencyType <span class="token operator">=</span>
		<span class="token punctuation">(</span>dependencies<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> dependencies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>category<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
	<span class="token comment">/** @type {ResolveData} */</span>
  <span class="token comment">// 将处理完的数据, 使用 resolveData 存放在一个对象中</span>
	<span class="token keyword">const</span> resolveData <span class="token operator">=</span> <span class="token punctuation">{</span>
		contextInfo<span class="token punctuation">,</span>
		resolveOptions<span class="token punctuation">,</span>
		context<span class="token punctuation">,</span>
		request<span class="token punctuation">,</span>
		assertions<span class="token punctuation">,</span>
		dependencies<span class="token punctuation">,</span>
		dependencyType<span class="token punctuation">,</span>
		fileDependencies<span class="token punctuation">,</span>
		missingDependencies<span class="token punctuation">,</span>
		contextDependencies<span class="token punctuation">,</span>
		createData<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		cacheable<span class="token operator">:</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 这里将触发 beforeResolve钩子</span>
  <span class="token comment">// 其实是少分析一次loader对文件的编译操作, 而这个 beforeResolve 其实就会触发一个 factory 钩子监听, 这个部分实际上是用于处理 loader</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeResolve<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>resolveData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 也就是触发下面 ExternalModuleFactoryPlugin 中的apply内监听的钩子</span>
  <span class="token comment">// 当然, 还有一个地方 同时也是最主要处理 入口模块的地方, 就是在NormalModuleFactory类的构造函数中</span>
  <span class="token comment">// 最终从 createModule 这个钩子的回调函数中, 触发 factorize钩子的回调函数, 回到此处继续执行</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>factorize<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>resolveData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">// 这里将组合createModule 和 三种依赖, 放到一个对象中</span>
		<span class="token keyword">const</span> factoryResult <span class="token operator">=</span> <span class="token punctuation">{</span>
				module<span class="token punctuation">,</span>
				fileDependencies<span class="token punctuation">,</span>
				missingDependencies<span class="token punctuation">,</span>
				contextDependencies
			<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
    <span class="token comment">// 直接走这里, 继续传入下面的factoryResult, 就是上面组合了 createModule和三种依赖的对象</span>
    <span class="token comment">// 而这个callback, 就是factory.create执行时传入的回调函数</span>
		<span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> factoryResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ExternalModuleFactoryPlugin</span> <span class="token punctuation">{</span>
	<span class="token comment">/**
	 * @param {string | undefined} type default external type
	 * @param {Externals} externals externals config
	 */</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> externals</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>externals <span class="token operator">=</span> externals<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * @param {NormalModuleFactory} normalModuleFactory the normal module factory
	 * @returns {void}
	 */</span>
	<span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">normalModuleFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> globalType <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">;</span>
		normalModuleFactory<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>factorize<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>
			<span class="token string">&quot;ExternalModuleFactoryPlugin&quot;</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 直接从this.hooks.factorize.callAsync 到这里</span>
        <span class="token comment">// 就是将上述的变量取出来</span>
				<span class="token keyword">const</span> context <span class="token operator">=</span> data<span class="token punctuation">.</span>context<span class="token punctuation">;</span>
				<span class="token keyword">const</span> contextInfo <span class="token operator">=</span> data<span class="token punctuation">.</span>contextInfo<span class="token punctuation">;</span>
				<span class="token keyword">const</span> dependency <span class="token operator">=</span> data<span class="token punctuation">.</span>dependencies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> dependencyType <span class="token operator">=</span> data<span class="token punctuation">.</span>dependencyType<span class="token punctuation">;</span>

				<span class="token comment">/**
				 * @param {Externals} externals externals config
				 * @param {function(Error=, ExternalModule=): void} callback callback
				 * @returns {void}
				 */</span>
				<span class="token keyword">const</span> <span class="token function-variable function">handleExternals</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">externals<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// externals是一个正则, 因此其他的判断都没有必要了, 直接走这里</span>
          <span class="token operator">...</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>externals<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>dependency<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里也不会进去</span>
						<span class="token keyword">return</span> <span class="token function">handleExternal</span><span class="token punctuation">(</span>dependency<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
          <span class="token operator">...</span>
          <span class="token comment">// 将直接走到此处</span>
          <span class="token comment">// 也就是执行传入的回调, 上面执行监听的位置</span>
          <span class="token comment">// 但是这个callback并不会执行上述的回调函数</span>
					<span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>

				<span class="token function">handleExternals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>externals<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br></div></div><h3 id="factorize监听2-入口模块的factorize真正的执行点-normalmodulefactory-构造器"><a href="#factorize监听2-入口模块的factorize真正的执行点-normalmodulefactory-构造器" class="header-anchor">#</a> factorize监听2(入口模块的factorize真正的执行点， NormalModuleFactory 构造器)</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>factorize<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>
			<span class="token punctuation">{</span>
				name<span class="token operator">:</span> <span class="token string">&quot;NormalModuleFactory&quot;</span><span class="token punctuation">,</span>
				stage<span class="token operator">:</span> <span class="token number">100</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token parameter">resolveData<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>resolveData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>
          <span class="token comment">// 此时的result是undefined, 并且loader的过程已经结束了</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterResolve<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>resolveData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>
            <span class="token comment">// 这里不会触发任何的监听, 目前还没有normalModuleFactory建听过afterResolve, 直接进入回调函数中执行</span>

            <span class="token comment">// 这个 将resolveData.createData使用变量暂时存储起来</span>
            <span class="token comment">// 这是创建入口文件所需要的所有的data</span>
            <span class="token comment">// 这个createData的形成, 也是在上面的continueCallback中形成的</span>
						<span class="token keyword">const</span> createData <span class="token operator">=</span> resolveData<span class="token punctuation">.</span>createData<span class="token punctuation">;</span>

            <span class="token comment">// 触发createModule时, 也没有任何监听的函数, 因此会直接进入回调中(其实这种都是在给plugin留位置)</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>createModule<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>
							createData<span class="token punctuation">,</span>
							resolveData<span class="token punctuation">,</span>
							<span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> createdModule</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
								<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>createdModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
									<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolveData<span class="token punctuation">.</span>request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
										<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Empty dependency (no request)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
									<span class="token punctuation">}</span>

                  <span class="token comment">// 终于到了最关键的时候, 这里 将会创建一个 NormalModule</span>
                  <span class="token comment">// 这个NormalModule继承自 Module</span>
                  <span class="token comment">// 最终生成一个 NormalModule实例</span>
									createdModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NormalModule</span><span class="token punctuation">(</span>createData<span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token punctuation">}</span>
                
                <span class="token comment">// 到这里, 就会将createModule带入 module 这个钩子中</span>
                <span class="token comment">// 首先触发的是处理sideEffects的plugin, 由于没有配置sideEffects 会直接返回 module</span>
                <span class="token comment">// 其次还是sideEffects的插件, 同样直接返回</span>
                <span class="token comment">// 本质上如果不配置sideEffects, 这里不会产生任何变化</span>
								createdModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">module</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
									createdModule<span class="token punctuation">,</span>
									createData<span class="token punctuation">,</span>
									resolveData
								<span class="token punctuation">)</span><span class="token punctuation">;</span>

								<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> createdModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h3 id="resolve监听-normalmodulefactory-构造器"><a href="#resolve监听-normalmodulefactory-构造器" class="header-anchor">#</a> resolve监听 (NormalModuleFactory 构造器)</h3> <p>这个 resolve 主要是处理loader</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>
			<span class="token punctuation">{</span>
				name<span class="token operator">:</span> <span class="token string">&quot;NormalModuleFactory&quot;</span><span class="token punctuation">,</span>
				stage<span class="token operator">:</span> <span class="token number">100</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 全部解构出来, 和前面保持统一</span>
				<span class="token keyword">const</span> <span class="token punctuation">{</span>
					contextInfo<span class="token punctuation">,</span>
					context<span class="token punctuation">,</span>
					dependencies<span class="token punctuation">,</span>
					dependencyType<span class="token punctuation">,</span>
					request<span class="token punctuation">,</span>
					assertions<span class="token punctuation">,</span>
					resolveOptions<span class="token punctuation">,</span>
					fileDependencies<span class="token punctuation">,</span>
					missingDependencies<span class="token punctuation">,</span>
					contextDependencies
				<span class="token punctuation">}</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token comment">// 处理loader用的东西</span>
				<span class="token keyword">const</span> loaderResolver <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getResolver</span><span class="token punctuation">(</span><span class="token string">&quot;loader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">/** @type {ResourceData | undefined} */</span>
				<span class="token keyword">let</span> matchResourceData <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
				<span class="token comment">/** @type {string} */</span>
				<span class="token keyword">let</span> unresolvedResource<span class="token punctuation">;</span>
				<span class="token comment">/** @type {{loader: string, options: string|undefined}[]} */</span>
				<span class="token keyword">let</span> elements<span class="token punctuation">;</span>

        <span class="token comment">// 下面三个变量代表三种loader</span>
        <span class="token comment">// 在使用的时候可以添加特殊符号, 让他们具备特殊的功能</span>
				<span class="token keyword">let</span> noPreAutoLoaders <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token keyword">let</span> noAutoLoaders <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token keyword">let</span> noPrePostAutoLoaders <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment">// contextScheme 是 undefined</span>
				<span class="token keyword">const</span> contextScheme <span class="token operator">=</span> <span class="token function">getScheme</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">/** @type {string | undefined} */</span>
        <span class="token comment">// scheme 也是 undefined</span>
				<span class="token keyword">let</span> scheme <span class="token operator">=</span> <span class="token function">getScheme</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scheme<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 进来</span>
					<span class="token comment">/** @type {string} */</span>
					<span class="token keyword">let</span> requestWithoutMatchResource <span class="token operator">=</span> request<span class="token punctuation">;</span>
					<span class="token keyword">const</span> matchResourceMatch <span class="token operator">=</span> <span class="token constant">MATCH_RESOURCE_REGEX</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>matchResourceMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 不会进来</span>
						<span class="token operator">...</span>
					<span class="token punctuation">}</span>

					scheme <span class="token operator">=</span> <span class="token function">getScheme</span><span class="token punctuation">(</span>requestWithoutMatchResource<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scheme <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>contextScheme<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里还是处理loader</span>
						<span class="token keyword">const</span> firstChar <span class="token operator">=</span> requestWithoutMatchResource<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">const</span> secondChar <span class="token operator">=</span> requestWithoutMatchResource<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						noPreAutoLoaders <span class="token operator">=</span> firstChar <span class="token operator">===</span> <span class="token number">45</span> <span class="token operator">&amp;&amp;</span> secondChar <span class="token operator">===</span> <span class="token number">33</span><span class="token punctuation">;</span> <span class="token comment">// startsWith &quot;-!&quot;</span>
						noAutoLoaders <span class="token operator">=</span> noPreAutoLoaders <span class="token operator">||</span> firstChar <span class="token operator">===</span> <span class="token number">33</span><span class="token punctuation">;</span> <span class="token comment">// startsWith &quot;!&quot;</span>
						noPrePostAutoLoaders <span class="token operator">=</span> firstChar <span class="token operator">===</span> <span class="token number">33</span> <span class="token operator">&amp;&amp;</span> secondChar <span class="token operator">===</span> <span class="token number">33</span><span class="token punctuation">;</span> <span class="token comment">// startsWith &quot;!!&quot;;</span>
            <span class="token comment">// 上面都是false</span>
            <span class="token comment">// 这是一个数组, 里面是入口模块的id  如: ['./src/index.js']</span>
						<span class="token keyword">const</span> rawElements <span class="token operator">=</span> requestWithoutMatchResource
							<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>
								noPreAutoLoaders <span class="token operator">||</span> noPrePostAutoLoaders
									<span class="token operator">?</span> <span class="token number">2</span>
									<span class="token operator">:</span> noAutoLoaders
									<span class="token operator">?</span> <span class="token number">1</span>
									<span class="token operator">:</span> <span class="token number">0</span>
							<span class="token punctuation">)</span>
							<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">!+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// unresolvedResource 将上面的入口文件id取出来, 表示是一个没有处理过的源文件</span>
						unresolvedResource <span class="token operator">=</span> rawElements<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// elements 是一个空数组</span>
						elements <span class="token operator">=</span> rawElements<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>identToLoaderRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// scheme 还是 undefined</span>
						scheme <span class="token operator">=</span> <span class="token function">getScheme</span><span class="token punctuation">(</span>unresolvedResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						unresolvedResource <span class="token operator">=</span> requestWithoutMatchResource<span class="token punctuation">;</span>
						elements <span class="token operator">=</span> <span class="token constant">EMPTY_ELEMENTS</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					unresolvedResource <span class="token operator">=</span> request<span class="token punctuation">;</span>
					elements <span class="token operator">=</span> <span class="token constant">EMPTY_ELEMENTS</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

        <span class="token comment">// loader需要用到的上下文信息, 上面说过, 这三个都是三个空的lazySet数据结构</span>
				<span class="token keyword">const</span> resolveContext <span class="token operator">=</span> <span class="token punctuation">{</span>
					fileDependencies<span class="token punctuation">,</span>
					missingDependencies<span class="token punctuation">,</span>
					contextDependencies
				<span class="token punctuation">}</span><span class="token punctuation">;</span>

				<span class="token comment">/** @type {ResourceDataWithData} */</span>
				<span class="token keyword">let</span> resourceData<span class="token punctuation">;</span>

				<span class="token keyword">let</span> loaders<span class="token punctuation">;</span>

				<span class="token keyword">const</span> continueCallback <span class="token operator">=</span> <span class="token function">needCalls</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 其实最主要的就在这里, 通过这个continueCallback触发 callback回调</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token comment">// translate option idents</span>
					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> loaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>options <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								<span class="token keyword">const</span> ident <span class="token operator">=</span> item<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token keyword">if</span> <span class="token punctuation">(</span>ident <span class="token operator">===</span> <span class="token string">&quot;[[missing ident]]&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
									<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
										<span class="token string">&quot;No ident is provided by referenced loader. &quot;</span> <span class="token operator">+</span>
											<span class="token string">&quot;When using a function for Rule.use in config you need to &quot;</span> <span class="token operator">+</span>
											<span class="token string">&quot;provide an 'ident' property for referenced loader options.&quot;</span>
									<span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token punctuation">}</span>
								item<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ruleSet<span class="token punctuation">.</span>references<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>options <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
									<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
										<span class="token string">&quot;Invalid ident is provided by referenced loader&quot;</span>
									<span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token punctuation">}</span>
								item<span class="token punctuation">.</span>ident <span class="token operator">=</span> ident<span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resourceData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">// ignored</span>
						<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> dependencies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">createIgnoredModule</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">const</span> userRequest <span class="token operator">=</span>
						<span class="token punctuation">(</span>matchResourceData <span class="token operator">!==</span> <span class="token keyword">undefined</span>
							<span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>matchResourceData<span class="token punctuation">.</span>resource<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!=!</span><span class="token template-punctuation string">`</span></span>
							<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span>
						<span class="token function">stringifyLoadersAndResource</span><span class="token punctuation">(</span>loaders<span class="token punctuation">,</span> resourceData<span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">const</span> resourceDataForRules <span class="token operator">=</span> matchResourceData <span class="token operator">||</span> resourceData<span class="token punctuation">;</span>
					<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ruleSet<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
						resource<span class="token operator">:</span> resourceDataForRules<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
						realResource<span class="token operator">:</span> resourceData<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
						resourceQuery<span class="token operator">:</span> resourceDataForRules<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
						resourceFragment<span class="token operator">:</span> resourceDataForRules<span class="token punctuation">.</span>fragment<span class="token punctuation">,</span>
						scheme<span class="token punctuation">,</span>
						assertions<span class="token punctuation">,</span>
						mimetype<span class="token operator">:</span> matchResourceData <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> resourceData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mimetype <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
						dependency<span class="token operator">:</span> dependencyType<span class="token punctuation">,</span>
						descriptionData<span class="token operator">:</span> matchResourceData
							<span class="token operator">?</span> <span class="token keyword">undefined</span>
							<span class="token operator">:</span> resourceData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>descriptionFileData<span class="token punctuation">,</span>
						issuer<span class="token operator">:</span> contextInfo<span class="token punctuation">.</span>issuer<span class="token punctuation">,</span>
						compiler<span class="token operator">:</span> contextInfo<span class="token punctuation">.</span>compiler<span class="token punctuation">,</span>
						issuerLayer<span class="token operator">:</span> contextInfo<span class="token punctuation">.</span>issuerLayer <span class="token operator">||</span> <span class="token string">&quot;&quot;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
					<span class="token keyword">const</span> useLoadersPost <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
					<span class="token keyword">const</span> useLoaders <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
					<span class="token keyword">const</span> useLoadersPre <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
					<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> r <span class="token keyword">of</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;use&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>noAutoLoaders <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>noPrePostAutoLoaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
								useLoaders<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;use-post&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>noPrePostAutoLoaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
								useLoadersPost<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;use-pre&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>noPreAutoLoaders <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>noPrePostAutoLoaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
								useLoadersPre<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
							<span class="token keyword">typeof</span> r<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span>
							r<span class="token punctuation">.</span>value <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
							<span class="token keyword">typeof</span> settings<span class="token punctuation">[</span>r<span class="token punctuation">.</span>type<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span>
							settings<span class="token punctuation">[</span>r<span class="token punctuation">.</span>type<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">null</span>
						<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							settings<span class="token punctuation">[</span>r<span class="token punctuation">.</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cachedCleverMerge</span><span class="token punctuation">(</span>settings<span class="token punctuation">[</span>r<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
							settings<span class="token punctuation">[</span>r<span class="token punctuation">.</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">let</span> postLoaders<span class="token punctuation">,</span> normalLoaders<span class="token punctuation">,</span> preLoaders<span class="token punctuation">;</span>

					<span class="token keyword">const</span> continueCallback <span class="token operator">=</span> <span class="token function">needCalls</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						<span class="token operator">...</span>
            <span class="token comment">// 主要就是走到这里面, 执行callback, 这个callback, 实际上就是moduleFactory.hooks.resolve</span>
						<span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveRequestArray</span><span class="token punctuation">(</span>
						contextInfo<span class="token punctuation">,</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span>
						useLoadersPost<span class="token punctuation">,</span>
						loaderResolver<span class="token punctuation">,</span>
						resolveContext<span class="token punctuation">,</span>
						<span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
							postLoaders <span class="token operator">=</span> result<span class="token punctuation">;</span>
							<span class="token function">continueCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveRequestArray</span><span class="token punctuation">(</span>
						contextInfo<span class="token punctuation">,</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span>
						useLoaders<span class="token punctuation">,</span>
						loaderResolver<span class="token punctuation">,</span>
						resolveContext<span class="token punctuation">,</span>
						<span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
							normalLoaders <span class="token operator">=</span> result<span class="token punctuation">;</span>
							<span class="token function">continueCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveRequestArray</span><span class="token punctuation">(</span>
						contextInfo<span class="token punctuation">,</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span>
						useLoadersPre<span class="token punctuation">,</span>
						loaderResolver<span class="token punctuation">,</span>
						resolveContext<span class="token punctuation">,</span>
						<span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
							preLoaders <span class="token operator">=</span> result<span class="token punctuation">;</span>
              <span class="token comment">// 从这里进入内层的 continueCallback</span>
							<span class="token function">continueCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveRequestArray</span><span class="token punctuation">(</span>
					contextInfo<span class="token punctuation">,</span>
					contextScheme <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">:</span> context<span class="token punctuation">,</span>
					elements<span class="token punctuation">,</span>
					loaderResolver<span class="token punctuation">,</span>
					resolveContext<span class="token punctuation">,</span>
					<span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">continueCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
						loaders <span class="token operator">=</span> result<span class="token punctuation">;</span>
						<span class="token function">continueCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">const</span> <span class="token function-variable function">defaultResolve</span> <span class="token operator">=</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>
          <span class="token comment">// 有一个正则进不去</span>
					<span class="token comment">// resource without scheme and with path</span>
          <span class="token comment">// 生成了一个loader的处理器, 包含文件系统, 钩子和配置项</span>
					<span class="token keyword">const</span> normalResolver <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getResolver</span><span class="token punctuation">(</span>
						<span class="token string">&quot;normal&quot;</span><span class="token punctuation">,</span>
						dependencyType
							<span class="token operator">?</span> <span class="token function">cachedSetProperty</span><span class="token punctuation">(</span>
									resolveOptions <span class="token operator">||</span> <span class="token constant">EMPTY_RESOLVE_OPTIONS</span><span class="token punctuation">,</span>
									<span class="token string">&quot;dependencyType&quot;</span><span class="token punctuation">,</span>
									dependencyType
							  <span class="token punctuation">)</span>
							<span class="token operator">:</span> resolveOptions
					<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// loader处理文件的主要逻辑, 这里就先不看</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveResource</span><span class="token punctuation">(</span>
						contextInfo<span class="token punctuation">,</span>
						context<span class="token punctuation">,</span>
						unresolvedResource<span class="token punctuation">,</span>
						normalResolver<span class="token punctuation">,</span>
						resolveContext<span class="token punctuation">,</span>
						<span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> resolvedResource<span class="token punctuation">,</span> resolvedResourceResolveData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">continueCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedResource <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								resourceData <span class="token operator">=</span> <span class="token punctuation">{</span>
									resource<span class="token operator">:</span> resolvedResource<span class="token punctuation">,</span>
									data<span class="token operator">:</span> resolvedResourceResolveData<span class="token punctuation">,</span>
									<span class="token operator">...</span><span class="token function">cacheParseResource</span><span class="token punctuation">(</span>resolvedResource<span class="token punctuation">)</span>
								<span class="token punctuation">}</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
              <span class="token comment">// 最终从这里进入 continueCallback</span>
							<span class="token function">continueCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token operator">...</span>
        <span class="token comment">// 上面有两个判断, 不会进去, 直接走这个默认的resolve, 表示开始处理loader</span>
				<span class="token function">defaultResolve</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br></div></div><h3 id="handleresult"><a href="#handleresult" class="header-anchor">#</a> _handleResult</h3> <p>触发_handleResult就进入了这里</p> <blockquote><p>注: 是factorize的 _handleResult</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">_handleResult</span><span class="token punctuation">(</span><span class="token parameter">entry<span class="token punctuation">,</span> err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// entry是入口模块的所有初始信息(loader处理前的)</span>
  <span class="token comment">// result是结果, 其实就是 createModule, 一路传回来了</span>
  <span class="token comment">// 这里触发result钩子</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>result<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>item<span class="token punctuation">,</span> err<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token parameter">hookError</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// result钩子没有监听函数需要触发, 直接进回调</span>
		<span class="token keyword">const</span> error <span class="token operator">=</span> hookError
			<span class="token operator">?</span> <span class="token function">makeWebpackError</span><span class="token punctuation">(</span>hookError<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">AsyncQueue(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">).hooks.result</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
			<span class="token operator">:</span> err<span class="token punctuation">;</span>

    <span class="token comment">// 这个callback是有值的, 就是 compilation.factorizeModule的回调函数</span>
		<span class="token keyword">const</span> callback <span class="token operator">=</span> entry<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
    <span class="token comment">// 这个是undefined</span>
		<span class="token keyword">const</span> callbacks <span class="token operator">=</span> entry<span class="token punctuation">.</span>callbacks<span class="token punctuation">;</span>
    <span class="token comment">// 状态设置为2, 表示完成</span>
		entry<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">DONE_STATE</span><span class="token punctuation">;</span>
    <span class="token comment">// 将entry上的callback设置为undefined</span>
		entry<span class="token punctuation">.</span>callback <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
		entry<span class="token punctuation">.</span>callbacks <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 createModule挂载到entry</span>
		entry<span class="token punctuation">.</span>result <span class="token operator">=</span> result<span class="token punctuation">;</span>
    <span class="token comment">// error挂上来</span>
		entry<span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>

    <span class="token comment">// 这个root是 processDependencies</span>
		<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_root<span class="token punctuation">;</span>
    <span class="token comment">// 此时到这里原本是1(就只有最外层那一次, 第一次走到这里的时候)</span>
    <span class="token comment">// 这里 -- 说明模块创建已经完成了</span>
		root<span class="token punctuation">.</span>_activeTasks<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token comment">// 继续进行任务调度</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>_willEnsureProcessing <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> root<span class="token punctuation">.</span>_needProcessing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里不会进去</span>
			root<span class="token punctuation">.</span>_willEnsureProcessing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token function">setImmediate</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>_ensureProcessing<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>inHandleResult<span class="token operator">++</span> <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token function">callback</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> callback <span class="token keyword">of</span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token function">callback</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 走这里, 回到 factorizeModule 的回调函数中</span>
			<span class="token function">callback</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> callback <span class="token keyword">of</span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">callback</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		inHandleResult<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h3 id="addmodule"><a href="#addmodule" class="header-anchor">#</a> addModule</h3> <p>通过addModule开始创建模块</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">addModule</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里的module是 loader 处理后的 createModule, 也就是上面一直传下来的result</span>
  <span class="token comment">// callback定义在 factorizeModule 调用addModule时</span>
  <span class="token comment">// 接下来将再次回到add方法, 只不过这一次是 addModuleQueue</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>addModuleQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="addmodule方法"><a href="#addmodule方法" class="header-anchor">#</a> _addModule方法</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// module 是前面的 createModule</span>
<span class="token function">_addModule</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 入口文件绝对路径</span>
	<span class="token keyword">const</span> identifier <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 没有已经添加过的模块, 因此是undefined</span>
	<span class="token keyword">const</span> alreadyAddedModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>identifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span> <span class="token comment">// 不必要的逻辑</span>

  <span class="token comment">// 执行get方法</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_modulesCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>identifier<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> cacheModule</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 回到这里, 此时的 cacheModule undefined</span>
    <span class="token operator">...</span> <span class="token comment">// 过滤不必要的逻辑</span>
    <span class="token comment">// 设置模块</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>identifier<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将入口模块添加到 modules中</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ModuleGraph<span class="token punctuation">.</span><span class="token function">setModuleGraphForModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>moduleGraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行 callback, 这个callback 就是 `_processor`的回调</span>
		<span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// get方法</span>
<span class="token function">get</span><span class="token punctuation">(</span>identifier<span class="token punctuation">,</span> etag<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>_cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>identifier<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> etag<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 走这里</span>
<span class="token function">get</span><span class="token punctuation">(</span>identifier<span class="token punctuation">,</span> etag<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> gotHandlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 这个 gotHandlers 会被扩展, 扩展了一个函数</span>
  <span class="token comment">/* 
    (result, callback) =&gt; {
			if (result === undefined) {
        // 进入这里, 设置一个键名为 打包入口绝对路径, 键值为null的缓存
				cache.set(identifier, null);
			} else {
				cache.set(identifier, { etag, data: result });
			}
      // 触发回调, 就是触发了this._modulesCache.get方法的回调
			return callback();
		}
   */</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>get<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>identifier<span class="token punctuation">,</span> etag<span class="token punctuation">,</span> gotHandlers<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里触发的时候, gotHandlers 是1</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			result <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token comment">// 走这里, 执行的就是上面注释中的函数</span>
		gotHandlers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h3 id="buildmodule"><a href="#buildmodule" class="header-anchor">#</a> buildModule</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">buildModule</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>buildQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="逻辑梳理"><a href="#逻辑梳理" class="header-anchor">#</a> 逻辑梳理</h2> <ol><li>统一<code>options</code>的数据结构, 因为这里很可能传入的<code>optionsOrName</code>是一个 String, 也就是和4.x一样是一个name(也不排除是compilation这个类先更新了, 而当时的compiler还没有更新, 因此这里相当于是做一个兼容处理)</li> <li>接着开始调用 <code>_addEntryItem</code>方法</li> <li>在 <code>_addEntryItem</code>方法内部, 主要是定义了一个 <code>entryData</code>, 同时给 compilation.entries设置了一个键名为入口模块id, 键值为 entryData的 map成员</li> <li>然后触发了 <code>addEntry</code> 钩子, 这个钩子是 compilation 的钩子, 而不是compiler的钩子, 并且继续执行 <code>addModuleTree</code> 方法</li> <li>这个 <code>addModuleTree</code>方法, 根据他的名字我们知道, 它主要是要生成一个模块树, 也就是说要真正的开始生成所需要的模块了
<ul><li>5-1 <code>addModuleTree</code>方法内部主要做的事情就是拿到了前面在 EntryPlugin 中定义的 <code>normalModuleFactory</code>, 这个普通模块工厂, 就是用于生成模块的东西</li> <li>5-2 执行 <code>handleModuleCreation</code></li></ul></li> <li><code>handleModuleCreation</code></li> <li>主要执行的是<code>factorizeModule</code>方法, 在内部触发 <code>factorizeQueue</code>实例的<code>add</code>方法</li> <li>进入add方法后, 直接触发<code>beforeAdd</code>这个异步钩子, (add方法内部仅仅只有一个抛错处理, 接下来就是触发这个异步钩子)
<ul><li>8-1 <code>beforeAdd</code> 钩子触发, 传入参数item, 和回调函数callback(由onCompiled一路扩展而来)</li> <li>8-2 通过<code>setImmediate(root._ensureProcessing)</code>挂载了一个 <code>root._ensureProcessing</code></li> <li>8-3 上面的<code>root</code>指向的是调度实例 <code>processDependencies</code>, 通过上面所描述的方式, 在实例化时, 完成对<code>_root</code> 和 <code>_children</code> 的挂载, 保持后面几个实例的 <code>_root</code> 都指向了 <code>processDependencies</code>, 同时扩展 <code>_root._children</code></li> <li>最后这里会退出, added钩子没有挂载点, 也没有回调</li> <li>一直退出到最外层, 然后触发 <code>_root._ensureProcessing</code></li></ul></li> <li>在 <code>_root._startProcessing</code>中获取到了 <code>factorize</code>实例传入队列的 <code>entry</code>, 也就是入口模块信息, 然后触发<code>beforeStart</code>钩子的监听
<ul><li>9-1  执行 <code>_processor</code>方法, 也就是 <code>compilation._factorizeModule</code>方法, 在这里触发打包入口的核心方法之一的 <code>factory.create</code> 方法</li> <li>9-2 <code>create</code>方法中 触发 <code>beforeResolve</code>钩子, 进入回调函数中, 继续触发 <code>factorize</code>钩子, 挂载点有两个, 重点是在 <code>factorizeQueue</code>实例中的挂载点会触发执行</li> <li>9-3 在 <code>factorizeQueue</code>的挂载点中触发 <code>beforeResolve</code>这个钩子, 然后触发 <code>resolve</code>钩子, 实际上这里的<code>resolve</code>是loader在加载处理我们的文件流, 因此里面有几个很重要的指标就是 <code>fileSystem</code>, 文件系统</li> <li>9-4 在<code>NormalModuleFactory</code>实例中触发 <code>resolve</code>的监听</li> <li>9-5 <code>resolve</code>中的内容过于复杂, 不再细讲(我也没看), 只是这里有一个重点的东西是 <code>continueCallback</code>, 这个里面会多次执行一个方法, 对入口模块进行加载处理(根据4.x的猜测, 也许是错的)</li> <li>9-6 最终会得到一个经过loader加载完成的结果, 然后顺利进入 resolve钩子触发时的回调函数中</li></ul></li> <li><code>resolve.callAsync</code>回调触发, 接着是触发 <code>afterResolve.callAsync</code>, 触发回调函数, 将创建入口模块所需要的一些依赖等都存储到了createData当中(在<code>continueCallback</code>执行时, 在该函数内部组装的)</li> <li><code>createModule</code>钩子回调函数触发(同样没有监听的函数需要执行, 直接进入回调)</li> <li>通过<code>new NormalModule(createData)</code>创建了一个 <code>createModule</code>实例, 这是一个 <code>NormalModule</code>的实例, 后续生成正式的入口模块, 就需要通过它, 并且他会被层层传出去</li> <li><code>factorize</code>传入的<code>callback</code>触发</li> <li>通过传入的 createModule, 生成一个包含更多数据的<code>factoryResult</code>, 然后执行 <code>create</code> 方法传入的回调函数</li> <li>在上述回调函数执行时, 扩展了 <code>compilation</code> 实例上的三个依赖, 然后将 <code>createModule</code>取出来, 继续传入 <code>_factorizeModule</code>执行时候定义的回调函数中, 继续走, 也就是触发上述 <code>_processor</code> 方法执行时定义的回调函数, 注意, 此时的<code>_child</code>还是 <code>factorizeQueue</code>(后面会再次回到这里), 设置了一个状态(<code>inCallback</code>设置为了true), 然后继续执行 <code>_handleResult</code>方法</li> <li><code>_handleResult</code>方法中, 触发<code>result</code>钩子的回调函数, 将 <code>root.activeTasks</code>的数量<code>减1</code>, 但是这里要注意的是, 走进这里的时候, 因为有一个队列的控制, 在上次的 <code>factorize</code>执行后, 队列里面的任务其实就已经清除了, 这个思想很巧妙, 可以多看看。同时继续触发 callback方法(这个callback来自于entry.callback, entry是在factorize), 实际上就是回到了 <code>factorizeModule</code>的回调函数中, 然后触发 <code>addModule</code>, 进而触发 <code>this.addModuleQueue.add(module, callback);</code>, 传入了 <code>createModule</code> 和 回调函数
<ul><li>为什么说<code>entry.callbak</code>是 <code>factorizeModule</code>呢, 主要就是这个entry是在 <code>factorizeQueue</code>实例触发的, 生成的位置是在 <code>factorizeQueue.add</code>方法中, 传入了当时的 <code>item</code> 和 <code>callback</code>, 而这个 <code>callback</code>, 就是 <code>factorizeModule</code>方法</li></ul></li> <li>再一次回到<code>add</code>中, 但是这一次, 触发add的实例发生了变化, 变成了<code>addModuleQueue</code>, 触发 <code>beforeAdd</code>钩子</li> <li>进入回调函数中, 生成了一个新的entry, 这一次传入的是 <code>createModule</code>和 回调函数, 回调函数是 <code>addModule</code>出发时的回调函数</li> <li>将上述组合的<code>entry</code>, 放到了<code>addModuleQueue._entries</code>这个map数据结构中, 键名是组合生成后的 <code>入口文件绝对路径</code>, 同时将这个<code>entry</code>推入 <code>addModuleQueue._queued</code>这个队列中, 然后和之前一样, 通过 <code>setImmediate(root._ensureProcessing);</code>, 挂载 <code>root._ensureProcessing</code></li> <li>再次进入 <code>_ensureProcessing</code>中, 触发 <code>addModule._startProcessing</code>, 那个<code>child</code> 就是 <code>addModule</code></li> <li>再次进入 <code>beforeStart</code>回调函数, 执行 <code>_processor</code>方法(也就是 <code>compilation._addModule</code>)</li> <li>执行 <code>_addModule</code>, 然后执行 <code>this._modulesCache.get</code>, 触发一些缓存操作, 然后退回来执行回调</li> <li>进入回调中, 将 <code>createModule</code> 添加到 compilation._modules中, 键名是 <code>入口文件绝对路径</code></li> <li>将入口文件添加到 <code>modules</code>中, 执行回调(<code>_processor</code>的回调), 其实到这里已经完成了, <code>addModule</code>的任务, 就是将模块添加到<code>modules</code>中</li> <li>触发 <code>_handleResult</code>, 挂载一个<code>setImmediate(root._ensureProcessing);</code></li> <li>紧接着触发 <code>addModule</code>中的回调函数， 执行了两个<code>模块图</code>的操作, 具体作用后续再看(其实就是不停地在往<code>createModule</code>上扩展成员)</li> <li>接下来触发 <code>buildModule</code>正式开始创建 <code>module</code></li> <li>通过上面可以看到, 又一次回到了add方法中, 只是这一次, 是 <code>buildQueue</code> 触发</li> <li>进入 <code>beforeAdd</code>方法中, 这一次的<code>key</code>就是 <code>createModule</code>, <code>newEntry</code>的 <code>callback</code> 是 调用<code>buildModule</code> 时定义的回调函数, <code>item</code>是<code>createModule</code>, 然后将这一组放到了 <code>buildQueue._entries</code>上, 同时新的 entry 入队, 然后不一样的是, 这里不会进入setImmediate中</li> <li>接下来是<code>processDependencies</code>调度各个任务</li> <li>然后是通过<code>_handleResult</code>, 调用callback, 也就是<code>addModule</code>再次进入, <code>_ensureProcessing</code>, 但是此时, <code>addModuleQueue._queued</code>已经空了, 但是<code>buildQueue</code>中的<code>_queued</code>中已经有值了(值得注意的是, 在30步结束后, 初次调度进入时, 是触发的第一次_handleResult挂载的setImmediate, 此时的<code>buildQueue</code>中还没有挂载对应的<code>entry</code>)</li> <li>然后就会触发<code>_processor</code>, 也就是 <code>_buildModule</code>, 然后调用<code>module.needBuild</code>, 进入第一个判断, 直接进入回调函数</li> <li>执行 <code>builtModules,add</code>方法, 将module添加到 <code>builtModules</code>中, 然后执行 <code>normalModule.build</code>方法</li> <li>执行 <code>doBuild</code>方法, 执行核心编译功能, 将JS代码转换成 AST 语法树在转换成 code 代码。
<ul><li>在其中定义了一个 <code>processResult</code>方法, 用于执行回调函数</li> <li>在<code>build</code>方法中有几个重要的参数
<ul><li><code>_source</code> 代表的是源码</li> <li><code>_ast</code> 代表的是AST语法树, 就是将<code>_source</code>转换成语法树最后就存储到这上面</li> <li><code>buildInfo</code>里面有一个<code>hash</code>, 就是每一次编译的<code>hash</code>值</li></ul></li> <li>执行<code>runLoaders</code>函数, 调用Loader, 内部触发 <code>iteratePitchingLoaders</code></li> <li>最终走回到doBuild的 <code>processResult</code>中, 执行 <code>createSource</code>保留我们的源码, 然后获取<code>AST</code>, 如果在extraInfo中没有webpackAST, 那么就是null</li> <li>紧接着触发<code>doBuild</code>的回调函数, 内部调用 <code>NormalModule.parser.parse</code>去得到转换后的模块</li> <li><code>parse</code>方法接收了两个参数, 一个是source, 一个是state
<ul><li>内部调用<code>JavascriptParser._parse</code>方法, 生成了AST语法树</li></ul></li> <li>最终将<code>result</code>, 传入<code>handleParseResult</code>中执行, 在其内部生成Hash值</li></ul></li> <li>结束</li> <li>综上所述: 核心其实就在<code>build</code>中, 通过<code>doBild</code>将源代码转换成<code>AST</code>, 再转换为生成的代码</li></ol></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">8/18/2022, 1:34:46 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/19.html" class="prev">
            make触发前 流程回顾
          </a></span> <!----></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#addentry-方法" class="sidebar-link reco-side-addentry-方法" data-v-70334359>addEntry 方法</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#factorizequeue-queued" class="sidebar-link reco-side-factorizequeue-queued" data-v-70334359>factorizeQueue._queued</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#asyncqueue的-root和-children逻辑" class="sidebar-link reco-side-asyncqueue的-root和-children逻辑" data-v-70334359>AsyncQueue的root和children逻辑</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#模块数据-最终合成包含了callback的数据-的state" class="sidebar-link reco-side-模块数据-最终合成包含了callback的数据-的state" data-v-70334359>模块数据(最终合成包含了callback的数据)的state</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#modulefactory-create方法" class="sidebar-link reco-side-modulefactory-create方法" data-v-70334359>moduleFactory.create方法</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#factorize监听2-入口模块的factorize真正的执行点-normalmodulefactory-构造器" class="sidebar-link reco-side-factorize监听2-入口模块的factorize真正的执行点-normalmodulefactory-构造器" data-v-70334359>factorize监听2(入口模块的factorize真正的执行点， NormalModuleFactory 构造器)</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#resolve监听-normalmodulefactory-构造器" class="sidebar-link reco-side-resolve监听-normalmodulefactory-构造器" data-v-70334359>resolve监听 (NormalModuleFactory 构造器)</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#handleresult" class="sidebar-link reco-side-handleresult" data-v-70334359>_handleResult</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#addmodule" class="sidebar-link reco-side-addmodule" data-v-70334359>addModule</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#addmodule方法" class="sidebar-link reco-side-addmodule方法" data-v-70334359>_addModule方法</a></li><li class="level-3" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#buildmodule" class="sidebar-link reco-side-buildmodule" data-v-70334359>buildModule</a></li><li class="level-2" data-v-70334359><a href="/my-front-end-learning/blogs/ModularDevelopment/webpackSource/20.html#逻辑梳理" class="sidebar-link reco-side-逻辑梳理" data-v-70334359>逻辑梳理</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/my-front-end-learning/assets/js/app.9bd16e75.js" defer></script><script src="/my-front-end-learning/assets/js/3.1cdc23f6.js" defer></script><script src="/my-front-end-learning/assets/js/1.ee48205b.js" defer></script><script src="/my-front-end-learning/assets/js/76.d71416ff.js" defer></script>
  </body>
</html>
